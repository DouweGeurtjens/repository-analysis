[{"url": "https://api.github.com/repos/zalando/patroni/issues/2654", "repository_url": "https://api.github.com/repos/zalando/patroni", "labels_url": "https://api.github.com/repos/zalando/patroni/issues/2654/labels{/name}", "comments_url": "https://api.github.com/repos/zalando/patroni/issues/2654/comments", "events_url": "https://api.github.com/repos/zalando/patroni/issues/2654/events", "html_url": "https://github.com/zalando/patroni/issues/2654", "id": 1685429050, "node_id": "I_kwDOAk8yXs5kdZs6", "number": 2654, "title": "Members refuse to update configuration with Pending Restart", "user": {"login": "pgodfrin-nov", "id": 74776809, "node_id": "MDQ6VXNlcjc0Nzc2ODA5", "avatar_url": "https://avatars.githubusercontent.com/u/74776809?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pgodfrin-nov", "html_url": "https://github.com/pgodfrin-nov", "followers_url": "https://api.github.com/users/pgodfrin-nov/followers", "following_url": "https://api.github.com/users/pgodfrin-nov/following{/other_user}", "gists_url": "https://api.github.com/users/pgodfrin-nov/gists{/gist_id}", "starred_url": "https://api.github.com/users/pgodfrin-nov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pgodfrin-nov/subscriptions", "organizations_url": "https://api.github.com/users/pgodfrin-nov/orgs", "repos_url": "https://api.github.com/users/pgodfrin-nov/repos", "events_url": "https://api.github.com/users/pgodfrin-nov/events{/privacy}", "received_events_url": "https://api.github.com/users/pgodfrin-nov/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 233785759, "node_id": "MDU6TGFiZWwyMzM3ODU3NTk=", "url": "https://api.github.com/repos/zalando/patroni/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2023-04-26T17:20:43Z", "updated_at": "2023-04-26T17:36:27Z", "closed_at": "2023-04-26T17:35:54Z", "author_association": "NONE", "active_lock_reason": null, "body": "### What happened?\n\nI cannot get the Patroni Dynamic configuration to update the environment. In addition to patronictl reload & restart. I've tried stopping and start the database and also a reboot. Nothing doing, won't update. As this is my production system this reconfiguration is needed to manage some memory errors.\n\n### How can we reproduce it (as minimally and precisely as possible)?\n\nI'm not certain how to reproduce it, but I'll paste my process here:\r\n## Standby:\r\n```\r\npostgres@prdudb01:~=> ptop\r\n+ Cluster: unidb01 (7050494637474675106) --------+-----+-----------+-----------------+\r\n| Member     | Host          | Role    | State   |  TL | Lag in MB | Pending restart |\r\n+------------+---------------+---------+---------+-----+-----------+-----------------+\r\n| prdudb02   | 172.19.71.142 | Leader  | running | 186 |           | *               |\r\n| + prdudb01 | 172.19.60.108 | Replica | running | 186 |         0 | *               |\r\n+------------+---------------+---------+---------+-----+-----------+-----------------+\r\npostgres@prdudb01:~=> pctl show-config\r\nloop_wait: 10\r\nmaximum_lag_on_failover: 1048576\r\nmaximum_lag_on_syncnode: -1\r\npostgresql:\r\n  parameters:\r\n    jit: false\r\n    max_connections: 160\r\n    max_locks_per_transaction: 64\r\n    max_prepared_transactions: 500\r\n    max_worker_processes: 2048\r\n    search_path: '\"$user\", tsdba, timeseries, max_cmpl, public'\r\n    track_commit_timestamp: 'on'\r\n    wal_keep_size: 12GB\r\n    work_mem: 32MB\r\nretry_timeout: 10\r\nsynchronous_mode: false\r\nttl: 30\r\nuse_pg_rewind: true\r\nuse_slots: true\r\n```\r\nps -ef:\r\n_note the running max_connections_\r\n```\r\npostgres  302951       1  0 05:19 ?        00:00:48 /usr/bin/python3 /usr/bin/patroni /postgres/admin/patroni/prdudb01-patroni.yaml\r\npostgres  355569  355558  0 06:35 pts/0    00:00:00 -bash\r\npostgres  462852       1  0 09:14 ?        00:00:05 /usr/lib/postgresql/13/bin/postgres -D /postgres/udb01/data --config-file=/postgres/udb01/data/postgresql.conf --listen_addresses=0.0.0.0 --port=5432 --cluster_name=unidb01 --wal_level=replica --hot_standby=on --max_connections=250 --max_wal_senders=10 --max_prepared_transactions=500 --max_locks_per_transaction=64 --track_commit_timestamp=on --max_replication_slots=10 --max_worker_processes=2048 --wal_log_hints=on\r\n\r\n```\r\n\r\n## Primary:\r\n```\r\npostgres@prdudb02:~=> ptop\r\n+ Cluster: unidb01 (7050494637474675106) --------+-----+-----------+-----------------+\r\n| Member     | Host          | Role    | State   |  TL | Lag in MB | Pending restart |\r\n+------------+---------------+---------+---------+-----+-----------+-----------------+\r\n| prdudb02   | 172.19.71.142 | Leader  | running | 186 |           | *               |\r\n| + prdudb01 | 172.19.60.108 | Replica | running | 186 |         0 | *               |\r\n+------------+---------------+---------+---------+-----+-----------+-----------------+\r\npostgres@prdudb02:~=> pctl show-config\r\nloop_wait: 10\r\nmaximum_lag_on_failover: 1048576\r\nmaximum_lag_on_syncnode: -1\r\npostgresql:\r\n  parameters:\r\n    jit: false\r\n    max_connections: 160\r\n    max_locks_per_transaction: 64\r\n    max_prepared_transactions: 500\r\n    max_worker_processes: 2048\r\n    search_path: '\"$user\", tsdba, timeseries, max_cmpl, public'\r\n    track_commit_timestamp: 'on'\r\n    wal_keep_size: 12GB\r\n    work_mem: 32MB\r\nretry_timeout: 10\r\nsynchronous_mode: false\r\nttl: 30\r\nuse_pg_rewind: true\r\nuse_slots: true\r\n```\r\nps -ef\r\n_note the running max_connections_\r\n```\r\npostgres  277275       1  0 03:43 ?        00:01:02 /usr/bin/python3 /usr/bin/patroni /postgres/admin/patroni/prdudb02-patroni.yaml\r\npostgres  277418       1  0 03:43 ?        00:00:22 /usr/lib/postgresql/13/bin/postgres -D /postgres/udb01/data --config-file=/postgres/udb01/data/postgresql.conf --listen_addresses=0.0.0.0 --port=5432 --cluster_name=unidb01 --wal_level=replica --hot_standby=on --max_connections=250 --max_wal_senders=10 --max_prepared_transactions=500 --max_locks_per_transaction=64 --track_commit_timestamp=on --max_replication_slots=10 --max_worker_processes=2048 --wal_log_hints=on\r\n```\r\n### Reload and restart on Standby:\r\n```\r\npostgres@prdudb01:~=> pctl reload unidb01 prdudb01\r\n+ Cluster: unidb01 (7050494637474675106) ------+-----+-----------+-----------------+\r\n| Member   | Host          | Role    | State   |  TL | Lag in MB | Pending restart |\r\n+----------+---------------+---------+---------+-----+-----------+-----------------+\r\n| prdudb01 | 172.19.60.108 | Replica | running | 186 |         0 | *               |\r\n| prdudb02 | 172.19.71.142 | Leader  | running | 186 |           | *               |\r\n+----------+---------------+---------+---------+-----+-----------+-----------------+\r\nAre you sure you want to reload members prdudb01? [y/N]: y\r\nReload request received for member prdudb01 and will be processed within 10 seconds\r\npostgres@prdudb01:~=> pglg\r\n          N.nspname,\r\n          relname,\r\n          pg_table_size(C.oid) as table_size, pg_indexes_size(C.oid) as index_size, pg_total_relation_size(C.oid) as total_size\r\n        FROM pg_class C\r\n        LEFT JOIN pg_namespace N ON (N.oid = C.relnamespace)\r\n        WHERE nspname NOT IN ('pg_catalog', 'information_schema') AND\r\n          nspname !~ '^pg_toast' AND\r\n          relkind = 'r' AND\r\n          ( relname ~ '[[:alnum:]]' )\r\n2023-04-26 17:07:33 UTC PRDUDB01 [p:462870 s:00000] :::LOG:  restartpoint starting: time\r\n2023-04-26 17:07:37 UTC PRDUDB01 [p:463124 s:00000] 127.0.0.1(37312):datadog-agent:SELECT:LOG:  duration: 2400.365 ms  statement: \r\n        SELECT\r\n          N.nspname,\r\n          relname,\r\n          pg_table_size(C.oid) as table_size, pg_indexes_size(C.oid) as index_size, pg_total_relation_size(C.oid) as total_size\r\n        FROM pg_class C\r\n        LEFT JOIN pg_namespace N ON (N.oid = C.relnamespace)\r\n        WHERE nspname NOT IN ('pg_catalog', 'information_schema') AND\r\n          nspname !~ '^pg_toast' AND\r\n          relkind = 'r' AND\r\n          ( relname ~ '[[:alnum:]]' )\r\n2023-04-26 17:07:39 UTC PRDUDB01 [p:462870 s:00000] :::LOG:  restartpoint complete: wrote 615 buffers (0.0%); 0 WAL file(s) added, 0 removed, 0 recycled; write=5.898 s, sync=0.062 s, total=5.980 s; sync files=28, longest=0.008 s, average=0.003 s; distance=4208 kB, estimate=5159 kB\r\n2023-04-26 17:07:39 UTC PRDUDB01 [p:462870 s:00000] :::LOG:  recovery restart point at 133D/CA6C4358\r\n2023-04-26 17:07:39 UTC PRDUDB01 [p:462870 s:00000] :::DETAIL:  Last completed transaction was at log time 2023-04-26 17:07:37.73896+00.\r\n2023-04-26 17:07:39 UTC PRDUDB01 [p:462852 s:00000] :::LOG:  received SIGHUP, reloading configuration files\r\n2023-04-26 17:07:39 UTC PRDUDB01 [p:462852 s:55P02] :::LOG:  parameter \"max_connections\" cannot be changed without restarting the server\r\n2023-04-26 17:07:39 UTC PRDUDB01 [p:462852 s:F0000] :::LOG:  configuration file \"/postgres/udb01/data/postgresql.conf\" contains errors; unaffected changes were applied\r\npostgres@prdudb01:~=> pctl restart unidb01 prdudb01\r\n+ Cluster: unidb01 (7050494637474675106) ------+-----+-----------+-----------------+\r\n| Member   | Host          | Role    | State   |  TL | Lag in MB | Pending restart |\r\n+----------+---------------+---------+---------+-----+-----------+-----------------+\r\n| prdudb01 | 172.19.60.108 | Replica | running | 186 |         0 | *               |\r\n| prdudb02 | 172.19.71.142 | Leader  | running | 186 |           | *               |\r\n+----------+---------------+---------+---------+-----+-----------+-----------------+\r\nWhen should the restart take place (e.g. 2023-04-26T13:09)  [now]: \r\nAre you sure you want to restart members prdudb01? [y/N]: y\r\nRestart if the PostgreSQL version is less than provided (e.g. 9.5.2)  []: \r\nSuccess: restart on member prdudb01\r\n\r\n```\r\n### max_connections remains unchanged\r\n```\r\npostgres  302951       1  0 05:19 ?        00:00:49 /usr/bin/python3 /usr/bin/patroni /postgres/admin/patroni/prdudb01-patroni.yaml\r\npostgres  355569  355558  0 06:35 pts/0    00:00:00 -bash\r\npostgres  472845  472831  0 09:29 pts/2    00:00:00 -bash\r\npostgres  546950  546940  0 11:18 pts/1    00:00:00 -bash\r\npostgres  582261       1 11 12:09 ?        00:00:00 /usr/lib/postgresql/13/bin/postgres -D /postgres/udb01/data --config-file=/postgres/udb01/data/postgresql.conf --listen_addresses=0.0.0.0 --port=5432 --cluster_name=unidb01 --wal_level=replica --hot_standby=on --max_connections=250 --max_wal_senders=10 --max_prepared_transactions=500 --max_locks_per_transaction=64 --track_commit_timestamp=on --max_replication_slots=10 --max_worker_processes=2048 --wal_log_hints=on\r\n```\n\n### What did you expect to happen?\n\nI'd expect the config to change. I've done this plenty of times, and frankly I don't understand why this is happening now.\n\n### Patroni/PostgreSQL/DCS version\n\n-   Patroni version: \r\n```\r\npatroni 2.1.3\r\n```\r\n-   PostgreSQL version: \r\n```\r\n[tsdb@prdudb01] # select version();\r\n                                                             version                                                              \r\n----------------------------------------------------------------------------------------------------------------------------------\r\n PostgreSQL 13.5 (Ubuntu 13.5-2.pgdg20.04+1) on x86_64-pc-linux-gnu, compiled by gcc (Ubuntu 9.3.0-17ubuntu1~20.04) 9.3.0, 64-bit\r\n```\r\n-   DCS (and its version): \r\n```\r\npostgres@prdudb01:~=> etcd --version\r\netcd Version: 3.5.2\r\nGit SHA: 99018a77b\r\nGo Version: go1.16.3\r\nGo OS/Arch: linux/amd64\r\n```\r\n\r\n\n\n### Patroni configuration file\n\n```yaml\n#\r\n# prd unidb01\r\n# prdudb01\r\n# filename:  prdudb01-patroni.yaml\r\n# more details: https://patroni.readthedocs.io/en/latest/SETTINGS.html#settings\r\n#\r\n# SCOPE     is the name of the ETCD cluster\r\n# NAME      is the host (server) name\r\n# NAMESPACE is the root location in the DCS\r\n# \r\n# github: https://github.com/zalando/patroni\r\n# docs:   https://patroni.readthedocs.io/en/latest/index.html\r\n#\r\n################################################################################\r\n# Maintenance:\r\n#   03-31-22    peg\r\n#   cleaning up comments and other garbage. Original code is found in\r\n#   /etc/patroni/config.yml.in\r\n#   05-12-22  peg\r\n#   adapting to prod version\r\n#   01-09-22  peg\r\n#   Increasing instance class to m6i.4xlarge\r\n#   upping some memory parms\r\n################################################################################\r\n\r\nscope: unidb01\r\nnamespace: /unidb01\r\nname: prdudb01\r\n\r\nlog:\r\n  level: WARNING\r\n  #level: DEBUG\r\n  dir: /postgres/admin/logs\r\n  format: '%(asctime)s %(processName)s %(levelname)s: %(message)s'\r\n#  loggers: \r\n#    patroni.postmaster: NOTICE\r\n\r\nrestapi:\r\n  listen: 172.19.60.108:8008\r\n  connect_address: 172.19.60.108:8008\r\n\r\n# etcd v3\r\netcd3:\r\n  hosts:\r\n  - 172.19.60.108:2379\r\n  - 172.19.71.142:2379\r\n  - 172.19.58.37:2379\r\n  - 172.19.68.25:2379\r\n\r\nbootstrap:\r\n  # this section will be written into Etcd:/<namespace>/<scope>/config after initializing new cluster\r\n  # and all other cluster members will use it as a `global configuration`\r\n  dcs:\r\n    #initialize: true\r\n    ttl: 30\r\n    loop_wait: 10\r\n    retry_timeout: 10\r\n    maximum_lag_on_failover: 1048576\r\n#    master_start_timeout: 300\r\n#    master_stop_timeout:\r\n\r\n#   03-31-22    peg\r\n#   DISALLOW INITDB ON BOOTSTRAP\r\n  method:\r\n  postgresql:\r\n      use_pg_rewind: true\r\n      parameters:\r\n        checkpoint_timeout: '30s'\r\n        checkpoint_completion_target: '0.2'\r\n        cluster_name: 'unidb01'\r\n        datestyle: 'iso, mdy'\r\n        default_text_search_config: 'pg_catalog.english'\r\n        dynamic_shared_memory_type: posix  \r\n        jit: off\r\n        work_mem: 32MB\r\n        max_connections: 200\r\n        max_worker_processes: 1024\r\n        lc_messages: 'C.UTF-8'                 \r\n        lc_monetary: 'C.UTF-8'                 \r\n        lc_numeric: 'C.UTF-8'                  \r\n        lc_time: 'C.UTF-8'                      \r\n        listen_addresses: '*'            \r\n        log_destination: 'stderr'           \r\n        log_directory: '/postgres/admin/logs'\r\n        log_timezone: 'Etc/UTC'\r\n        port: 5432\r\n        timezone: 'Etc/UTC'\r\n        superuser_reserved_connections: 10\r\n        wal_keep_size: 2GB\r\n\r\npostgresql:\r\n  listen: 0.0.0.0:5432\r\n  connect_address: 172.19.60.108:5432\r\n  data_dir: /postgres/udb01/data\r\n  bin_dir: /usr/lib/postgresql/13/bin\r\n#  config_dir:\r\n  pgpass: /home/postgres/.pgpass\r\n  authentication:\r\n    replication:\r\n      username: replication\r\n    superuser:\r\n      username: postgres\r\n    rewind:  # Has no effect on postgres 10 and lower\r\n      username: postgres\r\n  use_pg_rewind: true\r\n  parameters:\r\n    archive_command: 'pgbackrest --stanza=unidb01 archive-push %p'\r\n    archive_mode: 'on'\r\n    archive_timeout: '900s'\r\n#   PEG 01-09-23    instance type upgrade\r\n    autovacuum_work_mem: 32MB\r\n    bgwriter_lru_maxpages: 1024\r\n    bgwriter_flush_after: 0\r\n    checkpoint_flush_after: 0\r\n    checkpoint_timeout: '30s'\r\n    checkpoint_completion_target: '0.2'\r\n    cluster_name: 'unidb01'\r\n    commit_delay: 100000\r\n    commit_siblings: 5\r\n    datestyle: 'iso, mdy'\r\n    default_statistics_target: 5000\r\n    default_text_search_config: 'pg_catalog.english'\r\n    dynamic_shared_memory_type: posix  \r\n    effective_cache_size: '44GB'\r\n    effective_io_concurrency:  100\r\n    full_page_writes: 'on'    \r\n    fsync: 'on'\r\n    enable_partitionwise_aggregate: on\r\n    hot_standby_feedback: on\r\n    huge_pages: 'on'\r\n    # not applicable due to pgbouncer peg 8-18-21\r\n    #idle_in_transaction_session_timeout: '15s'\r\n    #DYN jit: off\r\n    lc_messages: 'C.UTF-8'                 \r\n    lc_monetary: 'C.UTF-8'                 \r\n    lc_numeric: 'C.UTF-8'                  \r\n    lc_time: 'C.UTF-8'                      \r\n    listen_addresses: '*'            \r\n    lock_timeout: '15s'\r\n###########################################################################\r\n#   LOG SETTINGS\r\n#   Valid values arei:\r\n#   DEBUG5, DEBUG4, DEBUG3, DEBUG2, DEBUG1, \r\n#     INFO, NOTICE, WARNING, ERROR, LOG, \r\n#       FATAL,PANIC \r\n#   Each level includes all the levels that follow it.\r\n############################################################################ \r\n# minimal logging\r\n#    log_min_messages: log\r\n#    log_error_verbosity: default\r\n#    log_min_error_statement: log\r\n#    log_min_messages: log\r\n############################################################################\r\n# normal logging\r\n    log_min_messages: INFO\r\n    log_min_error_statement: INFO\r\n    log_error_verbosity: default\r\n    log_min_duration_statement: 1000ms\r\n############################################################################\r\n# debug logging\r\n#    log_min_messages: DEBUG1\r\n#######DATADOG################################################################\r\n# keep log_statement commented out\r\n#    log_statement: ddl\r\n#   keep log duration commented out\r\n#    log_duration: 'off'\r\n############################################################################\r\n    log_destination: 'stderr'           \r\n    log_directory: '/postgres/admin/logs'\r\n    log_file_mode: 0740                   \r\n    log_filename: 'alert_prdudb01.log'        # log file name pattern,\r\n#    log_line_prefix: '%m PRDUDB01 [p:%p s:%e] '\r\n    log_line_prefix: '%t PRDUDB01 [p:%p s:%e] %r:%a:%i:'\r\n    log_rotation_age: '43200'\r\n    log_timezone: 'Etc/UTC'\r\n    log_truncate_on_rotation: 'on'\r\n    logging_collector: on\r\n#   PEG 01-09-23    instance type upgrade\r\n    maintenance_work_mem: 24MB          \r\n    max_connections: 150\r\n    max_parallel_workers: 1024\r\n    max_parallel_workers_per_gather: 8\r\n    #DYN max_worker_processes: 512\r\n    max_wal_size: 8GB\r\n    min_wal_size: 2GB\r\n    port: 5432\r\n    restore_command: 'pgbackrest --stanza=unidb01 archive-get %f \"%p\"'\r\n#   PEG 01-09-23    instance type upgrade\r\n#    shared_buffers: 20GB                  \r\n    #DYN: search_path: '\"$user\", tsdba, timeseries, max_cmpl, public'\r\n    shared_buffers: 46GB                  \r\n    shared_preload_libraries: 'pg_freespacemap,pg_visibility,pg_buffercache,pg_stat_statements,auto_explain,timescaledb'\r\n    ssl: 'off'\r\n    synchronous_commit: 'off'\r\n    synchronous_standby_names: 'first 1 (\"prdudb01\",\"prdudb02\")'\r\n    temp_buffers: 16MB                     \r\n    temp_tablespaces: 'temp01'\r\n    timezone: 'Etc/UTC'\r\n    track_commit_timestamp: 'on'\r\n    unix_socket_directories: '/var/run/postgresql'\r\n#   PEG 01-09-23    instance type upgrade\r\n#    wal_buffers: 512MB\r\n    wal_buffers: 512MB \r\n    wal_compression: on\r\n    #DYN wal_keep_size: 0\r\n    wal_init_zero: 'off'\r\n    wal_level: replica\r\n    wal_log_hints: \"on\"\r\n    wal_receiver_status_interval: '0'\r\n    wal_writer_delay: 3s\r\n    wal_writer_flush_after : 1024MB\r\n    #DYN work_mem: 32MB                      \r\n    superuser_reserved_connections: 10\r\n    #ssl_cert_file: 'maxshsrv.crt'\r\n    #ssl_key_file:  'maxshsrv.key'\r\n    # Timescale specific parms\r\n    timescaledb.max_background_workers:  32\r\n###########################################################################\r\n# Stats settings\r\n    pg_stat_statements.max: 100\r\n    pg_stat_statements.save: on\r\n    pg_stat_statements.track: top\r\n    pg_stat_statements.track_planning: off\r\n    pg_stat_statements.track_utility: on\r\n#   The telemetry service creates very large statements:\r\n#   Values and upsert statements are 10,000 entries\r\n#   This should keep the data in  $PGDATA/pg_stat smaller\r\n    track_activity_query_size: 1024\r\n############################################################################    \r\n  pg_hba:\r\n  # TYPE         DATABASE        USER                ADDRESS                  METHOD\r\n  - local       all             postgres,godfrinpe,datadog                  trust\r\n  - local       replication     postgres,replication                        trust\r\n#   PGBouncer bequeaths connections to postgres via port 5432 and the localhost IP\r\n  - hostnossl   all             all                     127.0.0.1/32        md5\r\n# Backend Subnet CIDR - app04p1\r\n  - hostnossl   all             all                     172.19.72.0/21      md5\r\n  - hostnossl   all             all                     172.19.56.0/21      md5\r\n  - hostnossl   all             all                     172.19.64.0/21      md5\r\n# Backend Subnet CIDR - app04p2\r\n  - hostnossl   all             all                     172.16.26.0/23      md5\r\n  - hostnossl   all             all                     172.16.28.0/23      md5\r\n  - hostnossl   all             all                     172.16.30.0/23      md5\r\n# Cross instance/node communication\r\n  - host        postgres        postgres                127.0.0.1/32       trust\r\n  - host        replication     replication             127.0.0.1/32       trust\r\n  - host        postgres        postgres,replication    172.19.71.142/32   trust\r\n  - host        all             godfrinpe               172.19.71.142/32   trust\r\n  - host        replication     postgres,replication    172.19.71.142/32   trust\r\n  # Access db via VPN\r\n  - hostnossl   all             all                     10.226.20.0/23          md5\r\n\r\n  recovery_conf:\r\n    restore_command: 'pgbackrest --stanza=unidb01 archive-get %f \"%p\"'\r\n    standby_mode: on\r\n    primary_conninfo: 'application_name=prdudb01 host=prdudb02.novcds.io user=replication port=5432'\r\n#    recovery_target_timeline: 37\r\n    primary_slot_name: prdudb01\r\n\r\n\r\nwatchdog:\r\n#TODO: check out softdog\r\n#  mode: automatic # Allowed values: off, automatic, required\r\n  mode: off # Allowed values: off, automatic, required\r\n#  prdice: /prd/watchdog\r\n#  safety_margin: 5\r\n\r\ntags:\r\n    nofailover: false\r\n    noloadbalance: false\r\n    clonefrom: false\r\n    nosync: false\n```\n\n\n### patronictl show-config\n\n```yaml\npostgres@prdudb01:/postgres/admin/patroni=> pctl show-config\r\nloop_wait: 10\r\nmaximum_lag_on_failover: 1048576\r\nmaximum_lag_on_syncnode: -1\r\npostgresql:\r\n  parameters:\r\n    jit: false\r\n    max_connections: 160\r\n    max_locks_per_transaction: 64\r\n    max_prepared_transactions: 500\r\n    max_worker_processes: 2048\r\n    search_path: '\"$user\", tsdba, timeseries, max_cmpl, public'\r\n    track_commit_timestamp: 'on'\r\n    wal_keep_size: 12GB\r\n    work_mem: 32MB\r\nretry_timeout: 10\r\nsynchronous_mode: false\r\nttl: 30\r\nuse_pg_rewind: true\r\nuse_slots: true\n```\n\n\n### Patroni log files\n\n```shell\n2023-04-26 10:13:04,452 MainProcess ERROR: get_postgresql_status\r\nTraceback (most recent call last):\r\n  File \"/usr/lib/python3/dist-packages/patroni/api.py\", line 610, in get_postgresql_status\r\n    row = self.query(stmt.format(postgresql.wal_name, postgresql.lsn_name), retry=retry)[0]\r\n          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/lib/python3/dist-packages/patroni/api.py\", line 592, in query\r\n    return self.server.query(sql, *params)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/lib/python3/dist-packages/patroni/api.py\", line 680, in query\r\n    raise e\r\n  File \"/usr/lib/python3/dist-packages/patroni/api.py\", line 676, in query\r\n    cursor.execute(sql, params)\r\npsycopg2.errors.OutOfMemory: out of memory\r\nDETAIL:  Failed on request of size 3384 in memory context \"ExecutorState\".\r\n\r\n2023-04-26 10:16:49,032 MainProcess WARNING: Postgresql is not running.\r\n2023-04-26 10:16:51,060 MainProcess WARNING: Postgresql is not running.\r\n2023-04-26 10:17:32,225 MainProcess WARNING: Postgresql is not running.\r\n2023-04-26 10:17:32,234 MainProcess ERROR: Error when reading postmaster.opts\r\nTraceback (most recent call last):\r\n  File \"/usr/lib/python3/dist-packages/patroni/postgresql/rewind.py\", line 413, in read_postmaster_opts\r\n    with open(os.path.join(self._postgresql.data_dir, 'postmaster.opts')) as f:\r\n         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\nFileNotFoundError: [Errno 2] No such file or directory: '/postgres/udb01/data/postmaster.opts'\r\n2023-04-26 10:17:32,245 MainProcess ERROR: Crash recovery finished with code=1\r\n2023-04-26 10:17:39,073 MainProcess WARNING: Postgresql is not running.\r\n2023-04-26 10:17:49,032 MainProcess WARNING: Postgresql is not running.\r\n2023-04-26 10:17:52,617 MainProcess ERROR: Crash recovery finished with code=-6\r\n2023-04-26 10:17:59,032 MainProcess WARNING: Postgresql is not running.\r\n2023-04-26 10:18:09,030 MainProcess WARNING: Postgresql is not running.\r\n2023-04-26 10:18:11,981 MainProcess ERROR: Crash recovery finished with code=-6\r\n2023-04-26 10:18:13,295 MainProcess WARNING: Postgresql is not running.\r\n2023-04-26 10:18:16,207 MainProcess ERROR: Crash recovery finished with code=-6\r\n2023-04-26 10:18:19,074 MainProcess WARNING: Postgresql is not running.\r\n2023-04-26 10:18:29,074 MainProcess WARNING: Postgresql is not running.\r\n2023-04-26 10:18:32,682 MainProcess ERROR: Crash recovery finished with code=-6\r\n2023-04-26 10:18:39,030 MainProcess WARNING: Postgresql is not running.\r\n2023-04-26 10:18:49,030 MainProcess WARNING: Postgresql is not running.\r\n2023-04-26 10:18:52,144 MainProcess ERROR: Crash recovery finished with code=-6\r\n2023-04-26 10:18:59,074 MainProcess WARNING: Postgresql is not running.\r\n2023-04-26 10:19:03,797 MainProcess WARNING: Postgresql is not running.\r\n2023-04-26 10:19:05,076 MainProcess ERROR: postmaster is not running\r\n2023-04-26 10:19:19,031 MainProcess WARNING: Postgresql is not running.\r\n\r\nNOTE: PGDATA directory\r\npostgres@prdudb01:/postgres/udb01/data=> ll\r\ntotal 280K\r\n-rw-r----- 1 postgres tsdba    3 Jan 20  2022 PG_VERSION\r\n-rw-r----- 1 postgres tsdba  183 Apr 26 05:19 backup_label.old\r\ndrwxr-x--- 6 postgres tsdba 4.0K Apr 25 21:33 base/\r\n-rw-r----- 1 postgres tsdba   47 Apr 26 12:18 current_logfiles\r\ndrwxr-x--- 2 postgres tsdba 4.0K Apr 26 12:10 global/\r\n-rw-rw---- 1 postgres tsdba  494 Apr 26 05:16 patroni.dynamic.json\r\ndrwxr-x--- 2 postgres tsdba  92K Apr 26 12:17 pg_commit_ts/\r\ndrwxr-x--- 2 postgres tsdba 4.0K Jan 20  2022 pg_dynshmem/\r\n-rw-r--r-- 1 postgres tsdba 1.2K Apr 26 12:09 pg_hba.conf\r\n-rw-r--r-- 1 postgres tsdba 1.2K Apr 26 12:09 pg_hba.conf.backup\r\n-rw-r----- 1 postgres tsdba 1.6K Apr 26 05:17 pg_ident.conf\r\n-rw-r----- 1 postgres tsdba 1.6K Apr 26 12:09 pg_ident.conf.backup\r\ndrwxr-x--- 4 postgres tsdba 4.0K Apr 26 12:18 pg_logical/\r\ndrwxr-x--- 4 postgres tsdba 4.0K Jan 20  2022 pg_multixact/\r\ndrwxr-x--- 2 postgres tsdba 4.0K Jan 20  2022 pg_notify/\r\ndrwxr-x--- 2 postgres tsdba 4.0K Apr 26 05:16 pg_replslot/\r\ndrwxr-x--- 2 postgres tsdba 4.0K Jan 20  2022 pg_serial/\r\ndrwxr-x--- 2 postgres tsdba 4.0K Jan 20  2022 pg_snapshots/\r\ndrwxr-x--- 2 postgres tsdba 4.0K Apr 26 12:09 pg_stat/\r\ndrwxr-x--- 2 postgres tsdba 4.0K Apr 26 12:18 pg_stat_tmp/\r\ndrwxr-x--- 2 postgres tsdba  12K Apr 26 12:09 pg_subtrans/\r\ndrwxr-x--- 2 postgres tsdba 4.0K Aug  9  2022 pg_tblspc/\r\ndrwxr-x--- 2 postgres tsdba 4.0K Jan 20  2022 pg_twophase/\r\nlrwxrwxrwx 1 postgres tsdba   19 Jan 20  2022 pg_wal -> /postgres/wal/udb01/\r\ndrwxr-x--- 2 postgres tsdba 4.0K Apr 26 05:38 pg_xact/\r\n-rw-r----- 1 postgres tsdba  181 Apr 26 05:17 postgresql.auto.conf\r\n-rw-r----- 1 postgres tsdba  31K Apr 26 05:17 postgresql.base.conf\r\n-rw-r----- 1 postgres tsdba  31K Apr 26 12:09 postgresql.base.conf.backup\r\n-rw-r--r-- 1 postgres tsdba 3.2K Apr 26 12:09 postgresql.conf\r\n-rw-r--r-- 1 postgres tsdba 3.2K Apr 26 12:09 postgresql.conf.backup\r\n-rw-r----- 1 postgres tsdba  450 Apr 26 12:09 postmaster.opts\r\n-rw-r----- 1 postgres tsdba  101 Apr 26 12:09 postmaster.pid\r\n-rw-r----- 1 postgres tsdba    0 Apr 26 05:16 recovery.signal.nop\r\n-rw-r--r-- 1 postgres tsdba    0 Apr 26 05:19 standby.signal\n```\n\n\n### PostgreSQL log files\n\n```shell\n2023-04-26 17:09:51 UTC PRDUDB01 [p:582261 s:00000] :::LOG:  starting PostgreSQL 13.5 (Ubuntu 13.5-2.pgdg20.04+1) on x86_64-pc-linux-gnu, compiled by gcc (Ubuntu 9.3.0-17ubuntu1~20.04) 9\r\n.3.0, 64-bit\r\n2023-04-26 17:09:51 UTC PRDUDB01 [p:582261 s:00000] :::LOG:  listening on IPv4 address \"0.0.0.0\", port 5432\r\n2023-04-26 17:09:51 UTC PRDUDB01 [p:582261 s:00000] :::LOG:  listening on Unix socket \"/var/run/postgresql/.s.PGSQL.5432\"\r\n2023-04-26 17:09:51 UTC PRDUDB01 [p:582264 s:00000] :::LOG:  database system was shut down in recovery at 2023-04-26 17:09:50 UTC\r\n2023-04-26 17:09:51 UTC PRDUDB01 [p:582264 s:00000] :::LOG:  entering standby mode\r\n2023-04-26 17:09:51 UTC PRDUDB01 [p:582270 s:57P03] 127.0.0.1(39660):[unknown]::FATAL:  the database system is starting up\r\n2023-04-26 17:09:51 UTC PRDUDB01 [p:582264 s:00000] :::LOG:  restored log file \"000000BA.history\" from archive\r\n2023-04-26 17:09:52 UTC PRDUDB01 [p:582264 s:00000] :::LOG:  redo starts at 133D/CBA21B70\r\n2023-04-26 17:09:52 UTC PRDUDB01 [p:582264 s:00000] :::LOG:  consistent recovery state reached at 133D/CBB79B40\r\n2023-04-26 17:09:52 UTC PRDUDB01 [p:582264 s:00000] :::LOG:  invalid record length at 133D/CBB79B40: wanted 24, got 0\r\n2023-04-26 17:09:52 UTC PRDUDB01 [p:582261 s:00000] :::LOG:  database system is ready to accept read only connections\r\n2023-04-26 17:09:52 UTC PRDUDB01 [p:582278 s:00000] :::LOG:  started streaming WAL from primary at 133D/C8000000 on timeline 186\n```\n\n\n### Have you tried to use GitHub issue search?\n\n- [X] Yes\n\n### Anything else we need to know?\n\n_No response_", "reactions": {"url": "https://api.github.com/repos/zalando/patroni/issues/2654/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/zalando/patroni/issues/2654/timeline", "performed_via_github_app": null, "state_reason": "completed"}, {"url": "https://api.github.com/repos/zalando/patroni/issues/2646", "repository_url": "https://api.github.com/repos/zalando/patroni", "labels_url": "https://api.github.com/repos/zalando/patroni/issues/2646/labels{/name}", "comments_url": "https://api.github.com/repos/zalando/patroni/issues/2646/comments", "events_url": "https://api.github.com/repos/zalando/patroni/issues/2646/events", "html_url": "https://github.com/zalando/patroni/issues/2646", "id": 1673402325, "node_id": "I_kwDOAk8yXs5jvhfV", "number": 2646, "title": "patronictl - ERROR - Failed to get list of machines", "user": {"login": "Z08ADUNE", "id": 95642955, "node_id": "U_kgDOBbNlSw", "avatar_url": "https://avatars.githubusercontent.com/u/95642955?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Z08ADUNE", "html_url": "https://github.com/Z08ADUNE", "followers_url": "https://api.github.com/users/Z08ADUNE/followers", "following_url": "https://api.github.com/users/Z08ADUNE/following{/other_user}", "gists_url": "https://api.github.com/users/Z08ADUNE/gists{/gist_id}", "starred_url": "https://api.github.com/users/Z08ADUNE/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Z08ADUNE/subscriptions", "organizations_url": "https://api.github.com/users/Z08ADUNE/orgs", "repos_url": "https://api.github.com/users/Z08ADUNE/repos", "events_url": "https://api.github.com/users/Z08ADUNE/events{/privacy}", "received_events_url": "https://api.github.com/users/Z08ADUNE/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 233785759, "node_id": "MDU6TGFiZWwyMzM3ODU3NTk=", "url": "https://api.github.com/repos/zalando/patroni/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2023-04-18T15:44:24Z", "updated_at": "2023-04-19T14:53:30Z", "closed_at": "2023-04-19T14:42:37Z", "author_association": "NONE", "active_lock_reason": null, "body": "### What happened?\n\nHello,\r\n\r\nI have a random error when i use \"patronictl list\" or \"patronictl show-config\" but it's works anyway. \r\n\r\n2023-04-18 17:18:45,436 - ERROR - Failed to get list of machines from http://:2379/v2: LocationValueError('No host specified.')\r\n+ Cluster: rocky_poc --------------+---------+---------+----+-----------+\r\n| Member      | Host               | Role    | State   | TL | Lag in MB |\r\n+-------------+--------------------+---------+---------+----+-----------+\r\n| server1 | xxxxxx:5432 | Replica | running |  2 |         0 |\r\n| server2 | xxxxxx:5432 | Leader  | running |  2 |           |\r\n| server3 | xxxxxx:5432 | Replica | running |  2 |         0 |\r\n+-------------+--------------------+---------+---------+----+-----------+\r\n\r\nI don't use etcdv2 nor 2379 port in my etcd configuration and I don't have any errors when I use etcdctl member list\r\n\n\n### How can we reproduce it (as minimally and precisely as possible)?\n\npatronictl list\r\n\r\nError appears sometimes...\n\n### What did you expect to happen?\n\nNo error :)\r\n\n\n### Patroni/PostgreSQL/DCS version\n\n-   Patroni version: 3.0.2\r\n-   PostgreSQL version: 15.2\r\n-   DCS (and its version): \r\netcdctl version: 3.5.8\r\nAPI version: 3.5\r\n\n\n### Patroni configuration file\n\n```yaml\netcd3:\r\n  host: xxxxx:8008\r\n  hosts:\r\n    xxxxx:8008,\r\n    xxxxx:8008,\r\n    xxxxx:8008,\r\n  protocol: http\n```\n\n\n### patronictl show-config\n\n```yaml\n2023-04-18 17:36:36,136 - ERROR - Failed to get list of machines from http://:2379/v2: LocationValueError('No host specified.')\r\nloop_wait: 10\r\nmaster_start_timeout: 300\r\nmaximum_lag_on_failover: 1048576\r\npostgresql:\r\n  use_pg_rewind: true\r\n  use_slots: true\r\nretry_timeout: 10\r\nsynchronous_mode: false\r\nsynchronous_mode_strict: false\r\nttl: 30\n```\n\n\n### Patroni log files\n\n```shell\nno errors in log files\n```\n\n\n### PostgreSQL log files\n\n```shell\nno errors in log files\n```\n\n\n### Have you tried to use GitHub issue search?\n\n- [X] Yes\n\n### Anything else we need to know?\n\nThanks a lot :).", "reactions": {"url": "https://api.github.com/repos/zalando/patroni/issues/2646/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/zalando/patroni/issues/2646/timeline", "performed_via_github_app": null, "state_reason": "not_planned"}, {"url": "https://api.github.com/repos/zalando/patroni/issues/2639", "repository_url": "https://api.github.com/repos/zalando/patroni", "labels_url": "https://api.github.com/repos/zalando/patroni/issues/2639/labels{/name}", "comments_url": "https://api.github.com/repos/zalando/patroni/issues/2639/comments", "events_url": "https://api.github.com/repos/zalando/patroni/issues/2639/events", "html_url": "https://github.com/zalando/patroni/pull/2639", "id": 1661319852, "node_id": "PR_kwDOAk8yXs5N9nD_", "number": 2639, "title": "Cover `etcd3` in `parse_dcs` function", "user": {"login": "barthisrael", "id": 19229012, "node_id": "MDQ6VXNlcjE5MjI5MDEy", "avatar_url": "https://avatars.githubusercontent.com/u/19229012?v=4", "gravatar_id": "", "url": "https://api.github.com/users/barthisrael", "html_url": "https://github.com/barthisrael", "followers_url": "https://api.github.com/users/barthisrael/followers", "following_url": "https://api.github.com/users/barthisrael/following{/other_user}", "gists_url": "https://api.github.com/users/barthisrael/gists{/gist_id}", "starred_url": "https://api.github.com/users/barthisrael/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/barthisrael/subscriptions", "organizations_url": "https://api.github.com/users/barthisrael/orgs", "repos_url": "https://api.github.com/users/barthisrael/repos", "events_url": "https://api.github.com/users/barthisrael/events{/privacy}", "received_events_url": "https://api.github.com/users/barthisrael/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 233785759, "node_id": "MDU6TGFiZWwyMzM3ODU3NTk=", "url": "https://api.github.com/repos/zalando/patroni/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": {"url": "https://api.github.com/repos/zalando/patroni/milestones/13", "html_url": "https://github.com/zalando/patroni/milestone/13", "labels_url": "https://api.github.com/repos/zalando/patroni/milestones/13/labels", "id": 9266890, "node_id": "MI_kwDOAk8yXs4AjWbK", "number": 13, "title": "Sprint 2023.07", "description": "12.04.2023-25.04.2023", "creator": {"login": "CyberDem0n", "id": 3407345, "node_id": "MDQ6VXNlcjM0MDczNDU=", "avatar_url": "https://avatars.githubusercontent.com/u/3407345?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CyberDem0n", "html_url": "https://github.com/CyberDem0n", "followers_url": "https://api.github.com/users/CyberDem0n/followers", "following_url": "https://api.github.com/users/CyberDem0n/following{/other_user}", "gists_url": "https://api.github.com/users/CyberDem0n/gists{/gist_id}", "starred_url": "https://api.github.com/users/CyberDem0n/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CyberDem0n/subscriptions", "organizations_url": "https://api.github.com/users/CyberDem0n/orgs", "repos_url": "https://api.github.com/users/CyberDem0n/repos", "events_url": "https://api.github.com/users/CyberDem0n/events{/privacy}", "received_events_url": "https://api.github.com/users/CyberDem0n/received_events", "type": "User", "site_admin": false}, "open_issues": 0, "closed_issues": 13, "state": "closed", "created_at": "2023-04-11T09:15:57Z", "updated_at": "2023-04-26T12:47:01Z", "due_on": "2023-04-25T07:00:00Z", "closed_at": "2023-04-26T12:47:01Z"}, "comments": 3, "created_at": "2023-04-10T20:29:41Z", "updated_at": "2023-04-12T13:13:20Z", "closed_at": "2023-04-12T07:02:32Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "draft": false, "pull_request": {"url": "https://api.github.com/repos/zalando/patroni/pulls/2639", "html_url": "https://github.com/zalando/patroni/pull/2639", "diff_url": "https://github.com/zalando/patroni/pull/2639.diff", "patch_url": "https://github.com/zalando/patroni/pull/2639.patch", "merged_at": "2023-04-12T07:02:32Z"}, "body": "Previous to this commit the `parse_dcs` function would fail with a `PatroniCtlException` if the user ever passed an `etcd3` URL through `--dcs-url` command-line option.\r\n\r\nAs a consequence, the only way of using `etcd3` in `patronictl` was by using a configuration file passed through `-c` command-line option.\r\n\r\nThis commit fixes that issue and allows `etcd3` to be used in `--dcs-url`.\r\n\r\nReferences: PAT-91 #2638", "reactions": {"url": "https://api.github.com/repos/zalando/patroni/issues/2639/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/zalando/patroni/issues/2639/timeline", "performed_via_github_app": null, "state_reason": null}, {"url": "https://api.github.com/repos/zalando/patroni/issues/2638", "repository_url": "https://api.github.com/repos/zalando/patroni", "labels_url": "https://api.github.com/repos/zalando/patroni/issues/2638/labels{/name}", "comments_url": "https://api.github.com/repos/zalando/patroni/issues/2638/comments", "events_url": "https://api.github.com/repos/zalando/patroni/issues/2638/events", "html_url": "https://github.com/zalando/patroni/issues/2638", "id": 1661313131, "node_id": "I_kwDOAk8yXs5jBaBr", "number": 2638, "title": "`--dcs-url` command-line option of `patronictl` does not cover `etcd3` DCS", "user": {"login": "barthisrael", "id": 19229012, "node_id": "MDQ6VXNlcjE5MjI5MDEy", "avatar_url": "https://avatars.githubusercontent.com/u/19229012?v=4", "gravatar_id": "", "url": "https://api.github.com/users/barthisrael", "html_url": "https://github.com/barthisrael", "followers_url": "https://api.github.com/users/barthisrael/followers", "following_url": "https://api.github.com/users/barthisrael/following{/other_user}", "gists_url": "https://api.github.com/users/barthisrael/gists{/gist_id}", "starred_url": "https://api.github.com/users/barthisrael/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/barthisrael/subscriptions", "organizations_url": "https://api.github.com/users/barthisrael/orgs", "repos_url": "https://api.github.com/users/barthisrael/repos", "events_url": "https://api.github.com/users/barthisrael/events{/privacy}", "received_events_url": "https://api.github.com/users/barthisrael/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 233785759, "node_id": "MDU6TGFiZWwyMzM3ODU3NTk=", "url": "https://api.github.com/repos/zalando/patroni/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": {"url": "https://api.github.com/repos/zalando/patroni/milestones/13", "html_url": "https://github.com/zalando/patroni/milestone/13", "labels_url": "https://api.github.com/repos/zalando/patroni/milestones/13/labels", "id": 9266890, "node_id": "MI_kwDOAk8yXs4AjWbK", "number": 13, "title": "Sprint 2023.07", "description": "12.04.2023-25.04.2023", "creator": {"login": "CyberDem0n", "id": 3407345, "node_id": "MDQ6VXNlcjM0MDczNDU=", "avatar_url": "https://avatars.githubusercontent.com/u/3407345?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CyberDem0n", "html_url": "https://github.com/CyberDem0n", "followers_url": "https://api.github.com/users/CyberDem0n/followers", "following_url": "https://api.github.com/users/CyberDem0n/following{/other_user}", "gists_url": "https://api.github.com/users/CyberDem0n/gists{/gist_id}", "starred_url": "https://api.github.com/users/CyberDem0n/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CyberDem0n/subscriptions", "organizations_url": "https://api.github.com/users/CyberDem0n/orgs", "repos_url": "https://api.github.com/users/CyberDem0n/repos", "events_url": "https://api.github.com/users/CyberDem0n/events{/privacy}", "received_events_url": "https://api.github.com/users/CyberDem0n/received_events", "type": "User", "site_admin": false}, "open_issues": 0, "closed_issues": 13, "state": "closed", "created_at": "2023-04-11T09:15:57Z", "updated_at": "2023-04-26T12:47:01Z", "due_on": "2023-04-25T07:00:00Z", "closed_at": "2023-04-26T12:47:01Z"}, "comments": 0, "created_at": "2023-04-10T20:23:07Z", "updated_at": "2023-04-12T07:02:37Z", "closed_at": "2023-04-12T07:02:36Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "### What happened?\n\nI attempted to use `--dcs-url` commad-line option of `patronictl` command to specify the DCS URI but it did not work -- it throws an error about unknown scheme:\r\n\r\n```bash\r\n$ patronictl -c postgres0.yml --dcs-url \"etcd://localhost:2379\" list batman\r\n+ Cluster: batman -----+-------+----+-----------+\r\n| Member | Host | Role | State | TL | Lag in MB |\r\n+--------+------+------+-------+----+-----------+\r\n+--------+------+------+-------+----+-----------+\r\n\r\n$ patronictl -c postgres0.yml --dcs-url \"etcd3://localhost:2379\" list batman\r\nError: Unknown dcs scheme: etcd3\r\n```\n\n### How can we reproduce it (as minimally and precisely as possible)?\n\nExecute the following command:\r\n\r\n```bash\r\npatronictl -c postgres0.yml --dcs-url \"etcd://localhost:2379\" list batman\r\n```\n\n### What did you expect to happen?\n\nOutput to be:\r\n\r\n```bash\r\n$ patronictl -c postgres0.yml --dcs-url \"etcd3://localhost:2379\" list batman\r\n+ Cluster: batman --------+--------+---------+----+-----------+\r\n| Member      | Host      | Role   | State   | TL | Lag in MB |\r\n+-------------+-----------+--------+---------+----+-----------+\r\n| postgresql0 | 127.0.0.1 | Leader | running |  2 |           |\r\n+-------------+-----------+--------+---------+----+-----------+\r\n```\n\n### Patroni/PostgreSQL/DCS version\n\n-   Patroni version: 3.0.2\r\n-   PostgreSQL version: 15.2\r\n-   DCS (and its version): 3.2.26\n\n### Patroni configuration file\n\n```yaml\nscope: batman\r\nname: postgresql0\r\n\r\nrestapi:\r\n  listen: 127.0.0.1:8008\r\n  connect_address: 127.0.0.1:8008\r\n  authentication:\r\n    username: username\r\n    password: password\r\n\r\n\r\netcd3:\r\n  host: 127.0.0.1:2379\r\n\r\n\r\nbootstrap:\r\n  dcs:\r\n    ttl: 30\r\n    loop_wait: 10\r\n    retry_timeout: 10\r\n    maximum_lag_on_failover: 1048576\r\n    postgresql:\r\n      use_pg_rewind: true\r\n      parameters:\r\n\r\n  initdb:  # Note: It needs to be a list (some options need values, others are switches)\r\n  - encoding: UTF8\r\n  - data-checksums\r\n\r\n  pg_hba:  # Add following lines to pg_hba.conf after running 'initdb'\r\n  - host replication replicator 127.0.0.1/32 md5\r\n  - host all all 0.0.0.0/0 md5\r\n\r\n\r\n  users:\r\n    admin:\r\n      password: admin%\r\n      options:\r\n        - createrole\r\n        - createdb\r\n\r\npostgresql:\r\n  listen: 127.0.0.1:5432\r\n  connect_address: 127.0.0.1:5432\r\n  data_dir: data/postgresql0\r\n  pgpass: /tmp/pgpass0\r\n  authentication:\r\n    replication:\r\n      username: replicator\r\n      password: rep-pass\r\n    superuser:\r\n      username: postgres\r\n      password: zalando\r\n    rewind:  # Has no effect on postgres 10 and lower\r\n      username: rewind_user\r\n      password: rewind_password\r\n  parameters:\r\n    unix_socket_directories: '..'  # parent directory of data_dir\r\n\r\n\r\ntags:\r\n    nofailover: false\r\n    noloadbalance: false\r\n    clonefrom: false\r\n    nosync: false\n```\n\n\n### patronictl show-config\n\n```yaml\nloop_wait: 10\r\nmaximum_lag_on_failover: 1048576\r\npostgresql:\r\n  parameters: null\r\n  use_pg_rewind: true\r\nretry_timeout: 10\r\nttl: 30\n```\n\n\n### Patroni log files\n\n```shell\nN/A\n```\n\n\n### PostgreSQL log files\n\n```shell\nN/A\n```\n\n\n### Have you tried to use GitHub issue search?\n\n- [X] Yes\n\n### Anything else we need to know?\n\nI'm working on a patch to fix this issue.", "reactions": {"url": "https://api.github.com/repos/zalando/patroni/issues/2638/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/zalando/patroni/issues/2638/timeline", "performed_via_github_app": null, "state_reason": "completed"}, {"url": "https://api.github.com/repos/zalando/patroni/issues/2637", "repository_url": "https://api.github.com/repos/zalando/patroni", "labels_url": "https://api.github.com/repos/zalando/patroni/issues/2637/labels{/name}", "comments_url": "https://api.github.com/repos/zalando/patroni/issues/2637/comments", "events_url": "https://api.github.com/repos/zalando/patroni/issues/2637/events", "html_url": "https://github.com/zalando/patroni/issues/2637", "id": 1659649922, "node_id": "I_kwDOAk8yXs5i7D-C", "number": 2637, "title": "ignored slots behave tests started to become flaky", "user": {"login": "mbanck", "id": 1670301, "node_id": "MDQ6VXNlcjE2NzAzMDE=", "avatar_url": "https://avatars.githubusercontent.com/u/1670301?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mbanck", "html_url": "https://github.com/mbanck", "followers_url": "https://api.github.com/users/mbanck/followers", "following_url": "https://api.github.com/users/mbanck/following{/other_user}", "gists_url": "https://api.github.com/users/mbanck/gists{/gist_id}", "starred_url": "https://api.github.com/users/mbanck/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mbanck/subscriptions", "organizations_url": "https://api.github.com/users/mbanck/orgs", "repos_url": "https://api.github.com/users/mbanck/repos", "events_url": "https://api.github.com/users/mbanck/events{/privacy}", "received_events_url": "https://api.github.com/users/mbanck/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 233785759, "node_id": "MDU6TGFiZWwyMzM3ODU3NTk=", "url": "https://api.github.com/repos/zalando/patroni/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": {"url": "https://api.github.com/repos/zalando/patroni/milestones/13", "html_url": "https://github.com/zalando/patroni/milestone/13", "labels_url": "https://api.github.com/repos/zalando/patroni/milestones/13/labels", "id": 9266890, "node_id": "MI_kwDOAk8yXs4AjWbK", "number": 13, "title": "Sprint 2023.07", "description": "12.04.2023-25.04.2023", "creator": {"login": "CyberDem0n", "id": 3407345, "node_id": "MDQ6VXNlcjM0MDczNDU=", "avatar_url": "https://avatars.githubusercontent.com/u/3407345?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CyberDem0n", "html_url": "https://github.com/CyberDem0n", "followers_url": "https://api.github.com/users/CyberDem0n/followers", "following_url": "https://api.github.com/users/CyberDem0n/following{/other_user}", "gists_url": "https://api.github.com/users/CyberDem0n/gists{/gist_id}", "starred_url": "https://api.github.com/users/CyberDem0n/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CyberDem0n/subscriptions", "organizations_url": "https://api.github.com/users/CyberDem0n/orgs", "repos_url": "https://api.github.com/users/CyberDem0n/repos", "events_url": "https://api.github.com/users/CyberDem0n/events{/privacy}", "received_events_url": "https://api.github.com/users/CyberDem0n/received_events", "type": "User", "site_admin": false}, "open_issues": 0, "closed_issues": 13, "state": "closed", "created_at": "2023-04-11T09:15:57Z", "updated_at": "2023-04-26T12:47:01Z", "due_on": "2023-04-25T07:00:00Z", "closed_at": "2023-04-26T12:47:01Z"}, "comments": 2, "created_at": "2023-04-08T21:23:34Z", "updated_at": "2023-04-13T10:21:10Z", "closed_at": "2023-04-13T10:21:10Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "### What happened?\r\n\r\nSince 3.0.2 (or earlier? Didn't notice it before), I've seen the \"ignored slots\" feature fail, though, curiously, so far only with zookeeper as DCS, e.g. here (but also locally on my notebook when building for Debian unstable): https://pgdgbuild.dus.dg-i.net/job/patroni-binaries/207/architecture=amd64,distribution=bookworm/console#console-section-1 (it failed in the same way once before: https://pgdgbuild.dus.dg-i.net/job/patroni-binaries/206/architecture=amd64,distribution=bookworm/consoleFull#console-section-24)\r\n\r\n```\r\n08 21:10:34 Feature: ignored slots # features/ignored_slots.feature:1\r\n08 21:10:34\r\n08 21:10:34   Scenario: check ignored slots aren't removed on failover/switchover                                                                                                                                                                                                                                                                                                                                                     # features/ignored_slots.feature:2\r\n08 21:10:34     Given I start postgres1                                                                                                                                                                                                                                                                                                                                                                                               # features/steps/basic_replication.py:7\r\n[...]\r\n08 21:10:40     When I start postgres0                                                                                                                                                                                                                                                                                                                                                                                                # features/steps/basic_replication.py:7\r\n08 21:10:41     Then \"members/postgres0\" key in DCS has role=replica after 3 seconds                                                                                                                                                                                                                                                                                                                                                  # features/steps/cascading_replication.py:23\r\n08 21:10:42     And postgres0 role is the secondary after 20 seconds                                                                                                                                                                                                                                                                                                                                                                  # features/steps/basic_replication.py:79\r\n08 21:10:42     And replication works from postgres1 to postgres0 after 20 seconds                                                                                                                                                                                                                                                                                                                                                    # features/steps/basic_replication.py:86\r\n08 21:10:43     When I shut down postgres1                                                                                                                                                                                                                                                                                                                                                                                            # features/steps/basic_replication.py:12\r\n08 21:10:45     Then \"members/postgres0\" key in DCS has role=master after 3 seconds                                                                                                                                                                                                                                                                                                                                                   # features/steps/cascading_replication.py:23\r\n08 21:10:48       Assertion Failed: members/postgres0 does not have role=master (found promoted) in dcs after 3 seconds\r\n08 21:10:48       Captured stdout:\r\n08 21:10:48       ('(unmanaged_slot_0,0/20001F0)', 'postgres')\r\n08 21:10:48       ('(unmanaged_slot_1,0/2000228)', 'postgres')\r\n08 21:10:48       ('(unmanaged_slot_2,0/2000260)', 'postgres')\r\n08 21:10:48       ('(unmanaged_slot_3,0/2000298)', 'postgres')\r\n08 21:10:48       ('(dummy_slot,0/20002D0)', 'postgres')\r\n```\r\n\r\nAre those 3 seconds maybe not enough time?\r\n\r\n### How can we reproduce it (as minimally and precisely as possible)?\r\n\r\nGood question, it being flaky.\r\n\r\n### What did you expect to happen?\r\n\r\nThe behave testst to pass, or at least also be flaky on 3.0.1\r\n\r\n### Patroni/PostgreSQL/DCS version\r\n\r\n-   Patroni version: 3.0.2\r\n-   PostgreSQL version: all\r\n-   DCS (and its version): zookeeper (but possibly others)\r\n\r\n\r\n### Patroni configuration file\r\n\r\n```yaml\r\nReally?\r\n```\r\n\r\n\r\n### patronictl show-config\r\n\r\n```yaml\r\nReally?\r\n```\r\n\r\n\r\n### Patroni log files\r\n\r\n```shell\r\nReally?\r\n```\r\n\r\n\r\n### PostgreSQL log files\r\n\r\n```shell\r\nReally?\r\n```\r\n\r\n\r\n### Have you tried to use GitHub issue search?\r\n\r\n- [X] Yes\r\n\r\n### Anything else we need to know?\r\n\r\n_No response_", "reactions": {"url": "https://api.github.com/repos/zalando/patroni/issues/2637/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/zalando/patroni/issues/2637/timeline", "performed_via_github_app": null, "state_reason": "completed"}, {"url": "https://api.github.com/repos/zalando/patroni/issues/2633", "repository_url": "https://api.github.com/repos/zalando/patroni", "labels_url": "https://api.github.com/repos/zalando/patroni/issues/2633/labels{/name}", "comments_url": "https://api.github.com/repos/zalando/patroni/issues/2633/comments", "events_url": "https://api.github.com/repos/zalando/patroni/issues/2633/events", "html_url": "https://github.com/zalando/patroni/pull/2633", "id": 1654160758, "node_id": "PR_kwDOAk8yXs5NmZ70", "number": 2633, "title": "Quote strings as values for initdb configuration", "user": {"login": "matthbakeredb", "id": 93600443, "node_id": "U_kgDOBZQ6uw", "avatar_url": "https://avatars.githubusercontent.com/u/93600443?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthbakeredb", "html_url": "https://github.com/matthbakeredb", "followers_url": "https://api.github.com/users/matthbakeredb/followers", "following_url": "https://api.github.com/users/matthbakeredb/following{/other_user}", "gists_url": "https://api.github.com/users/matthbakeredb/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthbakeredb/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthbakeredb/subscriptions", "organizations_url": "https://api.github.com/users/matthbakeredb/orgs", "repos_url": "https://api.github.com/users/matthbakeredb/repos", "events_url": "https://api.github.com/users/matthbakeredb/events{/privacy}", "received_events_url": "https://api.github.com/users/matthbakeredb/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 233785759, "node_id": "MDU6TGFiZWwyMzM3ODU3NTk=", "url": "https://api.github.com/repos/zalando/patroni/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": {"url": "https://api.github.com/repos/zalando/patroni/milestones/13", "html_url": "https://github.com/zalando/patroni/milestone/13", "labels_url": "https://api.github.com/repos/zalando/patroni/milestones/13/labels", "id": 9266890, "node_id": "MI_kwDOAk8yXs4AjWbK", "number": 13, "title": "Sprint 2023.07", "description": "12.04.2023-25.04.2023", "creator": {"login": "CyberDem0n", "id": 3407345, "node_id": "MDQ6VXNlcjM0MDczNDU=", "avatar_url": "https://avatars.githubusercontent.com/u/3407345?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CyberDem0n", "html_url": "https://github.com/CyberDem0n", "followers_url": "https://api.github.com/users/CyberDem0n/followers", "following_url": "https://api.github.com/users/CyberDem0n/following{/other_user}", "gists_url": "https://api.github.com/users/CyberDem0n/gists{/gist_id}", "starred_url": "https://api.github.com/users/CyberDem0n/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CyberDem0n/subscriptions", "organizations_url": "https://api.github.com/users/CyberDem0n/orgs", "repos_url": "https://api.github.com/users/CyberDem0n/repos", "events_url": "https://api.github.com/users/CyberDem0n/events{/privacy}", "received_events_url": "https://api.github.com/users/CyberDem0n/received_events", "type": "User", "site_admin": false}, "open_issues": 0, "closed_issues": 13, "state": "closed", "created_at": "2023-04-11T09:15:57Z", "updated_at": "2023-04-26T12:47:01Z", "due_on": "2023-04-25T07:00:00Z", "closed_at": "2023-04-26T12:47:01Z"}, "comments": 7, "created_at": "2023-04-04T15:59:03Z", "updated_at": "2023-04-24T07:35:40Z", "closed_at": "2023-04-24T07:35:39Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "draft": false, "pull_request": {"url": "https://api.github.com/repos/zalando/patroni/pulls/2633", "html_url": "https://github.com/zalando/patroni/pull/2633", "diff_url": "https://github.com/zalando/patroni/pull/2633.diff", "patch_url": "https://github.com/zalando/patroni/pull/2633.patch", "merged_at": "2023-04-24T07:35:39Z"}, "body": "A user may be confused by the fact that a string value of a configuration dictionary needs to be double-quoted.\r\n\r\nIf a value is already quoted, supporting backwards compatibility with existing config, then unquote it.\r\n\r\nAdds an `initdb` method that bypasses `pg_ctl` which wrapped all arguments into a single option, thus allowing arguments to be in `List` format.\r\n\r\nReferences: PAT-86 #2632", "reactions": {"url": "https://api.github.com/repos/zalando/patroni/issues/2633/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/zalando/patroni/issues/2633/timeline", "performed_via_github_app": null, "state_reason": null}, {"url": "https://api.github.com/repos/zalando/patroni/issues/2632", "repository_url": "https://api.github.com/repos/zalando/patroni", "labels_url": "https://api.github.com/repos/zalando/patroni/issues/2632/labels{/name}", "comments_url": "https://api.github.com/repos/zalando/patroni/issues/2632/comments", "events_url": "https://api.github.com/repos/zalando/patroni/issues/2632/events", "html_url": "https://github.com/zalando/patroni/issues/2632", "id": 1654154526, "node_id": "I_kwDOAk8yXs5imGUe", "number": 2632, "title": "Arguments for initdb containing spaces require double quoting", "user": {"login": "matthbakeredb", "id": 93600443, "node_id": "U_kgDOBZQ6uw", "avatar_url": "https://avatars.githubusercontent.com/u/93600443?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthbakeredb", "html_url": "https://github.com/matthbakeredb", "followers_url": "https://api.github.com/users/matthbakeredb/followers", "following_url": "https://api.github.com/users/matthbakeredb/following{/other_user}", "gists_url": "https://api.github.com/users/matthbakeredb/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthbakeredb/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthbakeredb/subscriptions", "organizations_url": "https://api.github.com/users/matthbakeredb/orgs", "repos_url": "https://api.github.com/users/matthbakeredb/repos", "events_url": "https://api.github.com/users/matthbakeredb/events{/privacy}", "received_events_url": "https://api.github.com/users/matthbakeredb/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 233785759, "node_id": "MDU6TGFiZWwyMzM3ODU3NTk=", "url": "https://api.github.com/repos/zalando/patroni/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": {"url": "https://api.github.com/repos/zalando/patroni/milestones/13", "html_url": "https://github.com/zalando/patroni/milestone/13", "labels_url": "https://api.github.com/repos/zalando/patroni/milestones/13/labels", "id": 9266890, "node_id": "MI_kwDOAk8yXs4AjWbK", "number": 13, "title": "Sprint 2023.07", "description": "12.04.2023-25.04.2023", "creator": {"login": "CyberDem0n", "id": 3407345, "node_id": "MDQ6VXNlcjM0MDczNDU=", "avatar_url": "https://avatars.githubusercontent.com/u/3407345?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CyberDem0n", "html_url": "https://github.com/CyberDem0n", "followers_url": "https://api.github.com/users/CyberDem0n/followers", "following_url": "https://api.github.com/users/CyberDem0n/following{/other_user}", "gists_url": "https://api.github.com/users/CyberDem0n/gists{/gist_id}", "starred_url": "https://api.github.com/users/CyberDem0n/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CyberDem0n/subscriptions", "organizations_url": "https://api.github.com/users/CyberDem0n/orgs", "repos_url": "https://api.github.com/users/CyberDem0n/repos", "events_url": "https://api.github.com/users/CyberDem0n/events{/privacy}", "received_events_url": "https://api.github.com/users/CyberDem0n/received_events", "type": "User", "site_admin": false}, "open_issues": 0, "closed_issues": 13, "state": "closed", "created_at": "2023-04-11T09:15:57Z", "updated_at": "2023-04-26T12:47:01Z", "due_on": "2023-04-25T07:00:00Z", "closed_at": "2023-04-26T12:47:01Z"}, "comments": 1, "created_at": "2023-04-04T15:54:58Z", "updated_at": "2023-04-25T13:21:58Z", "closed_at": "2023-04-25T13:21:57Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "### What happened?\n\nDuring testing new TDE setup in pg15 we noticed that configuration for initdb is unintuitive. Values which contain spaces appear to require quoting twice. The result if this is not done is a failure to bootstrap the cluster.\n\n### How can we reproduce it (as minimally and precisely as possible)?\n\nCreate a patroni configuration with extra arguments to setup TDE. Start patroni fresh install.\r\n\n\n### What did you expect to happen?\n\nPostgres initdb key-value arguments passed quoted when in a list of dicts form, where the value is a string with spaces.\n\n### Patroni/PostgreSQL/DCS version\n\n-   Patroni version: \r\n-   PostgreSQL version: \r\n-   DCS (and its version): \r\n\n\n### Patroni configuration file\n\n```yaml\ninitdb:\r\n  - encoding: UTF8\r\n  - data-checksums\r\n  - auth-local: peer\r\n  - auth-host: scram-sha-256\r\n  - data-encryption\r\n  - key-wrap-command: \"openssl enc -e -pbkdf2 -out %p -pass pass:trustno1\"\r\n  - key-unwrap-command: \"openssl enc -d -pbkdf2 -in %p -pass pass:trustno1\"\n```\n\n\n### patronictl show-config\n\n```yaml\nn/a\n```\n\n\n### Patroni log files\n\n```shell\nApr 04 07:42:27 pgext-patroni1 patroni[26555]: 2023-04-04 07:42:27,101 INFO: trying to bootstrap a new cluster\r\nApr 04 07:42:27 pgext-patroni1 patroni[26555]: /usr/edb/pge15/bin/initdb: invalid option -- 'e'\r\nApr 04 07:42:27 pgext-patroni1 patroni[26555]: initdb: hint: Try \"initdb --help\" for more information.\r\nApr 04 07:42:27 pgext-patroni1 patroni[26555]: pg_ctl: database system initialization failed\r\nApr 04 07:42:27 pgext-patroni1 patroni[26555]: 2023-04-04 07:42:27,111 INFO: removing initialize key after failed attempt to bootstrap the cluster\r\nApr 04 07:42:27 pgext-patroni1 patroni[26555]: Traceback (most recent call last):\r\nApr 04 07:42:27 pgext-patroni1 patroni[26555]:   File \"/usr/bin/patroni\", line 11, in <module>\r\nApr 04 07:42:27 pgext-patroni1 patroni[26555]:     load_entry_point('patroni==3.0.2', 'console_scripts', 'patroni')()\r\nApr 04 07:42:27 pgext-patroni1 patroni[26555]:   File \"/usr/lib/python3.6/site-packages/patroni/__main__.py\", line 144, in main\r\nApr 04 07:42:27 pgext-patroni1 patroni[26555]:     return patroni_main()\r\nApr 04 07:42:27 pgext-patroni1 patroni[26555]:   File \"/usr/lib/python3.6/site-packages/patroni/__main__.py\", line 136, in patroni_main\r\nApr 04 07:42:27 pgext-patroni1 patroni[26555]:     abstract_main(Patroni, schema)\r\nApr 04 07:42:27 pgext-patroni1 patroni[26555]:   File \"/usr/lib/python3.6/site-packages/patroni/daemon.py\", line 181, in abstract_main\r\nApr 04 07:42:27 pgext-patroni1 patroni[26555]:     controller.run()\r\nApr 04 07:42:27 pgext-patroni1 patroni[26555]:   File \"/usr/lib/python3.6/site-packages/patroni/__main__.py\", line 106, in run\r\nApr 04 07:42:27 pgext-patroni1 patroni[26555]:     super(Patroni, self).run()\r\nApr 04 07:42:27 pgext-patroni1 patroni[26555]:   File \"/usr/lib/python3.6/site-packages/patroni/daemon.py\", line 126, in run\r\nApr 04 07:42:27 pgext-patroni1 patroni[26555]:     self._run_cycle()\r\nApr 04 07:42:27 pgext-patroni1 patroni[26555]:   File \"/usr/lib/python3.6/site-packages/patroni/__main__.py\", line 109, in _run_cycle\r\nApr 04 07:42:27 pgext-patroni1 patroni[26555]:     logger.info(self.ha.run_cycle())\r\nApr 04 07:42:27 pgext-patroni1 patroni[26555]:   File \"/usr/lib/python3.6/site-packages/patroni/ha.py\", line 1770, in run_cycle\r\nApr 04 07:42:27 pgext-patroni1 patroni[26555]:     info = self._run_cycle()\r\nApr 04 07:42:27 pgext-patroni1 patroni[26555]:   File \"/usr/lib/python3.6/site-packages/patroni/ha.py\", line 1592, in _run_cycle\r\nApr 04 07:42:27 pgext-patroni1 patroni[26555]:     return self.post_bootstrap()\r\nApr 04 07:42:27 pgext-patroni1 patroni[26555]:   File \"/usr/lib/python3.6/site-packages/patroni/ha.py\", line 1483, in post_bootstrap\r\nApr 04 07:42:27 pgext-patroni1 patroni[26555]:     self.cancel_initialization()\r\nApr 04 07:42:27 pgext-patroni1 patroni[26555]:   File \"/usr/lib/python3.6/site-packages/patroni/ha.py\", line 1476, in cancel_initialization\r\nApr 04 07:42:27 pgext-patroni1 patroni[26555]:     raise PatroniFatalException('Failed to bootstrap cluster')\r\nApr 04 07:42:27 pgext-patroni1 patroni[26555]: patroni.exceptions.PatroniFatalException: 'Failed to bootstrap cluster\n```\n\n\n### PostgreSQL log files\n\n```shell\nn/a\n```\n\n\n### Have you tried to use GitHub issue search?\n\n- [X] Yes\n\n### Anything else we need to know?\n\nI will submit a PR with a possible fix shortly.", "reactions": {"url": "https://api.github.com/repos/zalando/patroni/issues/2632/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/zalando/patroni/issues/2632/timeline", "performed_via_github_app": null, "state_reason": "completed"}, {"url": "https://api.github.com/repos/zalando/patroni/issues/2618", "repository_url": "https://api.github.com/repos/zalando/patroni", "labels_url": "https://api.github.com/repos/zalando/patroni/issues/2618/labels{/name}", "comments_url": "https://api.github.com/repos/zalando/patroni/issues/2618/comments", "events_url": "https://api.github.com/repos/zalando/patroni/issues/2618/events", "html_url": "https://github.com/zalando/patroni/issues/2618", "id": 1639090047, "node_id": "I_kwDOAk8yXs5hsod_", "number": 2618, "title": "How to change the Send-Q of patroni", "user": {"login": "PiPi-Dragon", "id": 27352343, "node_id": "MDQ6VXNlcjI3MzUyMzQz", "avatar_url": "https://avatars.githubusercontent.com/u/27352343?v=4", "gravatar_id": "", "url": "https://api.github.com/users/PiPi-Dragon", "html_url": "https://github.com/PiPi-Dragon", "followers_url": "https://api.github.com/users/PiPi-Dragon/followers", "following_url": "https://api.github.com/users/PiPi-Dragon/following{/other_user}", "gists_url": "https://api.github.com/users/PiPi-Dragon/gists{/gist_id}", "starred_url": "https://api.github.com/users/PiPi-Dragon/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/PiPi-Dragon/subscriptions", "organizations_url": "https://api.github.com/users/PiPi-Dragon/orgs", "repos_url": "https://api.github.com/users/PiPi-Dragon/repos", "events_url": "https://api.github.com/users/PiPi-Dragon/events{/privacy}", "received_events_url": "https://api.github.com/users/PiPi-Dragon/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 233785759, "node_id": "MDU6TGFiZWwyMzM3ODU3NTk=", "url": "https://api.github.com/repos/zalando/patroni/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": {"url": "https://api.github.com/repos/zalando/patroni/milestones/11", "html_url": "https://github.com/zalando/patroni/milestone/11", "labels_url": "https://api.github.com/repos/zalando/patroni/milestones/11/labels", "id": 9162178, "node_id": "MI_kwDOAk8yXs4Ai83C", "number": 11, "title": "Sprint 2023.05", "description": "15.03.2023-28.03.2023", "creator": {"login": "CyberDem0n", "id": 3407345, "node_id": "MDQ6VXNlcjM0MDczNDU=", "avatar_url": "https://avatars.githubusercontent.com/u/3407345?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CyberDem0n", "html_url": "https://github.com/CyberDem0n", "followers_url": "https://api.github.com/users/CyberDem0n/followers", "following_url": "https://api.github.com/users/CyberDem0n/following{/other_user}", "gists_url": "https://api.github.com/users/CyberDem0n/gists{/gist_id}", "starred_url": "https://api.github.com/users/CyberDem0n/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CyberDem0n/subscriptions", "organizations_url": "https://api.github.com/users/CyberDem0n/orgs", "repos_url": "https://api.github.com/users/CyberDem0n/repos", "events_url": "https://api.github.com/users/CyberDem0n/events{/privacy}", "received_events_url": "https://api.github.com/users/CyberDem0n/received_events", "type": "User", "site_admin": false}, "open_issues": 0, "closed_issues": 16, "state": "closed", "created_at": "2023-03-15T10:48:01Z", "updated_at": "2023-03-31T12:00:12Z", "due_on": "2023-03-28T07:00:00Z", "closed_at": "2023-03-31T12:00:12Z"}, "comments": 7, "created_at": "2023-03-24T10:05:05Z", "updated_at": "2023-03-27T06:09:22Z", "closed_at": "2023-03-24T12:18:28Z", "author_association": "NONE", "active_lock_reason": null, "body": "### What happened?\n\n![image](https://user-images.githubusercontent.com/27352343/227488194-4ba23b87-671c-4e8d-b49c-ae97e15a487a.png)\r\nHow to change the somaxconn of patroni ? \r\nI have changed the parameters of the system and restarted patroni , but the Send-Q of the patroni do not change.\n\n### How can we reproduce it (as minimally and precisely as possible)?\n\n--\n\n### What did you expect to happen?\n\n--\n\n### Patroni/PostgreSQL/DCS version\n\n-   Patroni version: 2.0.2\r\n-   PostgreSQL version: \r\n-   DCS (and its version): \r\n\n\n### Patroni configuration file\n\n```yaml\n--\n```\n\n\n### patronictl show-config\n\n```yaml\n--\n```\n\n\n### Patroni log files\n\n```shell\n--\n```\n\n\n### PostgreSQL log files\n\n```shell\n--\n```\n\n\n### Have you tried to use GitHub issue search?\n\n- [X] Yes\n\n### Anything else we need to know?\n\n--", "reactions": {"url": "https://api.github.com/repos/zalando/patroni/issues/2618/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/zalando/patroni/issues/2618/timeline", "performed_via_github_app": null, "state_reason": "completed"}, {"url": "https://api.github.com/repos/zalando/patroni/issues/2614", "repository_url": "https://api.github.com/repos/zalando/patroni", "labels_url": "https://api.github.com/repos/zalando/patroni/issues/2614/labels{/name}", "comments_url": "https://api.github.com/repos/zalando/patroni/issues/2614/comments", "events_url": "https://api.github.com/repos/zalando/patroni/issues/2614/events", "html_url": "https://github.com/zalando/patroni/pull/2614", "id": 1635501565, "node_id": "PR_kwDOAk8yXs5MoRf8", "number": 2614, "title": "Make sure Cluster.sync is never empty", "user": {"login": "CyberDem0n", "id": 3407345, "node_id": "MDQ6VXNlcjM0MDczNDU=", "avatar_url": "https://avatars.githubusercontent.com/u/3407345?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CyberDem0n", "html_url": "https://github.com/CyberDem0n", "followers_url": "https://api.github.com/users/CyberDem0n/followers", "following_url": "https://api.github.com/users/CyberDem0n/following{/other_user}", "gists_url": "https://api.github.com/users/CyberDem0n/gists{/gist_id}", "starred_url": "https://api.github.com/users/CyberDem0n/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CyberDem0n/subscriptions", "organizations_url": "https://api.github.com/users/CyberDem0n/orgs", "repos_url": "https://api.github.com/users/CyberDem0n/repos", "events_url": "https://api.github.com/users/CyberDem0n/events{/privacy}", "received_events_url": "https://api.github.com/users/CyberDem0n/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 233785759, "node_id": "MDU6TGFiZWwyMzM3ODU3NTk=", "url": "https://api.github.com/repos/zalando/patroni/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}, {"id": 233785761, "node_id": "MDU6TGFiZWwyMzM3ODU3NjE=", "url": "https://api.github.com/repos/zalando/patroni/labels/enhancement", "name": "enhancement", "color": "84b6eb", "default": true, "description": null}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": {"url": "https://api.github.com/repos/zalando/patroni/milestones/11", "html_url": "https://github.com/zalando/patroni/milestone/11", "labels_url": "https://api.github.com/repos/zalando/patroni/milestones/11/labels", "id": 9162178, "node_id": "MI_kwDOAk8yXs4Ai83C", "number": 11, "title": "Sprint 2023.05", "description": "15.03.2023-28.03.2023", "creator": {"login": "CyberDem0n", "id": 3407345, "node_id": "MDQ6VXNlcjM0MDczNDU=", "avatar_url": "https://avatars.githubusercontent.com/u/3407345?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CyberDem0n", "html_url": "https://github.com/CyberDem0n", "followers_url": "https://api.github.com/users/CyberDem0n/followers", "following_url": "https://api.github.com/users/CyberDem0n/following{/other_user}", "gists_url": "https://api.github.com/users/CyberDem0n/gists{/gist_id}", "starred_url": "https://api.github.com/users/CyberDem0n/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CyberDem0n/subscriptions", "organizations_url": "https://api.github.com/users/CyberDem0n/orgs", "repos_url": "https://api.github.com/users/CyberDem0n/repos", "events_url": "https://api.github.com/users/CyberDem0n/events{/privacy}", "received_events_url": "https://api.github.com/users/CyberDem0n/received_events", "type": "User", "site_admin": false}, "open_issues": 0, "closed_issues": 16, "state": "closed", "created_at": "2023-03-15T10:48:01Z", "updated_at": "2023-03-31T12:00:12Z", "due_on": "2023-03-28T07:00:00Z", "closed_at": "2023-03-31T12:00:12Z"}, "comments": 3, "created_at": "2023-03-22T10:40:52Z", "updated_at": "2023-03-22T15:41:43Z", "closed_at": "2023-03-22T15:41:41Z", "author_association": "COLLABORATOR", "active_lock_reason": null, "draft": false, "pull_request": {"url": "https://api.github.com/repos/zalando/patroni/pulls/2614", "html_url": "https://github.com/zalando/patroni/pull/2614", "diff_url": "https://github.com/zalando/patroni/pull/2614.diff", "patch_url": "https://github.com/zalando/patroni/pull/2614.patch", "merged_at": "2023-03-22T15:41:41Z"}, "body": "It was possible to have it empty if the all cluster keys are missing in DCS. In this case the `Cluster` object was manually created with all values set to `None` or `[]` (including sync).\r\nIt already resulted in #2217, which is in fact wasn't a correct fix.\r\n\r\nIn order to solve it and reduce code duplication we introduce `Cluster.empty()` and `SyncState.empty()` methods, which will create corresponding empty objects and start using `Cluster.empty()` from all places where the empty `Cluster` object was manually created.", "reactions": {"url": "https://api.github.com/repos/zalando/patroni/issues/2614/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/zalando/patroni/issues/2614/timeline", "performed_via_github_app": null, "state_reason": null}, {"url": "https://api.github.com/repos/zalando/patroni/issues/2601", "repository_url": "https://api.github.com/repos/zalando/patroni", "labels_url": "https://api.github.com/repos/zalando/patroni/issues/2601/labels{/name}", "comments_url": "https://api.github.com/repos/zalando/patroni/issues/2601/comments", "events_url": "https://api.github.com/repos/zalando/patroni/issues/2601/events", "html_url": "https://github.com/zalando/patroni/issues/2601", "id": 1628331017, "node_id": "I_kwDOAk8yXs5hDlwJ", "number": 2601, "title": "SSL error when enable ssl in Patroni rest api", "user": {"login": "AleksandrAksenov", "id": 91747881, "node_id": "U_kgDOBXf2KQ", "avatar_url": "https://avatars.githubusercontent.com/u/91747881?v=4", "gravatar_id": "", "url": "https://api.github.com/users/AleksandrAksenov", "html_url": "https://github.com/AleksandrAksenov", "followers_url": "https://api.github.com/users/AleksandrAksenov/followers", "following_url": "https://api.github.com/users/AleksandrAksenov/following{/other_user}", "gists_url": "https://api.github.com/users/AleksandrAksenov/gists{/gist_id}", "starred_url": "https://api.github.com/users/AleksandrAksenov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/AleksandrAksenov/subscriptions", "organizations_url": "https://api.github.com/users/AleksandrAksenov/orgs", "repos_url": "https://api.github.com/users/AleksandrAksenov/repos", "events_url": "https://api.github.com/users/AleksandrAksenov/events{/privacy}", "received_events_url": "https://api.github.com/users/AleksandrAksenov/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 233785759, "node_id": "MDU6TGFiZWwyMzM3ODU3NTk=", "url": "https://api.github.com/repos/zalando/patroni/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2023-03-16T21:38:07Z", "updated_at": "2023-03-17T15:17:43Z", "closed_at": "2023-03-17T13:32:51Z", "author_association": "NONE", "active_lock_reason": null, "body": "### What happened?\n\nWhen I enable SSL configuration for patroni restapi I get the error:\r\n```\r\nssl.SSLError: [SSL: HTTP_REQUEST] http request (_ssl.c:997)\r\n```\r\nWhen I remove SSL configuration - everything works fine.\r\n\n\n### How can we reproduce it (as minimally and precisely as possible)?\n\n* Install patroni\r\n* Configure with the configuration below on the server\r\n* Start Patroni\r\n* The error appears in 5-10 seconds in logs.\r\n\n\n### What did you expect to happen?\n\nNo error.\n\n### Patroni/PostgreSQL/DCS version\n\n-   Patroni version: patronictl version 3.0.1\r\n-   PostgreSQL version: postgres (PostgreSQL) 14.7 (Ubuntu 14.7-0ubuntu0.22.04.1)\r\n-   DCS (and its version): \r\n```\r\netcd Version: 3.3.25\r\nGit SHA: Not provided (use ./build instead of go build)\r\nGo Version: go1.18.1\r\nGo OS/Arch: linux/amd64\r\n```\r\n\n\n### Patroni configuration file\n\n```yaml\nscope: postgres\r\nnamespace: /db/\r\nname: postgresql0\r\n\r\nrestapi:\r\n    listen: 10.254.0.51:8008\r\n    connect_address: 10.254.0.51:8008\r\n    # allowlist_include_members: true\r\n    certfile: /mnt/patroni/server.crt\r\n    cafile: /mnt/patroni/server.crt\r\n    keyfile: /mnt/patroni/server.key\r\n    ciphers: \"ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES128-GCM-SHA256:!SSLv1:!SSLv2:!SSLv3:!TLSv1:!TLSv1.1\"\r\n    authentication:\r\n      username: user\r\n      password: password\r\n    allowlist:\r\n      - 10.254.0.51/32\r\n      - 10.254.0.52/32\r\n\r\n\r\netcd3:\r\n    host: 10.254.0.53:2379\r\n\r\nbootstrap:\r\n    dcs:\r\n        ttl: 30\r\n        loop_wait: 10\r\n        retry_timeout: 10\r\n        maximum_lag_on_failover: 1048576\r\n        postgresql:\r\n            use_pg_rewind: true\r\n\r\n    initdb:\r\n    - encoding: UTF8\r\n    - data-checksums\r\n\r\n    pg_hba:\r\n    - host replication replicator 127.0.0.1/32 md5\r\n    - host replication replicator 10.254.0.51/32 md5\r\n    - host replication replicator 10.254.0.52/32 md5\r\n    - host all all 0.0.0.0/0 md5\r\n\r\n    users:\r\n        admin:\r\n            password: admin\r\n            options:\r\n                - createrole\r\n                - createdb\r\n\r\npostgresql:\r\n    listen: 10.254.0.51:5432\r\n    connect_address: 10.254.0.51:5432\r\n    data_dir: /mnt/patroni\r\n    pgpass: /tmp/pgpass\r\n    authentication:\r\n        replication:\r\n            username: replicator\r\n            password: password\r\n        superuser:\r\n            username: postgres\r\n            password: password\r\n    parameters:\r\n        ssl: on\r\n        sslmode: verify-ca\r\n        unix_socket_directories: '.'\r\n\r\ntags:\r\n    nofailover: false\r\n    noloadbalance: false\r\n    clonefrom: false\r\n    nosync: false\n```\n\n\n### patronictl show-config\n\n```yaml\nloop_wait: 10\r\nmaximum_lag_on_failover: 1048576\r\npostgresql:\r\n  use_pg_rewind: true\r\nretry_timeout: 10\r\nttl: 30\n```\n\n\n### Patroni log files\n\n```shell\npatroni[129003]: Exception in thread Thread-9 (process_request_thread):\r\npatroni[129003]: Traceback (most recent call last):\r\npatroni[129003]:   File \"/usr/lib/python3.10/threading.py\", line 1016, in _bootstrap_inner\r\npatroni[129003]:     self.run()\r\npatroni[129003]:   File \"/usr/lib/python3.10/threading.py\", line 953, in run\r\npatroni[129003]:     self._target(*self._args, **self._kwargs)\r\npatroni[129003]:   File \"/usr/local/lib/python3.10/dist-packages/patroni/api.py\", line 885, in process_request_thread\r\npatroni[129003]:     request.do_handshake()\r\npatroni[129003]:   File \"/usr/lib/python3.10/ssl.py\", line 1342, in do_handshake\r\npatroni[129003]:     self._sslobj.do_handshake()\r\npatroni[129003]: ssl.SSLError: [SSL: HTTP_REQUEST] http request (_ssl.c:997)\r\npatroni[129003]: 2023-03-16 21:26:36,964 INFO: no action. I am (postgresql0), the leader with the lock\r\npatroni[129003]: Exception in thread Thread-10 (process_request_thread):\r\npatroni[129003]: Traceback (most recent call last):\r\npatroni[129003]:   File \"/usr/lib/python3.10/threading.py\", line 1016, in _bootstrap_inner\r\npatroni[129003]:     self.run()\r\npatroni[129003]:   File \"/usr/lib/python3.10/threading.py\", line 953, in run\r\npatroni[129003]:     self._target(*self._args, **self._kwargs)\r\npatroni[129003]:   File \"/usr/local/lib/python3.10/dist-packages/patroni/api.py\", line 885, in process_request_thread\r\npatroni[129003]:     request.do_handshake()\r\npatroni[129003]:   File \"/usr/lib/python3.10/ssl.py\", line 1342, in do_handshake\r\npatroni[129003]:     self._sslobj.do_handshake()\r\npatroni[129003]: ssl.SSLError: [SSL: HTTP_REQUEST] http request (_ssl.c:997)\r\npatroni[129003]: Exception in thread Thread-11 (process_request_thread):\r\npatroni[129003]: Traceback (most recent call last):\r\npatroni[129003]:   File \"/usr/lib/python3.10/threading.py\", line 1016, in _bootstrap_inner\r\npatroni[129003]:     self.run()\r\npatroni[129003]:   File \"/usr/lib/python3.10/threading.py\", line 953, in run\r\npatroni[129003]:     self._target(*self._args, **self._kwargs)\r\npatroni[129003]:   File \"/usr/local/lib/python3.10/dist-packages/patroni/api.py\", line 885, in process_request_thread\r\npatroni[129003]:     request.do_handshake()\r\npatroni[129003]:   File \"/usr/lib/python3.10/ssl.py\", line 1342, in do_handshake\r\npatroni[129003]:     self._sslobj.do_handshake()\r\npatroni[129003]: ssl.SSLError: [SSL: HTTP_REQUEST] http request (_ssl.c:997)\n```\n\n\n### PostgreSQL log files\n\n```shell\n-\n```\n\n\n### Have you tried to use GitHub issue search?\n\n- [X] Yes\n\n### Anything else we need to know?\n\nServer:\r\n```\r\nDistributor ID:\tUbuntu\r\nDescription:\tUbuntu 22.04.2 LTS\r\nRelease:\t22.04\r\nCodename:\tjammy\r\n```\r\nOpenSSL: `OpenSSL 3.0.2 15 Mar 2022 (Library: OpenSSL 3.0.2 15 Mar 2022)`", "reactions": {"url": "https://api.github.com/repos/zalando/patroni/issues/2601/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/zalando/patroni/issues/2601/timeline", "performed_via_github_app": null, "state_reason": "completed"}, {"url": "https://api.github.com/repos/zalando/patroni/issues/2600", "repository_url": "https://api.github.com/repos/zalando/patroni", "labels_url": "https://api.github.com/repos/zalando/patroni/issues/2600/labels{/name}", "comments_url": "https://api.github.com/repos/zalando/patroni/issues/2600/comments", "events_url": "https://api.github.com/repos/zalando/patroni/issues/2600/events", "html_url": "https://github.com/zalando/patroni/issues/2600", "id": 1625416679, "node_id": "I_kwDOAk8yXs5g4ePn", "number": 2600, "title": "[Question] : What are sequence of checks patroni do before it trigger the failover and enterprise support.", "user": {"login": "t-ushar", "id": 10609304, "node_id": "MDQ6VXNlcjEwNjA5MzA0", "avatar_url": "https://avatars.githubusercontent.com/u/10609304?v=4", "gravatar_id": "", "url": "https://api.github.com/users/t-ushar", "html_url": "https://github.com/t-ushar", "followers_url": "https://api.github.com/users/t-ushar/followers", "following_url": "https://api.github.com/users/t-ushar/following{/other_user}", "gists_url": "https://api.github.com/users/t-ushar/gists{/gist_id}", "starred_url": "https://api.github.com/users/t-ushar/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/t-ushar/subscriptions", "organizations_url": "https://api.github.com/users/t-ushar/orgs", "repos_url": "https://api.github.com/users/t-ushar/repos", "events_url": "https://api.github.com/users/t-ushar/events{/privacy}", "received_events_url": "https://api.github.com/users/t-ushar/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 233785759, "node_id": "MDU6TGFiZWwyMzM3ODU3NTk=", "url": "https://api.github.com/repos/zalando/patroni/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2023-03-15T12:17:38Z", "updated_at": "2023-03-15T12:18:44Z", "closed_at": "2023-03-15T12:18:44Z", "author_association": "NONE", "active_lock_reason": null, "body": "### What happened?\n\nHi Team,\r\n\r\nWe are in a phase to onboard the patroni before that, we want to know the sequence of checks/validation patroni does before it triggers the failover which is categorized as below.\r\n\r\n1. Host level checks. \r\n2. DB level checks.\r\n3. How patroni do health checks of DB clusters, and what are the queries it executes for DB cluster validation?\r\n4. Does zalando provides enterprise support for patroni and enterprise support for ETCD? \r\n\r\nThanks,\r\nTushar Takate.\r\n\r\n\n\n### How can we reproduce it (as minimally and precisely as possible)?\n\nNA\n\n### What did you expect to happen?\n\nNA\n\n### Patroni/PostgreSQL/DCS version\n\n-   Patroni version: \r\n-   PostgreSQL version: \r\n-   DCS (and its version): \r\n\n\n### Patroni configuration file\n\n```yaml\nNA\n```\n\n\n### patronictl show-config\n\n```yaml\nNA\n```\n\n\n### Patroni log files\n\n```shell\nNA\n```\n\n\n### PostgreSQL log files\n\n```shell\nNA\n```\n\n\n### Have you tried to use GitHub issue search?\n\n- [X] Yes\n\n### Anything else we need to know?\n\nNA", "reactions": {"url": "https://api.github.com/repos/zalando/patroni/issues/2600/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/zalando/patroni/issues/2600/timeline", "performed_via_github_app": null, "state_reason": "completed"}, {"url": "https://api.github.com/repos/zalando/patroni/issues/2599", "repository_url": "https://api.github.com/repos/zalando/patroni", "labels_url": "https://api.github.com/repos/zalando/patroni/issues/2599/labels{/name}", "comments_url": "https://api.github.com/repos/zalando/patroni/issues/2599/comments", "events_url": "https://api.github.com/repos/zalando/patroni/issues/2599/events", "html_url": "https://github.com/zalando/patroni/pull/2599", "id": 1622910726, "node_id": "PR_kwDOAk8yXs5L9_jN", "number": 2599, "title": "Use config file as a fallback when all current etcd nodes failed", "user": {"login": "CyberDem0n", "id": 3407345, "node_id": "MDQ6VXNlcjM0MDczNDU=", "avatar_url": "https://avatars.githubusercontent.com/u/3407345?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CyberDem0n", "html_url": "https://github.com/CyberDem0n", "followers_url": "https://api.github.com/users/CyberDem0n/followers", "following_url": "https://api.github.com/users/CyberDem0n/following{/other_user}", "gists_url": "https://api.github.com/users/CyberDem0n/gists{/gist_id}", "starred_url": "https://api.github.com/users/CyberDem0n/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CyberDem0n/subscriptions", "organizations_url": "https://api.github.com/users/CyberDem0n/orgs", "repos_url": "https://api.github.com/users/CyberDem0n/repos", "events_url": "https://api.github.com/users/CyberDem0n/events{/privacy}", "received_events_url": "https://api.github.com/users/CyberDem0n/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 233785759, "node_id": "MDU6TGFiZWwyMzM3ODU3NTk=", "url": "https://api.github.com/repos/zalando/patroni/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": {"url": "https://api.github.com/repos/zalando/patroni/milestones/10", "html_url": "https://github.com/zalando/patroni/milestone/10", "labels_url": "https://api.github.com/repos/zalando/patroni/milestones/10/labels", "id": 9102813, "node_id": "MI_kwDOAk8yXs4AiuXd", "number": 10, "title": "Sprint 2023.04", "description": "01.03.2023-14.03.2023", "creator": {"login": "CyberDem0n", "id": 3407345, "node_id": "MDQ6VXNlcjM0MDczNDU=", "avatar_url": "https://avatars.githubusercontent.com/u/3407345?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CyberDem0n", "html_url": "https://github.com/CyberDem0n", "followers_url": "https://api.github.com/users/CyberDem0n/followers", "following_url": "https://api.github.com/users/CyberDem0n/following{/other_user}", "gists_url": "https://api.github.com/users/CyberDem0n/gists{/gist_id}", "starred_url": "https://api.github.com/users/CyberDem0n/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CyberDem0n/subscriptions", "organizations_url": "https://api.github.com/users/CyberDem0n/orgs", "repos_url": "https://api.github.com/users/CyberDem0n/repos", "events_url": "https://api.github.com/users/CyberDem0n/events{/privacy}", "received_events_url": "https://api.github.com/users/CyberDem0n/received_events", "type": "User", "site_admin": false}, "open_issues": 0, "closed_issues": 20, "state": "closed", "created_at": "2023-03-01T08:08:04Z", "updated_at": "2023-03-15T10:48:53Z", "due_on": "2023-03-14T07:00:00Z", "closed_at": "2023-03-15T10:48:53Z"}, "comments": 3, "created_at": "2023-03-14T07:45:07Z", "updated_at": "2023-03-14T14:54:19Z", "closed_at": "2023-03-14T14:54:18Z", "author_association": "COLLABORATOR", "active_lock_reason": null, "draft": false, "pull_request": {"url": "https://api.github.com/repos/zalando/patroni/pulls/2599", "html_url": "https://github.com/zalando/patroni/pull/2599", "diff_url": "https://github.com/zalando/patroni/pull/2599.diff", "patch_url": "https://github.com/zalando/patroni/pull/2599.patch", "merged_at": "2023-03-14T14:54:18Z"}, "body": "If communication with etcd nodes failed it is logical to start from scratch, from nodes that are listed in the config. But, it could happen that config is in fact outdated and all nodes in the real cluster were replaced.\r\n\r\nPreviously we used to track whether config file was changed, which turned out not to work in all possible cases.\r\nThe new strategy is a bit more different - if communication with all nodes failed we will continue keeping the last know topology and at the same time will try to figure out the new one by merging two lists together, the cached list and the list from the config file.", "reactions": {"url": "https://api.github.com/repos/zalando/patroni/issues/2599/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/zalando/patroni/issues/2599/timeline", "performed_via_github_app": null, "state_reason": null}, {"url": "https://api.github.com/repos/zalando/patroni/issues/2597", "repository_url": "https://api.github.com/repos/zalando/patroni", "labels_url": "https://api.github.com/repos/zalando/patroni/issues/2597/labels{/name}", "comments_url": "https://api.github.com/repos/zalando/patroni/issues/2597/comments", "events_url": "https://api.github.com/repos/zalando/patroni/issues/2597/events", "html_url": "https://github.com/zalando/patroni/pull/2597", "id": 1620859764, "node_id": "PR_kwDOAk8yXs5L3GnP", "number": 2597, "title": "Fix bug with metadata after coordinator failover", "user": {"login": "CyberDem0n", "id": 3407345, "node_id": "MDQ6VXNlcjM0MDczNDU=", "avatar_url": "https://avatars.githubusercontent.com/u/3407345?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CyberDem0n", "html_url": "https://github.com/CyberDem0n", "followers_url": "https://api.github.com/users/CyberDem0n/followers", "following_url": "https://api.github.com/users/CyberDem0n/following{/other_user}", "gists_url": "https://api.github.com/users/CyberDem0n/gists{/gist_id}", "starred_url": "https://api.github.com/users/CyberDem0n/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CyberDem0n/subscriptions", "organizations_url": "https://api.github.com/users/CyberDem0n/orgs", "repos_url": "https://api.github.com/users/CyberDem0n/repos", "events_url": "https://api.github.com/users/CyberDem0n/events{/privacy}", "received_events_url": "https://api.github.com/users/CyberDem0n/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 233785759, "node_id": "MDU6TGFiZWwyMzM3ODU3NTk=", "url": "https://api.github.com/repos/zalando/patroni/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": {"url": "https://api.github.com/repos/zalando/patroni/milestones/10", "html_url": "https://github.com/zalando/patroni/milestone/10", "labels_url": "https://api.github.com/repos/zalando/patroni/milestones/10/labels", "id": 9102813, "node_id": "MI_kwDOAk8yXs4AiuXd", "number": 10, "title": "Sprint 2023.04", "description": "01.03.2023-14.03.2023", "creator": {"login": "CyberDem0n", "id": 3407345, "node_id": "MDQ6VXNlcjM0MDczNDU=", "avatar_url": "https://avatars.githubusercontent.com/u/3407345?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CyberDem0n", "html_url": "https://github.com/CyberDem0n", "followers_url": "https://api.github.com/users/CyberDem0n/followers", "following_url": "https://api.github.com/users/CyberDem0n/following{/other_user}", "gists_url": "https://api.github.com/users/CyberDem0n/gists{/gist_id}", "starred_url": "https://api.github.com/users/CyberDem0n/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CyberDem0n/subscriptions", "organizations_url": "https://api.github.com/users/CyberDem0n/orgs", "repos_url": "https://api.github.com/users/CyberDem0n/repos", "events_url": "https://api.github.com/users/CyberDem0n/events{/privacy}", "received_events_url": "https://api.github.com/users/CyberDem0n/received_events", "type": "User", "site_admin": false}, "open_issues": 0, "closed_issues": 20, "state": "closed", "created_at": "2023-03-01T08:08:04Z", "updated_at": "2023-03-15T10:48:53Z", "due_on": "2023-03-14T07:00:00Z", "closed_at": "2023-03-15T10:48:53Z"}, "comments": 3, "created_at": "2023-03-13T06:55:12Z", "updated_at": "2023-03-13T12:30:51Z", "closed_at": "2023-03-13T12:30:39Z", "author_association": "COLLABORATOR", "active_lock_reason": null, "draft": false, "pull_request": {"url": "https://api.github.com/repos/zalando/patroni/pulls/2597", "html_url": "https://github.com/zalando/patroni/pull/2597", "diff_url": "https://github.com/zalando/patroni/pull/2597.diff", "patch_url": "https://github.com/zalando/patroni/pull/2597.patch", "merged_at": "2023-03-13T12:30:39Z"}, "body": "We made incorrect assumption that `citus_set_coordinator_host()` will trigger `pg_dist_node` sync. Instead we should also use `citus_update_node()` and call `citus_set_coordinator_host()` only during the bootstrap.\r\n\r\nAdjust behave tests to verify that coordinator failover is visible on workers.", "reactions": {"url": "https://api.github.com/repos/zalando/patroni/issues/2597/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/zalando/patroni/issues/2597/timeline", "performed_via_github_app": null, "state_reason": null}, {"url": "https://api.github.com/repos/zalando/patroni/issues/2583", "repository_url": "https://api.github.com/repos/zalando/patroni", "labels_url": "https://api.github.com/repos/zalando/patroni/issues/2583/labels{/name}", "comments_url": "https://api.github.com/repos/zalando/patroni/issues/2583/comments", "events_url": "https://api.github.com/repos/zalando/patroni/issues/2583/events", "html_url": "https://github.com/zalando/patroni/pull/2583", "id": 1608379559, "node_id": "PR_kwDOAk8yXs5LNmRt", "number": 2583, "title": "Don't write to PGDATA if major version is not known", "user": {"login": "CyberDem0n", "id": 3407345, "node_id": "MDQ6VXNlcjM0MDczNDU=", "avatar_url": "https://avatars.githubusercontent.com/u/3407345?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CyberDem0n", "html_url": "https://github.com/CyberDem0n", "followers_url": "https://api.github.com/users/CyberDem0n/followers", "following_url": "https://api.github.com/users/CyberDem0n/following{/other_user}", "gists_url": "https://api.github.com/users/CyberDem0n/gists{/gist_id}", "starred_url": "https://api.github.com/users/CyberDem0n/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CyberDem0n/subscriptions", "organizations_url": "https://api.github.com/users/CyberDem0n/orgs", "repos_url": "https://api.github.com/users/CyberDem0n/repos", "events_url": "https://api.github.com/users/CyberDem0n/events{/privacy}", "received_events_url": "https://api.github.com/users/CyberDem0n/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 233785759, "node_id": "MDU6TGFiZWwyMzM3ODU3NTk=", "url": "https://api.github.com/repos/zalando/patroni/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": {"url": "https://api.github.com/repos/zalando/patroni/milestones/10", "html_url": "https://github.com/zalando/patroni/milestone/10", "labels_url": "https://api.github.com/repos/zalando/patroni/milestones/10/labels", "id": 9102813, "node_id": "MI_kwDOAk8yXs4AiuXd", "number": 10, "title": "Sprint 2023.04", "description": "01.03.2023-14.03.2023", "creator": {"login": "CyberDem0n", "id": 3407345, "node_id": "MDQ6VXNlcjM0MDczNDU=", "avatar_url": "https://avatars.githubusercontent.com/u/3407345?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CyberDem0n", "html_url": "https://github.com/CyberDem0n", "followers_url": "https://api.github.com/users/CyberDem0n/followers", "following_url": "https://api.github.com/users/CyberDem0n/following{/other_user}", "gists_url": "https://api.github.com/users/CyberDem0n/gists{/gist_id}", "starred_url": "https://api.github.com/users/CyberDem0n/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CyberDem0n/subscriptions", "organizations_url": "https://api.github.com/users/CyberDem0n/orgs", "repos_url": "https://api.github.com/users/CyberDem0n/repos", "events_url": "https://api.github.com/users/CyberDem0n/events{/privacy}", "received_events_url": "https://api.github.com/users/CyberDem0n/received_events", "type": "User", "site_admin": false}, "open_issues": 0, "closed_issues": 20, "state": "closed", "created_at": "2023-03-01T08:08:04Z", "updated_at": "2023-03-15T10:48:53Z", "due_on": "2023-03-14T07:00:00Z", "closed_at": "2023-03-15T10:48:53Z"}, "comments": 3, "created_at": "2023-03-03T10:30:14Z", "updated_at": "2023-03-06T15:33:34Z", "closed_at": "2023-03-06T15:33:33Z", "author_association": "COLLABORATOR", "active_lock_reason": null, "draft": false, "pull_request": {"url": "https://api.github.com/repos/zalando/patroni/pulls/2583", "html_url": "https://github.com/zalando/patroni/pull/2583", "diff_url": "https://github.com/zalando/patroni/pull/2583.diff", "patch_url": "https://github.com/zalando/patroni/pull/2583.patch", "merged_at": "2023-03-06T15:33:33Z"}, "body": "It could happen that Patroni is started up before PGDATA was mounted. In this case Patroni can't determine major Postgres version from PG_VERSION file. Later, when PGDATA is mounted, Patroni was trying to create the recovery.conf even if the actual Postgres major version is newver than 12.\r\n\r\nTo mitigate the problem we double check that the `Postgresql._major_version` is set before writing recovery configuration or starting postgres up.\r\n\r\nClose https://github.com/zalando/patroni/issues/2434", "reactions": {"url": "https://api.github.com/repos/zalando/patroni/issues/2583/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/zalando/patroni/issues/2583/timeline", "performed_via_github_app": null, "state_reason": null}, {"url": "https://api.github.com/repos/zalando/patroni/issues/2578", "repository_url": "https://api.github.com/repos/zalando/patroni", "labels_url": "https://api.github.com/repos/zalando/patroni/issues/2578/labels{/name}", "comments_url": "https://api.github.com/repos/zalando/patroni/issues/2578/comments", "events_url": "https://api.github.com/repos/zalando/patroni/issues/2578/events", "html_url": "https://github.com/zalando/patroni/pull/2578", "id": 1605176415, "node_id": "PR_kwDOAk8yXs5LCvC6", "number": 2578, "title": "Don't allow on_reload callback kill other callbacks", "user": {"login": "CyberDem0n", "id": 3407345, "node_id": "MDQ6VXNlcjM0MDczNDU=", "avatar_url": "https://avatars.githubusercontent.com/u/3407345?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CyberDem0n", "html_url": "https://github.com/CyberDem0n", "followers_url": "https://api.github.com/users/CyberDem0n/followers", "following_url": "https://api.github.com/users/CyberDem0n/following{/other_user}", "gists_url": "https://api.github.com/users/CyberDem0n/gists{/gist_id}", "starred_url": "https://api.github.com/users/CyberDem0n/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CyberDem0n/subscriptions", "organizations_url": "https://api.github.com/users/CyberDem0n/orgs", "repos_url": "https://api.github.com/users/CyberDem0n/repos", "events_url": "https://api.github.com/users/CyberDem0n/events{/privacy}", "received_events_url": "https://api.github.com/users/CyberDem0n/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 233785759, "node_id": "MDU6TGFiZWwyMzM3ODU3NTk=", "url": "https://api.github.com/repos/zalando/patroni/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": {"url": "https://api.github.com/repos/zalando/patroni/milestones/10", "html_url": "https://github.com/zalando/patroni/milestone/10", "labels_url": "https://api.github.com/repos/zalando/patroni/milestones/10/labels", "id": 9102813, "node_id": "MI_kwDOAk8yXs4AiuXd", "number": 10, "title": "Sprint 2023.04", "description": "01.03.2023-14.03.2023", "creator": {"login": "CyberDem0n", "id": 3407345, "node_id": "MDQ6VXNlcjM0MDczNDU=", "avatar_url": "https://avatars.githubusercontent.com/u/3407345?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CyberDem0n", "html_url": "https://github.com/CyberDem0n", "followers_url": "https://api.github.com/users/CyberDem0n/followers", "following_url": "https://api.github.com/users/CyberDem0n/following{/other_user}", "gists_url": "https://api.github.com/users/CyberDem0n/gists{/gist_id}", "starred_url": "https://api.github.com/users/CyberDem0n/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CyberDem0n/subscriptions", "organizations_url": "https://api.github.com/users/CyberDem0n/orgs", "repos_url": "https://api.github.com/users/CyberDem0n/repos", "events_url": "https://api.github.com/users/CyberDem0n/events{/privacy}", "received_events_url": "https://api.github.com/users/CyberDem0n/received_events", "type": "User", "site_admin": false}, "open_issues": 0, "closed_issues": 20, "state": "closed", "created_at": "2023-03-01T08:08:04Z", "updated_at": "2023-03-15T10:48:53Z", "due_on": "2023-03-14T07:00:00Z", "closed_at": "2023-03-15T10:48:53Z"}, "comments": 3, "created_at": "2023-03-01T15:22:34Z", "updated_at": "2023-03-06T15:33:05Z", "closed_at": "2023-03-06T15:33:04Z", "author_association": "COLLABORATOR", "active_lock_reason": null, "draft": false, "pull_request": {"url": "https://api.github.com/repos/zalando/patroni/pulls/2578", "html_url": "https://github.com/zalando/patroni/pull/2578", "diff_url": "https://github.com/zalando/patroni/pull/2578.diff", "patch_url": "https://github.com/zalando/patroni/pull/2578.patch", "merged_at": "2023-03-06T15:33:04Z"}, "body": "Since a long time Patroni enforcing only one callback script running at a time. If the new callback is executed while the old one is still running, the old one is killed (including all child processes).\r\n\r\nSuch behavior is fine for all callbacks but on_reload, because the last one may accidentally cancel important ones, that for example updating DNS or assigning/removing Virtual IP.\r\n\r\nTo mitigate the problem we introduce a dedicated executor for on_reload callbacks, so that on_reload may only cancel another on_reload.\r\n\r\nRef: https://github.com/zalando/patroni/issues/2445", "reactions": {"url": "https://api.github.com/repos/zalando/patroni/issues/2578/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/zalando/patroni/issues/2578/timeline", "performed_via_github_app": null, "state_reason": null}, {"url": "https://api.github.com/repos/zalando/patroni/issues/2554", "repository_url": "https://api.github.com/repos/zalando/patroni", "labels_url": "https://api.github.com/repos/zalando/patroni/issues/2554/labels{/name}", "comments_url": "https://api.github.com/repos/zalando/patroni/issues/2554/comments", "events_url": "https://api.github.com/repos/zalando/patroni/issues/2554/events", "html_url": "https://github.com/zalando/patroni/pull/2554", "id": 1575669274, "node_id": "PR_kwDOAk8yXs5JgHFy", "number": 2554, "title": "Pass 'master' role to a callback script instead of 'promoted'", "user": {"login": "hughcapet", "id": 27892524, "node_id": "MDQ6VXNlcjI3ODkyNTI0", "avatar_url": "https://avatars.githubusercontent.com/u/27892524?v=4", "gravatar_id": "", "url": "https://api.github.com/users/hughcapet", "html_url": "https://github.com/hughcapet", "followers_url": "https://api.github.com/users/hughcapet/followers", "following_url": "https://api.github.com/users/hughcapet/following{/other_user}", "gists_url": "https://api.github.com/users/hughcapet/gists{/gist_id}", "starred_url": "https://api.github.com/users/hughcapet/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/hughcapet/subscriptions", "organizations_url": "https://api.github.com/users/hughcapet/orgs", "repos_url": "https://api.github.com/users/hughcapet/repos", "events_url": "https://api.github.com/users/hughcapet/events{/privacy}", "received_events_url": "https://api.github.com/users/hughcapet/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 233785759, "node_id": "MDU6TGFiZWwyMzM3ODU3NTk=", "url": "https://api.github.com/repos/zalando/patroni/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": {"url": "https://api.github.com/repos/zalando/patroni/milestones/8", "html_url": "https://github.com/zalando/patroni/milestone/8", "labels_url": "https://api.github.com/repos/zalando/patroni/milestones/8/labels", "id": 8962051, "node_id": "MI_kwDOAk8yXs4AiMAD", "number": 8, "title": "Sprint 2023.2", "description": "01.02.2023 - 14.02.2023", "creator": {"login": "hughcapet", "id": 27892524, "node_id": "MDQ6VXNlcjI3ODkyNTI0", "avatar_url": "https://avatars.githubusercontent.com/u/27892524?v=4", "gravatar_id": "", "url": "https://api.github.com/users/hughcapet", "html_url": "https://github.com/hughcapet", "followers_url": "https://api.github.com/users/hughcapet/followers", "following_url": "https://api.github.com/users/hughcapet/following{/other_user}", "gists_url": "https://api.github.com/users/hughcapet/gists{/gist_id}", "starred_url": "https://api.github.com/users/hughcapet/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/hughcapet/subscriptions", "organizations_url": "https://api.github.com/users/hughcapet/orgs", "repos_url": "https://api.github.com/users/hughcapet/repos", "events_url": "https://api.github.com/users/hughcapet/events{/privacy}", "received_events_url": "https://api.github.com/users/hughcapet/received_events", "type": "User", "site_admin": false}, "open_issues": 0, "closed_issues": 2, "state": "closed", "created_at": "2023-01-24T21:29:01Z", "updated_at": "2023-02-18T18:01:48Z", "due_on": "2023-02-15T08:00:00Z", "closed_at": "2023-02-18T18:01:48Z"}, "comments": 3, "created_at": "2023-02-08T08:08:38Z", "updated_at": "2023-02-08T13:09:53Z", "closed_at": "2023-02-08T13:09:52Z", "author_association": "MEMBER", "active_lock_reason": null, "draft": false, "pull_request": {"url": "https://api.github.com/repos/zalando/patroni/pulls/2554", "html_url": "https://github.com/zalando/patroni/pull/2554", "diff_url": "https://github.com/zalando/patroni/pull/2554.diff", "patch_url": "https://github.com/zalando/patroni/pull/2554.patch", "merged_at": "2023-02-08T13:09:52Z"}, "body": "Fix the regression introduced in https://github.com/zalando/patroni/pull/2504", "reactions": {"url": "https://api.github.com/repos/zalando/patroni/issues/2554/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/zalando/patroni/issues/2554/timeline", "performed_via_github_app": null, "state_reason": null}, {"url": "https://api.github.com/repos/zalando/patroni/issues/2532", "repository_url": "https://api.github.com/repos/zalando/patroni", "labels_url": "https://api.github.com/repos/zalando/patroni/issues/2532/labels{/name}", "comments_url": "https://api.github.com/repos/zalando/patroni/issues/2532/comments", "events_url": "https://api.github.com/repos/zalando/patroni/issues/2532/events", "html_url": "https://github.com/zalando/patroni/pull/2532", "id": 1548604777, "node_id": "PR_kwDOAk8yXs5IGFff", "number": 2532, "title": "Fixes and improvements in failsafe", "user": {"login": "CyberDem0n", "id": 3407345, "node_id": "MDQ6VXNlcjM0MDczNDU=", "avatar_url": "https://avatars.githubusercontent.com/u/3407345?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CyberDem0n", "html_url": "https://github.com/CyberDem0n", "followers_url": "https://api.github.com/users/CyberDem0n/followers", "following_url": "https://api.github.com/users/CyberDem0n/following{/other_user}", "gists_url": "https://api.github.com/users/CyberDem0n/gists{/gist_id}", "starred_url": "https://api.github.com/users/CyberDem0n/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CyberDem0n/subscriptions", "organizations_url": "https://api.github.com/users/CyberDem0n/orgs", "repos_url": "https://api.github.com/users/CyberDem0n/repos", "events_url": "https://api.github.com/users/CyberDem0n/events{/privacy}", "received_events_url": "https://api.github.com/users/CyberDem0n/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 233785759, "node_id": "MDU6TGFiZWwyMzM3ODU3NTk=", "url": "https://api.github.com/repos/zalando/patroni/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": {"url": "https://api.github.com/repos/zalando/patroni/milestones/7", "html_url": "https://github.com/zalando/patroni/milestone/7", "labels_url": "https://api.github.com/repos/zalando/patroni/milestones/7/labels", "id": 8830693, "node_id": "MI_kwDOAk8yXs4Ahr7l", "number": 7, "title": "v3.0.0", "description": "18.01.2023 - 31.01.2023", "creator": {"login": "hughcapet", "id": 27892524, "node_id": "MDQ6VXNlcjI3ODkyNTI0", "avatar_url": "https://avatars.githubusercontent.com/u/27892524?v=4", "gravatar_id": "", "url": "https://api.github.com/users/hughcapet", "html_url": "https://github.com/hughcapet", "followers_url": "https://api.github.com/users/hughcapet/followers", "following_url": "https://api.github.com/users/hughcapet/following{/other_user}", "gists_url": "https://api.github.com/users/hughcapet/gists{/gist_id}", "starred_url": "https://api.github.com/users/hughcapet/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/hughcapet/subscriptions", "organizations_url": "https://api.github.com/users/hughcapet/orgs", "repos_url": "https://api.github.com/users/hughcapet/repos", "events_url": "https://api.github.com/users/hughcapet/events{/privacy}", "received_events_url": "https://api.github.com/users/hughcapet/received_events", "type": "User", "site_admin": false}, "open_issues": 0, "closed_issues": 14, "state": "closed", "created_at": "2023-01-07T16:44:12Z", "updated_at": "2023-02-27T09:00:03Z", "due_on": "2023-02-01T08:00:00Z", "closed_at": "2023-02-02T18:59:49Z"}, "comments": 3, "created_at": "2023-01-19T06:49:05Z", "updated_at": "2023-01-24T13:07:33Z", "closed_at": "2023-01-24T13:07:32Z", "author_association": "COLLABORATOR", "active_lock_reason": null, "draft": false, "pull_request": {"url": "https://api.github.com/repos/zalando/patroni/pulls/2532", "html_url": "https://github.com/zalando/patroni/pull/2532", "diff_url": "https://github.com/zalando/patroni/pull/2532.diff", "patch_url": "https://github.com/zalando/patroni/pull/2532.patch", "merged_at": "2023-01-24T13:07:32Z"}, "body": "1. Fix problem with logical slots not advancing when only the primary lost access to DCS\r\n2. Don't let Patroni to join as a raft voting member when running failsafe behave tests. It allows to test exactly the same conditions as for other DCS\r\n3. Speed up dcs_failsafe_mode behave tests by getting rid from long sleeps, slight reshuffling of places when we start/stop outage, and by killing Patroni/Postgres to avoid long shutdown due to the leader key removal attempts.", "reactions": {"url": "https://api.github.com/repos/zalando/patroni/issues/2532/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/zalando/patroni/issues/2532/timeline", "performed_via_github_app": null, "state_reason": null}, {"url": "https://api.github.com/repos/zalando/patroni/issues/2528", "repository_url": "https://api.github.com/repos/zalando/patroni", "labels_url": "https://api.github.com/repos/zalando/patroni/issues/2528/labels{/name}", "comments_url": "https://api.github.com/repos/zalando/patroni/issues/2528/comments", "events_url": "https://api.github.com/repos/zalando/patroni/issues/2528/events", "html_url": "https://github.com/zalando/patroni/pull/2528", "id": 1535177758, "node_id": "PR_kwDOAk8yXs5HerYW", "number": 2528, "title": "Submit coverage to codacy only if secret is available", "user": {"login": "CyberDem0n", "id": 3407345, "node_id": "MDQ6VXNlcjM0MDczNDU=", "avatar_url": "https://avatars.githubusercontent.com/u/3407345?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CyberDem0n", "html_url": "https://github.com/CyberDem0n", "followers_url": "https://api.github.com/users/CyberDem0n/followers", "following_url": "https://api.github.com/users/CyberDem0n/following{/other_user}", "gists_url": "https://api.github.com/users/CyberDem0n/gists{/gist_id}", "starred_url": "https://api.github.com/users/CyberDem0n/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CyberDem0n/subscriptions", "organizations_url": "https://api.github.com/users/CyberDem0n/orgs", "repos_url": "https://api.github.com/users/CyberDem0n/repos", "events_url": "https://api.github.com/users/CyberDem0n/events{/privacy}", "received_events_url": "https://api.github.com/users/CyberDem0n/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 233785759, "node_id": "MDU6TGFiZWwyMzM3ODU3NTk=", "url": "https://api.github.com/repos/zalando/patroni/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}, {"id": 4975380544, "node_id": "LA_kwDOAk8yXs8AAAABKI5IQA", "url": "https://api.github.com/repos/zalando/patroni/labels/ci", "name": "ci", "color": "018F5E", "default": false, "description": ""}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": {"url": "https://api.github.com/repos/zalando/patroni/milestones/5", "html_url": "https://github.com/zalando/patroni/milestone/5", "labels_url": "https://api.github.com/repos/zalando/patroni/milestones/5/labels", "id": 8804365, "node_id": "MI_kwDOAk8yXs4AhlgN", "number": 5, "title": "Sprint 2023.0", "description": "", "creator": {"login": "hughcapet", "id": 27892524, "node_id": "MDQ6VXNlcjI3ODkyNTI0", "avatar_url": "https://avatars.githubusercontent.com/u/27892524?v=4", "gravatar_id": "", "url": "https://api.github.com/users/hughcapet", "html_url": "https://github.com/hughcapet", "followers_url": "https://api.github.com/users/hughcapet/followers", "following_url": "https://api.github.com/users/hughcapet/following{/other_user}", "gists_url": "https://api.github.com/users/hughcapet/gists{/gist_id}", "starred_url": "https://api.github.com/users/hughcapet/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/hughcapet/subscriptions", "organizations_url": "https://api.github.com/users/hughcapet/orgs", "repos_url": "https://api.github.com/users/hughcapet/repos", "events_url": "https://api.github.com/users/hughcapet/events{/privacy}", "received_events_url": "https://api.github.com/users/hughcapet/received_events", "type": "User", "site_admin": false}, "open_issues": 0, "closed_issues": 10, "state": "closed", "created_at": "2022-12-29T11:29:56Z", "updated_at": "2023-01-18T18:22:34Z", "due_on": "2023-01-18T08:00:00Z", "closed_at": "2023-01-18T18:22:34Z"}, "comments": 3, "created_at": "2023-01-16T16:13:46Z", "updated_at": "2023-01-17T14:28:41Z", "closed_at": "2023-01-17T14:28:40Z", "author_association": "COLLABORATOR", "active_lock_reason": null, "draft": false, "pull_request": {"url": "https://api.github.com/repos/zalando/patroni/pulls/2528", "html_url": "https://github.com/zalando/patroni/pull/2528", "diff_url": "https://github.com/zalando/patroni/pull/2528.diff", "patch_url": "https://github.com/zalando/patroni/pull/2528.patch", "merged_at": "2023-01-17T14:28:40Z"}, "body": "If PR is open from the external GH repo secrets are not set due to security reasons. It makes codacy coverage report to fail.", "reactions": {"url": "https://api.github.com/repos/zalando/patroni/issues/2528/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/zalando/patroni/issues/2528/timeline", "performed_via_github_app": null, "state_reason": null}, {"url": "https://api.github.com/repos/zalando/patroni/issues/2469", "repository_url": "https://api.github.com/repos/zalando/patroni", "labels_url": "https://api.github.com/repos/zalando/patroni/issues/2469/labels{/name}", "comments_url": "https://api.github.com/repos/zalando/patroni/issues/2469/comments", "events_url": "https://api.github.com/repos/zalando/patroni/issues/2469/events", "html_url": "https://github.com/zalando/patroni/issues/2469", "id": 1469606388, "node_id": "I_kwDOAk8yXs5XmGn0", "number": 2469, "title": "Unhealthy node assigned sync-standby status", "user": {"login": "RajKiranS", "id": 1935195, "node_id": "MDQ6VXNlcjE5MzUxOTU=", "avatar_url": "https://avatars.githubusercontent.com/u/1935195?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RajKiranS", "html_url": "https://github.com/RajKiranS", "followers_url": "https://api.github.com/users/RajKiranS/followers", "following_url": "https://api.github.com/users/RajKiranS/following{/other_user}", "gists_url": "https://api.github.com/users/RajKiranS/gists{/gist_id}", "starred_url": "https://api.github.com/users/RajKiranS/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RajKiranS/subscriptions", "organizations_url": "https://api.github.com/users/RajKiranS/orgs", "repos_url": "https://api.github.com/users/RajKiranS/repos", "events_url": "https://api.github.com/users/RajKiranS/events{/privacy}", "received_events_url": "https://api.github.com/users/RajKiranS/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 233785759, "node_id": "MDU6TGFiZWwyMzM3ODU3NTk=", "url": "https://api.github.com/repos/zalando/patroni/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}, {"id": 4955014615, "node_id": "LA_kwDOAk8yXs8AAAABJ1eF1w", "url": "https://api.github.com/repos/zalando/patroni/labels/good%20first%20issue", "name": "good first issue", "color": "5319e7", "default": true, "description": ""}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": {"url": "https://api.github.com/repos/zalando/patroni/milestones/5", "html_url": "https://github.com/zalando/patroni/milestone/5", "labels_url": "https://api.github.com/repos/zalando/patroni/milestones/5/labels", "id": 8804365, "node_id": "MI_kwDOAk8yXs4AhlgN", "number": 5, "title": "Sprint 2023.0", "description": "", "creator": {"login": "hughcapet", "id": 27892524, "node_id": "MDQ6VXNlcjI3ODkyNTI0", "avatar_url": "https://avatars.githubusercontent.com/u/27892524?v=4", "gravatar_id": "", "url": "https://api.github.com/users/hughcapet", "html_url": "https://github.com/hughcapet", "followers_url": "https://api.github.com/users/hughcapet/followers", "following_url": "https://api.github.com/users/hughcapet/following{/other_user}", "gists_url": "https://api.github.com/users/hughcapet/gists{/gist_id}", "starred_url": "https://api.github.com/users/hughcapet/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/hughcapet/subscriptions", "organizations_url": "https://api.github.com/users/hughcapet/orgs", "repos_url": "https://api.github.com/users/hughcapet/repos", "events_url": "https://api.github.com/users/hughcapet/events{/privacy}", "received_events_url": "https://api.github.com/users/hughcapet/received_events", "type": "User", "site_admin": false}, "open_issues": 0, "closed_issues": 10, "state": "closed", "created_at": "2022-12-29T11:29:56Z", "updated_at": "2023-01-18T18:22:34Z", "due_on": "2023-01-18T08:00:00Z", "closed_at": "2023-01-18T18:22:34Z"}, "comments": 20, "created_at": "2022-11-30T13:04:16Z", "updated_at": "2023-01-10T09:44:19Z", "closed_at": "2023-01-10T09:44:18Z", "author_association": "NONE", "active_lock_reason": null, "body": "Hello,\r\n\r\nYesterday we noticed that Patroni assigned an unhealthy node the sync_standby status and never removed it. Thus, the leader effectively became read-only even though we had disabled `synchronous_mode_strict`.\r\n\r\nIts unhealthy because, the patroni logs does say the same on the unhealthy node. But, it was given `sync_standby` status for some reason. Maybe, some kind of cache poisoning since it indeed was sync_standby few days ago (from looking at the patroni logs it says that its falling back to cached role)?\r\n\r\nHere are the patroni logs on the unhealthy node (app1-01.xyz.foo.com) continuously spewing the same in a loop:\r\n```\r\nNov 29 10:52:15 app1-01.xyz.foo.com patroni-app1[39886]: 2022-11-29 10:52:15,408 INFO: establishing a new patroni connection to the postgres cluster\r\nNov 29 10:52:15 app1-01.xyz.foo.com patroni-app1[39886]: 2022-11-29 10:52:15,409 WARNING: Retry got exception: 'connection problems'\r\nNov 29 10:52:15 app1-01.xyz.foo.com patroni-app1[39886]: 2022-11-29 10:52:15,410 WARNING: Failed to determine PostgreSQL state from the connection, falling back to cached role\r\nNov 29 10:52:15 app1-01.xyz.foo.com patroni-app1[39886]: 2022-11-29 10:52:15,410 INFO: Error communicating with PostgreSQL. Will try again later\r\nNov 29 10:52:24 app1-01.xyz.foo.com patroni-app1[39886]: /tmp:5432 - rejecting connections\r\nNov 29 10:52:24 app1-01.xyz.foo.com patroni-app1[39886]: 2022-11-29 10:52:24,545 INFO: Lock owner: app1-02.xyz.foo.com; I am app1-01.xyz.foo.com\r\nNov 29 10:52:24 app1-01.xyz.foo.com patroni-app1[39886]: 2022-11-29 10:52:24,545 INFO: Still starting up as a standby.\r\nNov 29 10:52:24 app1-01.xyz.foo.com patroni-app1[39886]: 2022-11-29 10:52:24,546 INFO: Lock owner: app1-02.xyz.foo.com; I am app1-01.xyz.foo.com\r\nNov 29 10:52:24 app1-01.xyz.foo.com patroni-app1[39886]: 2022-11-29 10:52:24,546 INFO: establishing a new patroni connection to the postgres cluster\r\nNov 29 10:52:25 app1-01.xyz.foo.com patroni-app1[39886]: 2022-11-29 10:52:25,389 INFO: establishing a new patroni connection to the postgres cluster\r\nNov 29 10:52:25 app1-01.xyz.foo.com patroni-app1[39886]: 2022-11-29 10:52:25,390 WARNING: Retry got exception: 'connection problems'\r\nNov 29 10:52:25 app1-01.xyz.foo.com patroni-app1[39886]: 2022-11-29 10:52:25,390 WARNING: Failed to determine PostgreSQL state from the connection, falling back to cached role\r\nNov 29 10:52:25 app1-01.xyz.foo.com patroni-app1[39886]: 2022-11-29 10:52:25,391 INFO: Error communicating with PostgreSQL. Will try again later\r\n```\r\nHere are the corresponding Patroni logs where patroni assigned that unhealthy node the sync_standby status:\r\n```\r\nNov 29 10:52:24 app1-02.xyz.foo.com patroni-app1[62585]: 2022-11-29 10:52:24,531 INFO: no action. I am (app1-02.xyz.foo.com), the leader with the lock\r\nNov 29 10:52:34 app1-02.xyz.foo.com patroni-app1[62585]: 2022-11-29 10:52:34,523 INFO: Lock owner: app1-02.xyz.foo.com; I am app1-02.xyz.foo.com\r\nNov 29 10:52:34 app1-02.xyz.foo.com patroni-app1[62585]: 2022-11-29 10:52:34,528 INFO: Assigning synchronous standby status to ['app1-01.xyz.foo.com']\r\nNov 29 10:52:34 app1-02.xyz.foo.com patroni-app1[62585]: server signaled\r\nNov 29 10:52:34 app1-02.xyz.foo.com patroni-app1[62585]: Callback trigerred: /local/app1/patroni-callback-handler on_reload master app1\r\nNov 29 10:52:34 app1-02.xyz.foo.com patroni-app1[62585]: Received callback with action:on_reload and role:master on_reload master\r\nNov 29 10:52:34 app1-02.xyz.foo.com patroni-app1[62585]: Nothing to be done for this action(%s) and role(%s). on_reload master\r\nNov 29 10:52:36 app1-02.xyz.foo.com patroni-app1[62585]: 2022-11-29 10:52:36,560 INFO: no action. I am (app1-02.xyz.foo.com), the leader with the lock\r\nNov 29 10:52:44 app1-02.xyz.foo.com patroni-app1[62585]: 2022-11-29 10:52:44,531 INFO: no action. I am (app1-02.xyz.foo.com), the leader with the lock\r\n```\r\nHere are the PostgreSQL logs on the leader node (continuously spewing it):\r\n```\r\n2022-11-29 10:52:34.549 EST [68262] LOG:  received SIGHUP, reloading configuration files\r\n2022-11-29 10:52:34.553 EST [68262] LOG:  parameter \"synchronous_standby_names\" changed to \"\"app1-01.xyz.foo.com\"\"\r\n2022-11-29 10:52:41.894 EST [3726] LOG:  standby \"app1-01.xyz.foo.com\" is now a synchronous standby with priority 1\r\n2022-11-29 10:52:41.894 EST [3726] STATEMENT:  START_REPLICATION SLOT \"app1_01_xyz_foo_com\" 16D/EC000000 TIMELINE 43\r\n2022-11-29 10:52:49.083 EST [3726] LOG:  standby \"app1-01.xyz.foo.com\" is now a synchronous standby with priority 1\r\n2022-11-29 10:52:49.083 EST [3726] STATEMENT:  START_REPLICATION SLOT \"app1_01_xyz_foo_com\" 16D/EC000000 TIMELINE 43\r\n2022-11-29 10:52:56.289 EST [3726] LOG:  standby \"app1-01.xyz.foo.com\" is now a synchronous standby with priority 1\r\n2022-11-29 10:52:56.289 EST [3726] STATEMENT:  START_REPLICATION SLOT \"app1_01_xyz_foo_com\" 16D/EC000000 TIMELINE 43\r\n```\r\nAnd here is how patronictl also says that we do have on unhealthy node indeed:\r\n```\r\n+--------------------------+------------------+---------+----------+----+-----------+\r\n| Member                   | Host             | Role    | State    | TL | Lag in MB |\r\n+ Cluster: app1 (7021873097231237388) --------+---------+----------+----+-----------+\r\n| app1-01.xyz.foo.com | app1-01.xyz.foo.com   | Replica | starting |    |   unknown |\r\n| app1-02.xyz.foo.com | app1-02.xyz.foo.com   | Leader  | running  | 45 |           |\r\n+--------------------------+------------------+---------+----------+----+-----------+\r\n```\r\nHere is the Patroni config in DCS:\r\n```\r\nloop_wait: 10\r\nmaster_start_timeout: 10\r\nmaximum_lag_on_failover: 1048576\r\npostgresql:\r\n  parameters:\r\n    archive_command: exit 0\r\n    archive_mode: 'on'\r\n    hot_standby: true\r\n    max_connections: 200\r\n    max_replication_slots: 5\r\n    max_wal_senders: 5\r\n    max_worker_processes: 20\r\n    wal_keep_segments: 128\r\n    wal_level: hot_standby\r\n    wal_log_hints: true\r\n  recovery_conf:\r\n    restore_command: get-wal-from-barman barman.foo.com app1 %f %p\r\n  use_pg_rewind: true\r\n  use_slots: true\r\nretry_timeout: 10\r\nslots:\r\n  barman:\r\n    type: physical\r\nsynchronous_mode: true\r\nsynchronous_mode_strict: false\r\nttl: 30\r\n```", "reactions": {"url": "https://api.github.com/repos/zalando/patroni/issues/2469/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/zalando/patroni/issues/2469/timeline", "performed_via_github_app": null, "state_reason": "completed"}, {"url": "https://api.github.com/repos/zalando/patroni/issues/2438", "repository_url": "https://api.github.com/repos/zalando/patroni", "labels_url": "https://api.github.com/repos/zalando/patroni/issues/2438/labels{/name}", "comments_url": "https://api.github.com/repos/zalando/patroni/issues/2438/comments", "events_url": "https://api.github.com/repos/zalando/patroni/issues/2438/events", "html_url": "https://github.com/zalando/patroni/issues/2438", "id": 1416587010, "node_id": "I_kwDOAk8yXs5Ub2cC", "number": 2438, "title": "TypeError: '<=' not supported between instances of 'NoneType' and 'NoneType'", "user": {"login": "jopadi", "id": 45459238, "node_id": "MDQ6VXNlcjQ1NDU5MjM4", "avatar_url": "https://avatars.githubusercontent.com/u/45459238?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jopadi", "html_url": "https://github.com/jopadi", "followers_url": "https://api.github.com/users/jopadi/followers", "following_url": "https://api.github.com/users/jopadi/following{/other_user}", "gists_url": "https://api.github.com/users/jopadi/gists{/gist_id}", "starred_url": "https://api.github.com/users/jopadi/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jopadi/subscriptions", "organizations_url": "https://api.github.com/users/jopadi/orgs", "repos_url": "https://api.github.com/users/jopadi/repos", "events_url": "https://api.github.com/users/jopadi/events{/privacy}", "received_events_url": "https://api.github.com/users/jopadi/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 233785759, "node_id": "MDU6TGFiZWwyMzM3ODU3NTk=", "url": "https://api.github.com/repos/zalando/patroni/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2022-10-20T13:03:33Z", "updated_at": "2022-10-24T13:24:37Z", "closed_at": "2022-10-24T13:24:37Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "The error appears after adding 2 new replicas at the same time. \r\n\r\none replica was showing the error  below, but the error is gone after the replica is synced:\r\n\r\n ```\r\n2022-10-20 12:51:02,581 ERROR: Exception when changing replication slots\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.6/dist-packages/patroni/postgresql/slots.py\", line 226, in sync_replication_slots\r\n    self.check_logical_slots_readiness(cluster, nofailover, replicatefrom)\r\n  File \"/usr/local/lib/python3.6/dist-packages/patroni/postgresql/slots.py\", line 278, in check_logical_slots_readiness\r\n    if not value or self._unready_logical_slots[name] <= catalog_xmin <= value['catalog_xmin']:\r\nTypeError: '<=' not supported between instances of 'NoneType' and 'NoneType'\r\n```\r\n\r\none replica is showing an error and is not streaming correctly for a while after showing the previous error only once the replica was synced:\r\n `\r\n2022-10-20 13:06:12,577 WARNING: Physical slot i_04eaab40edb01b3ac does not exist on the primary\r\n`\r\n\r\nenvironment:\r\ninstances: 1 master and 2 replicas\r\ninstance type: i3.2xlarge\r\nPG Version: 13.7\r\n1  replication slot for FES/logical replication\r\n\r\n```\r\n slot_name |  plugin  | slot_type | datoid |       database       | temporary | active | active_pid | xmin | catalog_xmin |  restart_lsn  | confirmed_flush_lsn | wal_status | safe_wal_size\r\n-----------+----------+-----------+--------+----------------------+-----------+--------+------------+------+--------------+---------------+---------------------+------------+---------------\r\n fes       | wal2json | logical   |  16426 | dbname | f         | f      |            |      |   2444389396 | 105A/C6DB88B0 | 105A/C7039FF8       | reserved   |\r\n```\r\n\r\n**patronictl show-config**\r\n```\r\nloop_wait: 10\r\nmaximum_lag_on_failover: 33554432\r\npause: false\r\npostgresql:\r\n  parameters:\r\n    archive_mode: 'on'\r\n    archive_timeout: 1800s\r\n    autovacuum_analyze_scale_factor: 0.02\r\n    autovacuum_max_workers: 5\r\n    autovacuum_vacuum_scale_factor: 0.05\r\n    checkpoint_completion_target: 0.9\r\n    hot_standby: 'on'\r\n    log_autovacuum_min_duration: 0\r\n    log_checkpoints: 'on'\r\n    log_connections: 'on'\r\n    log_disconnections: 'on'\r\n    log_line_prefix: '%t [%p]: [%l-1] %c %x %d %u %a %h '\r\n    log_lock_waits: 'on'\r\n    log_min_duration_statement: 200\r\n    log_statement: ddl\r\n    log_temp_files: 0\r\n    max_connections: 1000\r\n    max_replication_slots: 5\r\n    max_wal_senders: 5\r\n    max_wal_size: 8GB\r\n    tcp_keepalives_idle: 900\r\n    tcp_keepalives_interval: 100\r\n    track_functions: all\r\n    wal_compression: 'on'\r\n    wal_keep_segments: 8\r\n    wal_level: logical\r\n    wal_log_hints: 'on'\r\n  use_pg_rewind: true\r\n  use_slots: true\r\nretry_timeout: 10\r\nslots:\r\n  fes:\r\n    database: dbname\r\n    plugin: wal2json\r\n    type: logical\r\nttl: 30\r\n```\r\n\r\n\r\n", "reactions": {"url": "https://api.github.com/repos/zalando/patroni/issues/2438/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/zalando/patroni/issues/2438/timeline", "performed_via_github_app": null, "state_reason": "completed"}, {"url": "https://api.github.com/repos/zalando/patroni/issues/2397", "repository_url": "https://api.github.com/repos/zalando/patroni", "labels_url": "https://api.github.com/repos/zalando/patroni/issues/2397/labels{/name}", "comments_url": "https://api.github.com/repos/zalando/patroni/issues/2397/comments", "events_url": "https://api.github.com/repos/zalando/patroni/issues/2397/events", "html_url": "https://github.com/zalando/patroni/issues/2397", "id": 1350597414, "node_id": "I_kwDOAk8yXs5QgHsm", "number": 2397, "title": "Accept *:port as a valid entry for postgresql.listen in patroni --validate-config", "user": {"login": "blogh", "id": 16720048, "node_id": "MDQ6VXNlcjE2NzIwMDQ4", "avatar_url": "https://avatars.githubusercontent.com/u/16720048?v=4", "gravatar_id": "", "url": "https://api.github.com/users/blogh", "html_url": "https://github.com/blogh", "followers_url": "https://api.github.com/users/blogh/followers", "following_url": "https://api.github.com/users/blogh/following{/other_user}", "gists_url": "https://api.github.com/users/blogh/gists{/gist_id}", "starred_url": "https://api.github.com/users/blogh/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/blogh/subscriptions", "organizations_url": "https://api.github.com/users/blogh/orgs", "repos_url": "https://api.github.com/users/blogh/repos", "events_url": "https://api.github.com/users/blogh/events{/privacy}", "received_events_url": "https://api.github.com/users/blogh/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 233785759, "node_id": "MDU6TGFiZWwyMzM3ODU3NTk=", "url": "https://api.github.com/repos/zalando/patroni/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2022-08-25T09:20:16Z", "updated_at": "2022-08-26T05:49:28Z", "closed_at": "2022-08-26T05:49:28Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "**Describe the bug**\r\nIf `postgresql.listen` is set to  `*:port`, `patroni --validate-config` complains.\r\nI understand that security wise choosing the interface explicitly is better and that patroni's documentation\r\ndoesn't state that it's possible but it's a valid (and wide spread) postgresql.conf value.\r\n\r\nIf you're ok with allowing this, we can do the PR.\r\n\r\n**To Reproduce**\r\n1 ) configure `postgresql.listen` to `*:5432` in the yaml\r\n2 ) run `patroni --validate-config` on the config file\r\n\r\n**Expected behavior**\r\nNo errors.\r\n\r\n**Screenshots**\r\n```\r\npostgresql.listen *:5432 didn't pass validation: gaierror(-2, 'Name or service not known')\r\n```\r\n\r\n**Environment**\r\n- Patroni version: 2.1.4\r\n- PostgreSQL version: 14.5\r\n- DCS (and its version): 3.4.20\r\n\r\n**Patroni configuration file**\r\n```\r\nscope: pgdemo\r\nname: pg1\r\nbootstrap:\r\n  dcs:\r\n    postgresql:\r\n      parameters:\r\n        cluster_name: pg1\r\n        lc_messages: C\r\n        lc_monetary: C\r\n        lc_numeric: C\r\n        lc_time: C\r\n        listen_addresses: '*'\r\n        log_destination: stderr\r\n        logging_collector: true\r\n        port: 5432\r\n        unix_socket_directories: /run/user/1000/pglift/postgresql\r\n  initdb:\r\n  - locale: C\r\n  - encoding: UTF8\r\n  pg_hba:\r\n  - local   all             postgres                                trust\r\n  - local   all             all                                     trust\r\n  - host    all             all             127.0.0.1/32            trust\r\n  - host    all             all             ::1/128                 trust\r\n  - local   replication     replication                              trust\r\n  - host    replication     replication      127.0.0.1/32            trust\r\n  - host    replication     replication      ::1/128                 trust\r\n  pg_ident:\r\n  - '# MAPNAME       SYSTEM-USERNAME         PG-USERNAME'\r\nrestapi:\r\n  connect_address: 127.0.1.1:8008\r\n  listen: 127.0.1.1:8008\r\netcd3:\r\n  host: 10.20.60.99:2379\r\npostgresql:\r\n  authentication:\r\n    superuser:\r\n      username: postgres\r\n    replication:\r\n      username: replication\r\n    rewind:\r\n      username: postgres\r\n  connect_address: 127.0.1.1:5432\r\n  data_dir: /home/vagrant/.local/share/pglift/srv/pgsql/14/pg1/data\r\n  bin_dir: /usr/pgsql-14/bin\r\n  listen: 127.0.1.1:5432\r\n  use_unix_socket: true\r\n  use_unix_socket_repl: true\r\n  pgpass: /home/vagrant/.pgpass\r\n  parameters:\r\n    cluster_name: pg1\r\n    lc_messages: C\r\n    lc_monetary: C\r\n    lc_numeric: C\r\n    lc_time: C\r\n    listen_addresses: '*'\r\n    log_destination: stderr\r\n    logging_collector: true\r\n    port: 5432\r\n    unix_socket_directories: /run/user/1000/pglift/postgresql\r\n  pg_hba:\r\n  - local   all             postgres                                trust\r\n  - local   all             all                                     trust\r\n  - host    all             all             127.0.0.1/32            trust\r\n  - host    all             all             ::1/128                 trust\r\n  - local   replication     replication                              trust\r\n  - host    replication     replication      127.0.0.1/32            trust\r\n  - host    replication     replication      ::1/128                 trust\r\n  pg_ident:\r\n  - '# MAPNAME       SYSTEM-USERNAME         PG-USERNAME'\r\n```\r\n\r\n**patronictl show-config**\r\n```\r\n(.venv) [vagrant@pat1 pglift]$ patronictl show-config\r\npostgresql:\r\n  parameters:\r\n    cluster_name: pg1\r\n    lc_messages: C\r\n    lc_monetary: C\r\n    lc_numeric: C\r\n    lc_time: C\r\n    listen_addresses: '*'\r\n    log_destination: stderr\r\n    logging_collector: true\r\n    port: 5432\r\n    unix_socket_directories: /run/user/1000/pglift/postgresql\r\n```\r\n\r\n**Have you checked Patroni logs?**\r\nN/A\r\n\r\n**Have you checked PostgreSQL logs?**\r\nN/A\r\n\r\n**Have you tried to use GitHub issue search?**\r\nI didn't find one.\r\n\r\n**Additional context**\r\nN/A", "reactions": {"url": "https://api.github.com/repos/zalando/patroni/issues/2397/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/zalando/patroni/issues/2397/timeline", "performed_via_github_app": null, "state_reason": "completed"}, {"url": "https://api.github.com/repos/zalando/patroni/issues/1175", "repository_url": "https://api.github.com/repos/zalando/patroni", "labels_url": "https://api.github.com/repos/zalando/patroni/issues/1175/labels{/name}", "comments_url": "https://api.github.com/repos/zalando/patroni/issues/1175/comments", "events_url": "https://api.github.com/repos/zalando/patroni/issues/1175/events", "html_url": "https://github.com/zalando/patroni/issues/1175", "id": 492858193, "node_id": "MDU6SXNzdWU0OTI4NTgxOTM=", "number": 1175, "title": "Sending SIGTERM to Postgres causes infinite shutdown", "user": {"login": "sdudoladov", "id": 1516151, "node_id": "MDQ6VXNlcjE1MTYxNTE=", "avatar_url": "https://avatars.githubusercontent.com/u/1516151?v=4", "gravatar_id": "", "url": "https://api.github.com/users/sdudoladov", "html_url": "https://github.com/sdudoladov", "followers_url": "https://api.github.com/users/sdudoladov/followers", "following_url": "https://api.github.com/users/sdudoladov/following{/other_user}", "gists_url": "https://api.github.com/users/sdudoladov/gists{/gist_id}", "starred_url": "https://api.github.com/users/sdudoladov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/sdudoladov/subscriptions", "organizations_url": "https://api.github.com/users/sdudoladov/orgs", "repos_url": "https://api.github.com/users/sdudoladov/repos", "events_url": "https://api.github.com/users/sdudoladov/events{/privacy}", "received_events_url": "https://api.github.com/users/sdudoladov/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 233785759, "node_id": "MDU6TGFiZWwyMzM3ODU3NTk=", "url": "https://api.github.com/repos/zalando/patroni/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 7, "created_at": "2019-09-12T14:53:55Z", "updated_at": "2019-09-16T14:55:28Z", "closed_at": "2019-09-16T14:55:27Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "Sending `SIGTERM` directly to the root postmaster process puts the PG cluster into infinite shutting down state while retaining the leader lock.\r\n\r\nTo reproduce, `kill`  the ` /usr/lib/postgresql/11/bin/postgres -D /home/postgres/pgdata ...` process.\r\n\r\nSample Patroni log:\r\n```\r\nINFO: Lock owner: postgresql0; I am postgresql0\r\nINFO: no action.  i am the leader with the lock\r\nCEST [21150] LOG:  received fast shutdown request\r\nCEST [21150] LOG:  aborting any active transactions\r\nCEST [21162] FATAL:  terminating connection due to administrator command\r\nCEST [21150] LOG:  worker process: logical replication launcher (PID 21160) exited with exit code 1\r\nCEST [21155] LOG:  shutting down\r\nCEST [21150] LOG:  database system is shut down\r\nINFO: Lock owner: postgresql0; I am postgresql0\r\n...\r\n```\r\nin Postgres log \r\n```\r\nFATAL,57P03,\"the database system is shutting down\",,,,,,,,,\"\"\r\nFATAL,57P03,\"the database system is shutting down\",,,,,,,,,\"\"\r\n...\r\n```\r\n\r\n`ps -ef` within a Spilo container after kill\r\n```\r\n...\r\npostgres    74    72  0 Sep10 ?        00:00:02 postgres: acid-test-cluster: logger   \r\npostgres    79    72  0 Sep10 ?        00:00:00 postgres: acid-test-cluster: checkpointer   \r\npostgres    83    72  0 Sep10 ?        00:00:00 postgres: acid-test-cluster: archiver   last was 00000\r\npostgres    84    72  0 Sep10 ?        00:00:01 postgres: acid-test-cluster: stats collector   \r\npostgres    93    72  0 Sep10 ?        00:00:13 postgres: acid-test-cluster: postgres postgres [local] \r\n```\r\nthis last process with `PID` 93 likely prevents [smart shutdown](https://www.postgresql.org/docs/10/server-shutdown.html)", "reactions": {"url": "https://api.github.com/repos/zalando/patroni/issues/1175/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/zalando/patroni/issues/1175/timeline", "performed_via_github_app": null, "state_reason": "completed"}, {"url": "https://api.github.com/repos/zalando/patroni/issues/988", "repository_url": "https://api.github.com/repos/zalando/patroni", "labels_url": "https://api.github.com/repos/zalando/patroni/issues/988/labels{/name}", "comments_url": "https://api.github.com/repos/zalando/patroni/issues/988/comments", "events_url": "https://api.github.com/repos/zalando/patroni/issues/988/events", "html_url": "https://github.com/zalando/patroni/issues/988", "id": 416281247, "node_id": "MDU6SXNzdWU0MTYyODEyNDc=", "number": 988, "title": "Callback executed with wrong arguments when promoted to the standby leader", "user": {"login": "CyberDem0n", "id": 3407345, "node_id": "MDQ6VXNlcjM0MDczNDU=", "avatar_url": "https://avatars.githubusercontent.com/u/3407345?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CyberDem0n", "html_url": "https://github.com/CyberDem0n", "followers_url": "https://api.github.com/users/CyberDem0n/followers", "following_url": "https://api.github.com/users/CyberDem0n/following{/other_user}", "gists_url": "https://api.github.com/users/CyberDem0n/gists{/gist_id}", "starred_url": "https://api.github.com/users/CyberDem0n/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CyberDem0n/subscriptions", "organizations_url": "https://api.github.com/users/CyberDem0n/orgs", "repos_url": "https://api.github.com/users/CyberDem0n/repos", "events_url": "https://api.github.com/users/CyberDem0n/events{/privacy}", "received_events_url": "https://api.github.com/users/CyberDem0n/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 233785759, "node_id": "MDU6TGFiZWwyMzM3ODU3NTk=", "url": "https://api.github.com/repos/zalando/patroni/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}], "state": "closed", "locked": false, "assignee": {"login": "CyberDem0n", "id": 3407345, "node_id": "MDQ6VXNlcjM0MDczNDU=", "avatar_url": "https://avatars.githubusercontent.com/u/3407345?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CyberDem0n", "html_url": "https://github.com/CyberDem0n", "followers_url": "https://api.github.com/users/CyberDem0n/followers", "following_url": "https://api.github.com/users/CyberDem0n/following{/other_user}", "gists_url": "https://api.github.com/users/CyberDem0n/gists{/gist_id}", "starred_url": "https://api.github.com/users/CyberDem0n/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CyberDem0n/subscriptions", "organizations_url": "https://api.github.com/users/CyberDem0n/orgs", "repos_url": "https://api.github.com/users/CyberDem0n/repos", "events_url": "https://api.github.com/users/CyberDem0n/events{/privacy}", "received_events_url": "https://api.github.com/users/CyberDem0n/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "CyberDem0n", "id": 3407345, "node_id": "MDQ6VXNlcjM0MDczNDU=", "avatar_url": "https://avatars.githubusercontent.com/u/3407345?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CyberDem0n", "html_url": "https://github.com/CyberDem0n", "followers_url": "https://api.github.com/users/CyberDem0n/followers", "following_url": "https://api.github.com/users/CyberDem0n/following{/other_user}", "gists_url": "https://api.github.com/users/CyberDem0n/gists{/gist_id}", "starred_url": "https://api.github.com/users/CyberDem0n/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CyberDem0n/subscriptions", "organizations_url": "https://api.github.com/users/CyberDem0n/orgs", "repos_url": "https://api.github.com/users/CyberDem0n/repos", "events_url": "https://api.github.com/users/CyberDem0n/events{/privacy}", "received_events_url": "https://api.github.com/users/CyberDem0n/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 0, "created_at": "2019-03-01T21:12:32Z", "updated_at": "2019-03-29T09:28:08Z", "closed_at": "2019-03-29T09:28:08Z", "author_association": "COLLABORATOR", "active_lock_reason": null, "body": "It happens because the role is explicitly set before calling `follow()`, which resets it back.\r\nThere is also a problem with REST API on standby leader, it still shows itself as a `replica`.", "reactions": {"url": "https://api.github.com/repos/zalando/patroni/issues/988/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/zalando/patroni/issues/988/timeline", "performed_via_github_app": null, "state_reason": "completed"}, {"url": "https://api.github.com/repos/zalando/patroni/issues/853", "repository_url": "https://api.github.com/repos/zalando/patroni", "labels_url": "https://api.github.com/repos/zalando/patroni/issues/853/labels{/name}", "comments_url": "https://api.github.com/repos/zalando/patroni/issues/853/comments", "events_url": "https://api.github.com/repos/zalando/patroni/issues/853/events", "html_url": "https://github.com/zalando/patroni/issues/853", "id": 378022383, "node_id": "MDU6SXNzdWUzNzgwMjIzODM=", "number": 853, "title": "Patroni dies if Consul temporary losts leader", "user": {"login": "Vanav", "id": 761333, "node_id": "MDQ6VXNlcjc2MTMzMw==", "avatar_url": "https://avatars.githubusercontent.com/u/761333?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Vanav", "html_url": "https://github.com/Vanav", "followers_url": "https://api.github.com/users/Vanav/followers", "following_url": "https://api.github.com/users/Vanav/following{/other_user}", "gists_url": "https://api.github.com/users/Vanav/gists{/gist_id}", "starred_url": "https://api.github.com/users/Vanav/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Vanav/subscriptions", "organizations_url": "https://api.github.com/users/Vanav/orgs", "repos_url": "https://api.github.com/users/Vanav/repos", "events_url": "https://api.github.com/users/Vanav/events{/privacy}", "received_events_url": "https://api.github.com/users/Vanav/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 233785759, "node_id": "MDU6TGFiZWwyMzM3ODU3NTk=", "url": "https://api.github.com/repos/zalando/patroni/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2018-11-06T20:35:20Z", "updated_at": "2018-11-21T11:51:53Z", "closed_at": "2018-11-21T11:51:53Z", "author_association": "NONE", "active_lock_reason": null, "body": "I run Patroni 1.5.0 (slave) and Consul client on a same server. If a server temporary got split-brain and Consul client lost leader (so it can't process API requests), Patroni dies after some tries (process exit). Shouldn't Patroni just infinitely keep trying to connect to Consul?\r\n\r\nPatroni log:\r\n```\r\n2018-11-06 23:06:17,073 INFO: Lock owner: db1; I am db1reserve\r\n2018-11-06 23:06:17,074 INFO: does not have lock\r\n2018-11-06 23:06:17,095 INFO: no action.  i am a secondary and i am following a leader\r\n2018-11-06 23:06:27,497 ERROR: watch\r\nTraceback (most recent call last):\r\nFile \"/usr/lib/python3.4/site-packages/urllib3/connectionpool.py\", line 384, in _make_request\r\nsix.raise_from(e, None)\r\nFile \"<string>\", line 2, in raise_from\r\nFile \"/usr/lib/python3.4/site-packages/urllib3/connectionpool.py\", line 380, in _make_request\r\nhttplib_response = conn.getresponse()\r\nFile \"/usr/lib64/python3.4/http/client.py\", line 1227, in getresponse\r\nresponse.begin()\r\nFile \"/usr/lib64/python3.4/http/client.py\", line 386, in begin\r\nversion, status, reason = self._read_status()\r\nFile \"/usr/lib64/python3.4/http/client.py\", line 348, in _read_status\r\nline = str(self.fp.readline(_MAXLINE + 1), \"iso-8859-1\")\r\nFile \"/usr/lib64/python3.4/socket.py\", line 378, in readinto\r\nreturn self._sock.recv_into(b)\r\nsocket.timeout: timed out\r\nDuring handling of the above exception, another exception occurred:\r\nTraceback (most recent call last):\r\nFile \"/usr/lib/python3.4/site-packages/urllib3/connectionpool.py\", line 600, in urlopen\r\nchunked=chunked)\r\nFile \"/usr/lib/python3.4/site-packages/urllib3/connectionpool.py\", line 386, in _make_request\r\nself._raise_timeout(err=e, url=url, timeout_value=read_timeout)\r\nFile \"/usr/lib/python3.4/site-packages/urllib3/connectionpool.py\", line 306, in _raise_timeout\r\nraise ReadTimeoutError(self, url, \"Read timed out. (read timeout=%s)\" % timeout_value)\r\nurllib3.exceptions.ReadTimeoutError: HTTPConnectionPool(host='localhost', port=8500): Read timed out. (read timeout=10.388829231262207)\r\nDuring handling of the above exception, another exception occurred:\r\nTraceback (most recent call last):\r\nFile \"/usr/lib/python3.4/site-packages/patroni/dcs/consul.py\", line 494, in watch\r\nidx, _ = self._client.kv.get(self.leader_path, index=leader_index, wait=str(timeout) + 's')\r\nFile \"/usr/lib/python3.4/site-packages/consul/base.py\", line 554, in get\r\nparams=params)\r\nFile \"/usr/lib/python3.4/site-packages/patroni/dcs/consul.py\", line 105, in wrapper\r\nreturn callback(self.response(self.http.request(method.upper(), self.uri(path, params), **kwargs)))\r\nFile \"/usr/lib/python3.4/site-packages/urllib3/request.py\", line 68, in request\r\n**urlopen_kw)\r\nFile \"/usr/lib/python3.4/site-packages/urllib3/request.py\", line 89, in request_encode_url\r\nreturn self.urlopen(method, url, **extra_kw)\r\nFile \"/usr/lib/python3.4/site-packages/urllib3/poolmanager.py\", line 322, in urlopen\r\nresponse = conn.urlopen(method, u.request_uri, **kw)\r\nFile \"/usr/lib/python3.4/site-packages/urllib3/connectionpool.py\", line 638, in urlopen\r\n_stacktrace=sys.exc_info()[2])\r\nFile \"/usr/lib/python3.4/site-packages/urllib3/util/retry.py\", line 398, in increment\r\nraise MaxRetryError(_pool, url, error or ResponseError(cause))\r\nurllib3.exceptions.MaxRetryError: HTTPConnectionPool(host='localhost', port=8500): Max retries exceeded with url: /v1/kv/patroni/dbcluster/leader?wait=9.388829231262207s&index=22078692 (Caused by ReadTimeoutError(\"HTTPConnectionPool(host='localhost', port=8500): Read timed out. (read timeout=10.388829231262207)\",))\r\n2018-11-06 23:06:39,312 INFO: Lock owner: db1; I am db1reserve\r\n2018-11-06 23:06:39,315 INFO: does not have lock\r\n2018-11-06 23:07:46,569 ERROR: refresh_session\r\nTraceback (most recent call last):\r\nFile \"/usr/lib/python3.4/site-packages/patroni/utils.py\", line 254, in __call__\r\nreturn func(*args, **kwargs)\r\nFile \"/usr/lib/python3.4/site-packages/patroni/dcs/consul.py\", line 249, in _do_refresh_session\r\nself._client.session.renew(self._session)\r\nFile \"/usr/lib/python3.4/site-packages/consul/base.py\", line 1913, in renew\r\nparams=params)\r\nFile \"/usr/lib/python3.4/site-packages/patroni/dcs/consul.py\", line 105, in wrapper\r\nreturn callback(self.response(self.http.request(method.upper(), self.uri(path, params), **kwargs)))\r\nFile \"/usr/lib/python3.4/site-packages/patroni/dcs/consul.py\", line 76, in response\r\nraise ConsulInternalError(msg)\r\npatroni.dcs.consul.ConsulInternalError: 500 rpc error getting client: failed to get conn: dial tcp <nil>->192.168.241.12:8300: i/o timeout\r\nDuring handling of the above exception, another exception occurred:\r\nTraceback (most recent call last):\r\nFile \"/usr/lib/python3.4/site-packages/patroni/dcs/consul.py\", line 268, in refresh_session\r\nreturn self.retry(self._do_refresh_session)\r\nFile \"/usr/lib/python3.4/site-packages/patroni/dcs/consul.py\", line 214, in retry\r\nreturn self._retry.copy()(*args, **kwargs)\r\nFile \"/usr/lib/python3.4/site-packages/patroni/utils.py\", line 263, in __call__\r\nraise RetryFailedError(\"Exceeded retry deadline\")\r\npatroni.utils.RetryFailedError: 'Exceeded retry deadline'\r\n2018-11-06 23:07:49,542 INFO: Lock owner: db1; I am db1reserve\r\n2018-11-06 23:08:56,082 ERROR: refresh_session\r\nTraceback (most recent call last):\r\nFile \"/usr/lib/python3.4/site-packages/patroni/__init__.py\", line 149, in patroni_main\r\npatroni.run()\r\nFile \"/usr/lib/python3.4/site-packages/patroni/__init__.py\", line 114, in run\r\nlogger.info(self.ha.run_cycle())\r\nFile \"/usr/lib/python3.4/site-packages/patroni/ha.py\", line 1236, in run_cycle\r\ninfo = self._run_cycle()\r\nFile \"/usr/lib/python3.4/site-packages/patroni/ha.py\", line 1232, in _run_cycle\r\nself.touch_member()\r\nFile \"/usr/lib/python3.4/site-packages/patroni/ha.py\", line 178, in touch_member\r\nreturn self.dcs.touch_member(data)\r\nFile \"/usr/lib/python3.4/site-packages/patroni/dcs/consul.py\", line 344, in touch_member\r\ncreate_member = not permanent and self.refresh_session()\r\nFile \"/usr/lib/python3.4/site-packages/patroni/dcs/consul.py\", line 271, in refresh_session\r\nraise ConsulError('Failed to renew/create session')\r\npatroni.dcs.consul.ConsulError: 'Failed to renew/create session'\r\nDuring handling of the above exception, another exception occurred:\r\nTraceback (most recent call last):\r\nFile \"/usr/lib/python3.4/site-packages/patroni/utils.py\", line 254, in __call__\r\nreturn func(*args, **kwargs)\r\nFile \"/usr/lib/python3.4/site-packages/patroni/dcs/consul.py\", line 249, in _do_refresh_session\r\nself._client.session.renew(self._session)\r\nFile \"/usr/lib/python3.4/site-packages/consul/base.py\", line 1913, in renew\r\nparams=params)\r\nFile \"/usr/lib/python3.4/site-packages/patroni/dcs/consul.py\", line 105, in wrapper\r\nreturn callback(self.response(self.http.request(method.upper(), self.uri(path, params), **kwargs)))\r\nFile \"/usr/lib/python3.4/site-packages/patroni/dcs/consul.py\", line 76, in response\r\nraise ConsulInternalError(msg)\r\npatroni.dcs.consul.ConsulInternalError: 500 rpc error getting client: failed to get conn: dial tcp <nil>->192.168.241.12:8300: i/o timeout\r\nDuring handling of the above exception, another exception occurred:\r\nTraceback (most recent call last):\r\nFile \"/usr/lib/python3.4/site-packages/patroni/dcs/consul.py\", line 268, in refresh_session\r\nreturn self.retry(self._do_refresh_session)\r\nFile \"/usr/lib/python3.4/site-packages/patroni/dcs/consul.py\", line 214, in retry\r\nreturn self._retry.copy()(*args, **kwargs)\r\nFile \"/usr/lib/python3.4/site-packages/patroni/utils.py\", line 263, in __call__\r\nraise RetryFailedError(\"Exceeded retry deadline\")\r\npatroni.utils.RetryFailedError: 'Exceeded retry deadline'\r\n----------------------------------------\r\nException happened during processing of request from ('192.168.242.11', 53742)\r\n----------------------------------------\r\n----------------------------------------\r\nException happened during processing of request from ('192.168.242.11', 51610)\r\n----------------------------------------\r\n----------------------------------------\r\nException happened during processing of request from ('192.168.242.11', 51612)\r\n----------------------------------------\r\n----------------------------------------\r\nException happened during processing of request from ('192.168.242.11', 39238)\r\n----------------------------------------\r\n----------------------------------------\r\nException happened during processing of request from ('192.168.242.11', 39242)\r\n----------------------------------------\r\n----------------------------------------\r\nException happened during processing of request from ('192.168.242.11', 39240)\r\n----------------------------------------\r\nTraceback (most recent call last):\r\nFile \"/usr/lib/python3.4/site-packages/patroni/__init__.py\", line 149, in patroni_main\r\npatroni.run()\r\nFile \"/usr/lib/python3.4/site-packages/patroni/__init__.py\", line 114, in run\r\nlogger.info(self.ha.run_cycle())\r\nFile \"/usr/lib/python3.4/site-packages/patroni/ha.py\", line 1236, in run_cycle\r\ninfo = self._run_cycle()\r\nFile \"/usr/lib/python3.4/site-packages/patroni/ha.py\", line 1232, in _run_cycle\r\nself.touch_member()\r\nFile \"/usr/lib/python3.4/site-packages/patroni/ha.py\", line 178, in touch_member\r\nreturn self.dcs.touch_member(data)\r\nFile \"/usr/lib/python3.4/site-packages/patroni/dcs/consul.py\", line 344, in touch_member\r\ncreate_member = not permanent and self.refresh_session()\r\nFile \"/usr/lib/python3.4/site-packages/patroni/dcs/consul.py\", line 271, in refresh_session\r\nraise ConsulError('Failed to renew/create session')\r\npatroni.dcs.consul.ConsulError: 'Failed to renew/create session'\r\nDuring handling of the above exception, another exception occurred:\r\nTraceback (most recent call last):\r\nFile \"/usr/bin/patroni\", line 11, in <module>\r\nsys.exit(main())\r\nFile \"/usr/lib/python3.4/site-packages/patroni/__init__.py\", line 182, in main\r\nreturn patroni_main()\r\nFile \"/usr/lib/python3.4/site-packages/patroni/__init__.py\", line 153, in patroni_main\r\npatroni.shutdown()\r\nFile \"/usr/lib/python3.4/site-packages/patroni/__init__.py\", line 137, in shutdown\r\nself.ha.shutdown()\r\nFile \"/usr/lib/python3.4/site-packages/patroni/ha.py\", line 1253, in shutdown\r\nself.touch_member()\r\nFile \"/usr/lib/python3.4/site-packages/patroni/ha.py\", line 178, in touch_member\r\nreturn self.dcs.touch_member(data)\r\nFile \"/usr/lib/python3.4/site-packages/patroni/dcs/consul.py\", line 344, in touch_member\r\ncreate_member = not permanent and self.refresh_session()\r\nFile \"/usr/lib/python3.4/site-packages/patroni/dcs/consul.py\", line 271, in refresh_session\r\nraise ConsulError('Failed to renew/create session')\r\npatroni.dcs.consul.ConsulError: 'Failed to renew/create session'\r\n```\r\n\u2191 Patroni dies here.\r\n\r\n```\r\n# systemctl status patroni\r\n\u25cf patroni.service - Runners to orchestrate a high-availability PostgreSQL\r\n   Loaded: loaded (/etc/systemd/system/patroni.service; enabled; vendor preset: disabled)\r\n   Active: failed (Result: exit-code) since Tue 2018-11-06 23:08:56 MSK; 23min ago\r\n  Process: 28887 ExecReload=/bin/kill -HUP $MAINPID (code=exited, status=0/SUCCESS)\r\n  Process: 30554 ExecStart=/usr/bin/patroni /etc/patroni/patroni.yml (code=exited, status=1/FAILURE)\r\n Main PID: 30554 (code=exited, status=1/FAILURE)\r\n\r\nNov 06 23:08:56 db1reserve patroni[30554]: File \"/usr/lib/python3.4/site-packages/patroni/ha.py\", line 178, in touch_member\r\nNov 06 23:08:56 db1reserve patroni[30554]: return self.dcs.touch_member(data)\r\nNov 06 23:08:56 db1reserve patroni[30554]: File \"/usr/lib/python3.4/site-packages/patroni/dcs/consul.py\", line 344, in touch_member\r\nNov 06 23:08:56 db1reserve patroni[30554]: create_member = not permanent and self.refresh_session()\r\nNov 06 23:08:56 db1reserve patroni[30554]: File \"/usr/lib/python3.4/site-packages/patroni/dcs/consul.py\", line 271, in refresh_session\r\nNov 06 23:08:56 db1reserve patroni[30554]: raise ConsulError('Failed to renew/create session')\r\nNov 06 23:08:56 db1reserve patroni[30554]: patroni.dcs.consul.ConsulError: 'Failed to renew/create session'\r\nNov 06 23:08:56 db1reserve systemd[1]: patroni.service: main process exited, code=exited, status=1/FAILURE\r\nNov 06 23:08:56 db1reserve systemd[1]: Unit patroni.service entered failed state.\r\nNov 06 23:08:56 db1reserve systemd[1]: patroni.service failed.\r\n```", "reactions": {"url": "https://api.github.com/repos/zalando/patroni/issues/853/reactions", "total_count": 1, "+1": 1, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/zalando/patroni/issues/853/timeline", "performed_via_github_app": null, "state_reason": "completed"}, {"url": "https://api.github.com/repos/zalando/patroni/issues/750", "repository_url": "https://api.github.com/repos/zalando/patroni", "labels_url": "https://api.github.com/repos/zalando/patroni/issues/750/labels{/name}", "comments_url": "https://api.github.com/repos/zalando/patroni/issues/750/comments", "events_url": "https://api.github.com/repos/zalando/patroni/issues/750/events", "html_url": "https://github.com/zalando/patroni/issues/750", "id": 343720547, "node_id": "MDU6SXNzdWUzNDM3MjA1NDc=", "number": 750, "title": "python3.7: \"async\" is a keyword now", "user": {"login": "df7cb", "id": 1021828, "node_id": "MDQ6VXNlcjEwMjE4Mjg=", "avatar_url": "https://avatars.githubusercontent.com/u/1021828?v=4", "gravatar_id": "", "url": "https://api.github.com/users/df7cb", "html_url": "https://github.com/df7cb", "followers_url": "https://api.github.com/users/df7cb/followers", "following_url": "https://api.github.com/users/df7cb/following{/other_user}", "gists_url": "https://api.github.com/users/df7cb/gists{/gist_id}", "starred_url": "https://api.github.com/users/df7cb/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/df7cb/subscriptions", "organizations_url": "https://api.github.com/users/df7cb/orgs", "repos_url": "https://api.github.com/users/df7cb/repos", "events_url": "https://api.github.com/users/df7cb/events{/privacy}", "received_events_url": "https://api.github.com/users/df7cb/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 233785759, "node_id": "MDU6TGFiZWwyMzM3ODU3NTk=", "url": "https://api.github.com/repos/zalando/patroni/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 6, "created_at": "2018-07-23T17:14:40Z", "updated_at": "2018-07-23T18:47:12Z", "closed_at": "2018-07-23T18:42:33Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "Installing patroni with python3.7 fails: (https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=904369)\r\n```\r\npatroni (1.4.4-2) wird eingerichtet ...\r\n  File \"/usr/lib/python3/dist-packages/patroni/ha.py\", line 610\r\n    'offline':          dict(stop='fast', checkpoint=False, release=False, offline=True, async=False),\r\n                                                                                             ^\r\nSyntaxError: invalid syntax\r\n```\r\nThe problem exists also in python3-kubernetes where the parameter was renamed from \"async\" to \"async_req\" in 7.0.0a1: https://github.com/kubernetes-client/python/blob/master/CHANGELOG.md\r\n\r\nA new release with a fix would be appreciated so we can update the Debian package. Thanks!", "reactions": {"url": "https://api.github.com/repos/zalando/patroni/issues/750/reactions", "total_count": 1, "+1": 1, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/zalando/patroni/issues/750/timeline", "performed_via_github_app": null, "state_reason": "completed"}, {"url": "https://api.github.com/repos/zalando/patroni/issues/694", "repository_url": "https://api.github.com/repos/zalando/patroni", "labels_url": "https://api.github.com/repos/zalando/patroni/issues/694/labels{/name}", "comments_url": "https://api.github.com/repos/zalando/patroni/issues/694/comments", "events_url": "https://api.github.com/repos/zalando/patroni/issues/694/events", "html_url": "https://github.com/zalando/patroni/issues/694", "id": 329637907, "node_id": "MDU6SXNzdWUzMjk2Mzc5MDc=", "number": 694, "title": "Fails with error on start", "user": {"login": "beccon4", "id": 12436716, "node_id": "MDQ6VXNlcjEyNDM2NzE2", "avatar_url": "https://avatars.githubusercontent.com/u/12436716?v=4", "gravatar_id": "", "url": "https://api.github.com/users/beccon4", "html_url": "https://github.com/beccon4", "followers_url": "https://api.github.com/users/beccon4/followers", "following_url": "https://api.github.com/users/beccon4/following{/other_user}", "gists_url": "https://api.github.com/users/beccon4/gists{/gist_id}", "starred_url": "https://api.github.com/users/beccon4/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/beccon4/subscriptions", "organizations_url": "https://api.github.com/users/beccon4/orgs", "repos_url": "https://api.github.com/users/beccon4/repos", "events_url": "https://api.github.com/users/beccon4/events{/privacy}", "received_events_url": "https://api.github.com/users/beccon4/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 233785759, "node_id": "MDU6TGFiZWwyMzM3ODU3NTk=", "url": "https://api.github.com/repos/zalando/patroni/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2018-06-05T21:49:53Z", "updated_at": "2018-06-12T12:08:39Z", "closed_at": "2018-06-12T12:08:39Z", "author_association": "NONE", "active_lock_reason": null, "body": "Patroni terminates with the following error messages on startup:\r\n\r\n 2018-06-05 21:41:41,692 INFO: Selected new etcd server http://192.168.221.45:2379\r\nTraceback (most recent call last):\r\n  File \"/usr/local/bin/patroni\", line 11, in <module>\r\n    sys.exit(main())\r\n  File \"/usr/local/lib/python2.7/dist-packages/patroni/__init__.py\", line 176, in main\r\n    return patroni_main()\r\n  File \"/usr/local/lib/python2.7/dist-packages/patroni/__init__.py\", line 143, in patroni_main\r\n    patroni = Patroni()\r\n  File \"/usr/local/lib/python2.7/dist-packages/patroni/__init__.py\", line 30, in __init__\r\n    self.api = RestApiServer(self, self.config['restapi'])\r\n  File \"/usr/local/lib/python2.7/dist-packages/patroni/api.py\", line 476, in __init__\r\n    self.__initialize(config)\r\n  File \"/usr/local/lib/python2.7/dist-packages/patroni/api.py\", line 520, in __initialize\r\n    host, port = config['listen'].rsplit(':', 1)\r\nValueError: need more than 1 value to unpack\r\n\r\nI have the following setup:\r\n\r\n- Fresh Ubuntu 18.04 (running in LXD containers)\r\n- stock postgreSQL\r\n- followed the instructions on [linode.com:](https://www.linode.com/docs/databases/postgresql/create-a-highly-available-postgresql-cluster-using-patroni-and-haproxy/)\r\n\r\nPS: I had a version conflict warning in this setup: \r\n\r\n/usr/local/lib/python2.7/dist-packages/requests/__init__.py:80: RequestsDependencyWarning: urllib3 (1.23) or chardet (3.0.4) doesn't match a supported version!\r\n\r\nwhich I've found a work around for:\r\n\r\npip uninstall requests\r\npip install requests\r\npip uninstall docopt\r\npip install docopt\r\n\r\nSource: [here](https://medium.com/@gloriapalmagonzalez/urllib3-1-22-or-chardet-2-2-1-doesnt-match-a-supported-version-requestsdependencywarning-97c36e0cb561)\r\n\r\nNo effect on the above error though", "reactions": {"url": "https://api.github.com/repos/zalando/patroni/issues/694/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/zalando/patroni/issues/694/timeline", "performed_via_github_app": null, "state_reason": "completed"}, {"url": "https://api.github.com/repos/zalando/patroni/issues/693", "repository_url": "https://api.github.com/repos/zalando/patroni", "labels_url": "https://api.github.com/repos/zalando/patroni/issues/693/labels{/name}", "comments_url": "https://api.github.com/repos/zalando/patroni/issues/693/comments", "events_url": "https://api.github.com/repos/zalando/patroni/issues/693/events", "html_url": "https://github.com/zalando/patroni/issues/693", "id": 329592859, "node_id": "MDU6SXNzdWUzMjk1OTI4NTk=", "number": 693, "title": "After upgrading patroni to 1.4.4 getting error ContextualVersionConflict on starting patroni", "user": {"login": "debraj-manna", "id": 8141860, "node_id": "MDQ6VXNlcjgxNDE4NjA=", "avatar_url": "https://avatars.githubusercontent.com/u/8141860?v=4", "gravatar_id": "", "url": "https://api.github.com/users/debraj-manna", "html_url": "https://github.com/debraj-manna", "followers_url": "https://api.github.com/users/debraj-manna/followers", "following_url": "https://api.github.com/users/debraj-manna/following{/other_user}", "gists_url": "https://api.github.com/users/debraj-manna/gists{/gist_id}", "starred_url": "https://api.github.com/users/debraj-manna/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/debraj-manna/subscriptions", "organizations_url": "https://api.github.com/users/debraj-manna/orgs", "repos_url": "https://api.github.com/users/debraj-manna/repos", "events_url": "https://api.github.com/users/debraj-manna/events{/privacy}", "received_events_url": "https://api.github.com/users/debraj-manna/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 233785759, "node_id": "MDU6TGFiZWwyMzM3ODU3NTk=", "url": "https://api.github.com/repos/zalando/patroni/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 9, "created_at": "2018-06-05T19:26:00Z", "updated_at": "2018-06-13T06:23:06Z", "closed_at": "2018-06-12T21:03:33Z", "author_association": "NONE", "active_lock_reason": null, "body": "I am trying to upgrade patroni to 1.4.4 from 1.3.6. After upgrade and starting patroni I was seeing the below error\r\n\r\n```\r\nTraceback (most recent call last):\r\n  File \"/usr/local/bin/patroni\", line 6, in <module>\r\n    from pkg_resources import load_entry_point\r\n  File \"/usr/local/lib/python2.7/dist-packages/pkg_resources/__init__.py\", line 3037, in <module>\r\n    @_call_aside\r\n  File \"/usr/local/lib/python2.7/dist-packages/pkg_resources/__init__.py\", line 3021, in _call_aside\r\n    f(*args, **kwargs)\r\n  File \"/usr/local/lib/python2.7/dist-packages/pkg_resources/__init__.py\", line 3050, in _initialize_master_working_set\r\n    working_set = WorkingSet._build_master()\r\n  File \"/usr/local/lib/python2.7/dist-packages/pkg_resources/__init__.py\", line 657, in _build_master\r\n    return cls._build_from_requirements(__requires__)\r\n  File \"/usr/local/lib/python2.7/dist-packages/pkg_resources/__init__.py\", line 670, in _build_from_requirements\r\n    dists = ws.resolve(reqs, Environment())\r\n  File \"/usr/local/lib/python2.7/dist-packages/pkg_resources/__init__.py\", line 860, in resolve\r\n    raise VersionConflict(dist, req).with_context(dependent_req)\r\npkg_resources.ContextualVersionConflict: (urllib3 1.23 (/usr/local/lib/python2.7/dist-packages), Requirement.parse('urllib3<1.23,>=1.21.1'), set(['requests']))\r\n```\r\nTo get around this I have to to the following\r\n\r\n```\r\nsudo pip uninstall urllib3\r\nsudo pip install urllib3==1.22\r\n```\r\n\r\nIs this expected?", "reactions": {"url": "https://api.github.com/repos/zalando/patroni/issues/693/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/zalando/patroni/issues/693/timeline", "performed_via_github_app": null, "state_reason": "completed"}, {"url": "https://api.github.com/repos/zalando/patroni/issues/674", "repository_url": "https://api.github.com/repos/zalando/patroni", "labels_url": "https://api.github.com/repos/zalando/patroni/issues/674/labels{/name}", "comments_url": "https://api.github.com/repos/zalando/patroni/issues/674/comments", "events_url": "https://api.github.com/repos/zalando/patroni/issues/674/events", "html_url": "https://github.com/zalando/patroni/issues/674", "id": 321482859, "node_id": "MDU6SXNzdWUzMjE0ODI4NTk=", "number": 674, "title": "Schedule load_replication_slots when postgres is restarted during pause", "user": {"login": "ants", "id": 64938, "node_id": "MDQ6VXNlcjY0OTM4", "avatar_url": "https://avatars.githubusercontent.com/u/64938?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ants", "html_url": "https://github.com/ants", "followers_url": "https://api.github.com/users/ants/followers", "following_url": "https://api.github.com/users/ants/following{/other_user}", "gists_url": "https://api.github.com/users/ants/gists{/gist_id}", "starred_url": "https://api.github.com/users/ants/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ants/subscriptions", "organizations_url": "https://api.github.com/users/ants/orgs", "repos_url": "https://api.github.com/users/ants/repos", "events_url": "https://api.github.com/users/ants/events{/privacy}", "received_events_url": "https://api.github.com/users/ants/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 233785759, "node_id": "MDU6TGFiZWwyMzM3ODU3NTk=", "url": "https://api.github.com/repos/zalando/patroni/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2018-05-09T08:45:52Z", "updated_at": "2018-05-18T14:32:07Z", "closed_at": "2018-05-18T14:32:07Z", "author_association": "COLLABORATOR", "active_lock_reason": null, "body": "Scenario:\r\n\r\n    patronictl pause mycluster\r\n    # stop postgres on master, restore backup, start postgres\r\n    # This removes the replication slot for standbynode\r\n    patronictl reinit mycluster standbynode\r\n    # Master thinks standbynode still has a replication slot, master will not create a new one\r\n    # standbynode cannot replicate\r\n\r\nWorkaround is to restart postgres via Patroni. It would be nice to schedule reloading of replication slots if we discover that postgres has been restarted.", "reactions": {"url": "https://api.github.com/repos/zalando/patroni/issues/674/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/zalando/patroni/issues/674/timeline", "performed_via_github_app": null, "state_reason": "completed"}, {"url": "https://api.github.com/repos/zalando/patroni/issues/659", "repository_url": "https://api.github.com/repos/zalando/patroni", "labels_url": "https://api.github.com/repos/zalando/patroni/issues/659/labels{/name}", "comments_url": "https://api.github.com/repos/zalando/patroni/issues/659/comments", "events_url": "https://api.github.com/repos/zalando/patroni/issues/659/events", "html_url": "https://github.com/zalando/patroni/issues/659", "id": 312546942, "node_id": "MDU6SXNzdWUzMTI1NDY5NDI=", "number": 659, "title": "Patroni switched master to replica being in maintenance mode when consul was unavailable", "user": {"login": "AntonTumasov", "id": 11735006, "node_id": "MDQ6VXNlcjExNzM1MDA2", "avatar_url": "https://avatars.githubusercontent.com/u/11735006?v=4", "gravatar_id": "", "url": "https://api.github.com/users/AntonTumasov", "html_url": "https://github.com/AntonTumasov", "followers_url": "https://api.github.com/users/AntonTumasov/followers", "following_url": "https://api.github.com/users/AntonTumasov/following{/other_user}", "gists_url": "https://api.github.com/users/AntonTumasov/gists{/gist_id}", "starred_url": "https://api.github.com/users/AntonTumasov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/AntonTumasov/subscriptions", "organizations_url": "https://api.github.com/users/AntonTumasov/orgs", "repos_url": "https://api.github.com/users/AntonTumasov/repos", "events_url": "https://api.github.com/users/AntonTumasov/events{/privacy}", "received_events_url": "https://api.github.com/users/AntonTumasov/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 233785759, "node_id": "MDU6TGFiZWwyMzM3ODU3NTk=", "url": "https://api.github.com/repos/zalando/patroni/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}], "state": "closed", "locked": false, "assignee": {"login": "CyberDem0n", "id": 3407345, "node_id": "MDQ6VXNlcjM0MDczNDU=", "avatar_url": "https://avatars.githubusercontent.com/u/3407345?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CyberDem0n", "html_url": "https://github.com/CyberDem0n", "followers_url": "https://api.github.com/users/CyberDem0n/followers", "following_url": "https://api.github.com/users/CyberDem0n/following{/other_user}", "gists_url": "https://api.github.com/users/CyberDem0n/gists{/gist_id}", "starred_url": "https://api.github.com/users/CyberDem0n/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CyberDem0n/subscriptions", "organizations_url": "https://api.github.com/users/CyberDem0n/orgs", "repos_url": "https://api.github.com/users/CyberDem0n/repos", "events_url": "https://api.github.com/users/CyberDem0n/events{/privacy}", "received_events_url": "https://api.github.com/users/CyberDem0n/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "CyberDem0n", "id": 3407345, "node_id": "MDQ6VXNlcjM0MDczNDU=", "avatar_url": "https://avatars.githubusercontent.com/u/3407345?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CyberDem0n", "html_url": "https://github.com/CyberDem0n", "followers_url": "https://api.github.com/users/CyberDem0n/followers", "following_url": "https://api.github.com/users/CyberDem0n/following{/other_user}", "gists_url": "https://api.github.com/users/CyberDem0n/gists{/gist_id}", "starred_url": "https://api.github.com/users/CyberDem0n/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CyberDem0n/subscriptions", "organizations_url": "https://api.github.com/users/CyberDem0n/orgs", "repos_url": "https://api.github.com/users/CyberDem0n/repos", "events_url": "https://api.github.com/users/CyberDem0n/events{/privacy}", "received_events_url": "https://api.github.com/users/CyberDem0n/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 21, "created_at": "2018-04-09T14:11:02Z", "updated_at": "2018-05-18T09:19:56Z", "closed_at": "2018-05-18T09:19:56Z", "author_association": "NONE", "active_lock_reason": null, "body": "During `maintenance mode` of cluster we had consul cluster unavailable for 10 minutes and patroni decided to shutdown master and switch him to replica, since we had two replica and application broke while was trying to reach master. Is it okay that patroni behaves in such a way even if we set up `pause`? ", "reactions": {"url": "https://api.github.com/repos/zalando/patroni/issues/659/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/zalando/patroni/issues/659/timeline", "performed_via_github_app": null, "state_reason": "completed"}, {"url": "https://api.github.com/repos/zalando/patroni/issues/609", "repository_url": "https://api.github.com/repos/zalando/patroni", "labels_url": "https://api.github.com/repos/zalando/patroni/issues/609/labels{/name}", "comments_url": "https://api.github.com/repos/zalando/patroni/issues/609/comments", "events_url": "https://api.github.com/repos/zalando/patroni/issues/609/events", "html_url": "https://github.com/zalando/patroni/issues/609", "id": 291224335, "node_id": "MDU6SXNzdWUyOTEyMjQzMzU=", "number": 609, "title": "System incorrectly rebooted when patroni service stopped with watchdog enabled.", "user": {"login": "akissa", "id": 344251, "node_id": "MDQ6VXNlcjM0NDI1MQ==", "avatar_url": "https://avatars.githubusercontent.com/u/344251?v=4", "gravatar_id": "", "url": "https://api.github.com/users/akissa", "html_url": "https://github.com/akissa", "followers_url": "https://api.github.com/users/akissa/followers", "following_url": "https://api.github.com/users/akissa/following{/other_user}", "gists_url": "https://api.github.com/users/akissa/gists{/gist_id}", "starred_url": "https://api.github.com/users/akissa/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/akissa/subscriptions", "organizations_url": "https://api.github.com/users/akissa/orgs", "repos_url": "https://api.github.com/users/akissa/repos", "events_url": "https://api.github.com/users/akissa/events{/privacy}", "received_events_url": "https://api.github.com/users/akissa/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 233785759, "node_id": "MDU6TGFiZWwyMzM3ODU3NTk=", "url": "https://api.github.com/repos/zalando/patroni/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}], "state": "closed", "locked": false, "assignee": {"login": "CyberDem0n", "id": 3407345, "node_id": "MDQ6VXNlcjM0MDczNDU=", "avatar_url": "https://avatars.githubusercontent.com/u/3407345?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CyberDem0n", "html_url": "https://github.com/CyberDem0n", "followers_url": "https://api.github.com/users/CyberDem0n/followers", "following_url": "https://api.github.com/users/CyberDem0n/following{/other_user}", "gists_url": "https://api.github.com/users/CyberDem0n/gists{/gist_id}", "starred_url": "https://api.github.com/users/CyberDem0n/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CyberDem0n/subscriptions", "organizations_url": "https://api.github.com/users/CyberDem0n/orgs", "repos_url": "https://api.github.com/users/CyberDem0n/repos", "events_url": "https://api.github.com/users/CyberDem0n/events{/privacy}", "received_events_url": "https://api.github.com/users/CyberDem0n/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "CyberDem0n", "id": 3407345, "node_id": "MDQ6VXNlcjM0MDczNDU=", "avatar_url": "https://avatars.githubusercontent.com/u/3407345?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CyberDem0n", "html_url": "https://github.com/CyberDem0n", "followers_url": "https://api.github.com/users/CyberDem0n/followers", "following_url": "https://api.github.com/users/CyberDem0n/following{/other_user}", "gists_url": "https://api.github.com/users/CyberDem0n/gists{/gist_id}", "starred_url": "https://api.github.com/users/CyberDem0n/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CyberDem0n/subscriptions", "organizations_url": "https://api.github.com/users/CyberDem0n/orgs", "repos_url": "https://api.github.com/users/CyberDem0n/repos", "events_url": "https://api.github.com/users/CyberDem0n/events{/privacy}", "received_events_url": "https://api.github.com/users/CyberDem0n/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 1, "created_at": "2018-01-24T14:16:44Z", "updated_at": "2018-01-30T15:26:40Z", "closed_at": "2018-01-30T15:26:40Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "A regression has been introduced by commit 5da0e12353a2e2462437ff36c6512d6ae8ea7142\r\n\r\nThis is because it is possible for an exception to be raised at https://github.com/zalando/patroni/commit/5da0e12353a2e2462437ff36c6512d6ae8ea7142#diff-74fbda32f108239eb16ce7417ef10085R85\r\n\r\nThe  exception is (`psutil.NoSuchProcess`)(`psutil.NoSuchProcess process no longer exists`).\r\n\r\nThis means the watchdog is not correctly closed. Which then causes the system to get reset.\r\n\r\nIt can be replicated easily by enabling the watchdog then stop the patroni service. \r\n", "reactions": {"url": "https://api.github.com/repos/zalando/patroni/issues/609/reactions", "total_count": 1, "+1": 1, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/zalando/patroni/issues/609/timeline", "performed_via_github_app": null, "state_reason": "completed"}, {"url": "https://api.github.com/repos/zalando/patroni/issues/491", "repository_url": "https://api.github.com/repos/zalando/patroni", "labels_url": "https://api.github.com/repos/zalando/patroni/issues/491/labels{/name}", "comments_url": "https://api.github.com/repos/zalando/patroni/issues/491/comments", "events_url": "https://api.github.com/repos/zalando/patroni/issues/491/events", "html_url": "https://github.com/zalando/patroni/issues/491", "id": 246481361, "node_id": "MDU6SXNzdWUyNDY0ODEzNjE=", "number": 491, "title": "patronictl edit-config doesn't work", "user": {"login": "unixwitch", "id": 185952, "node_id": "MDQ6VXNlcjE4NTk1Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/185952?v=4", "gravatar_id": "", "url": "https://api.github.com/users/unixwitch", "html_url": "https://github.com/unixwitch", "followers_url": "https://api.github.com/users/unixwitch/followers", "following_url": "https://api.github.com/users/unixwitch/following{/other_user}", "gists_url": "https://api.github.com/users/unixwitch/gists{/gist_id}", "starred_url": "https://api.github.com/users/unixwitch/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/unixwitch/subscriptions", "organizations_url": "https://api.github.com/users/unixwitch/orgs", "repos_url": "https://api.github.com/users/unixwitch/repos", "events_url": "https://api.github.com/users/unixwitch/events{/privacy}", "received_events_url": "https://api.github.com/users/unixwitch/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 233785759, "node_id": "MDU6TGFiZWwyMzM3ODU3NTk=", "url": "https://api.github.com/repos/zalando/patroni/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}], "state": "closed", "locked": false, "assignee": {"login": "CyberDem0n", "id": 3407345, "node_id": "MDQ6VXNlcjM0MDczNDU=", "avatar_url": "https://avatars.githubusercontent.com/u/3407345?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CyberDem0n", "html_url": "https://github.com/CyberDem0n", "followers_url": "https://api.github.com/users/CyberDem0n/followers", "following_url": "https://api.github.com/users/CyberDem0n/following{/other_user}", "gists_url": "https://api.github.com/users/CyberDem0n/gists{/gist_id}", "starred_url": "https://api.github.com/users/CyberDem0n/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CyberDem0n/subscriptions", "organizations_url": "https://api.github.com/users/CyberDem0n/orgs", "repos_url": "https://api.github.com/users/CyberDem0n/repos", "events_url": "https://api.github.com/users/CyberDem0n/events{/privacy}", "received_events_url": "https://api.github.com/users/CyberDem0n/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "CyberDem0n", "id": 3407345, "node_id": "MDQ6VXNlcjM0MDczNDU=", "avatar_url": "https://avatars.githubusercontent.com/u/3407345?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CyberDem0n", "html_url": "https://github.com/CyberDem0n", "followers_url": "https://api.github.com/users/CyberDem0n/followers", "following_url": "https://api.github.com/users/CyberDem0n/following{/other_user}", "gists_url": "https://api.github.com/users/CyberDem0n/gists{/gist_id}", "starred_url": "https://api.github.com/users/CyberDem0n/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CyberDem0n/subscriptions", "organizations_url": "https://api.github.com/users/CyberDem0n/orgs", "repos_url": "https://api.github.com/users/CyberDem0n/repos", "events_url": "https://api.github.com/users/CyberDem0n/events{/privacy}", "received_events_url": "https://api.github.com/users/CyberDem0n/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 2, "created_at": "2017-07-28T23:32:18Z", "updated_at": "2019-08-20T15:30:38Z", "closed_at": "2017-07-31T09:07:01Z", "author_association": "NONE", "active_lock_reason": null, "body": "Hello,\r\n\r\nThank you for fixing #488 :-)  However, I have another problem:\r\n\r\nUsing Patroni 1.3 with ZooKeeper 3.4.10, `patronictl edit-config` doesn't seem to work.  Any change (even a trivial one, like changing `ttl` from 30 to 31) gives the same error:\r\n\r\n```\r\n[root@postgres-5-2 ~]# patronictl -c /etc/patroni.yaml edit-config postgres-5\r\n--- \r\n+++ \r\n@@ -11,4 +11,4 @@\r\n   use_pg_rewind: true\r\n   use_slots: true\r\n retry_timeout: 10\r\n-ttl: 30\r\n+ttl: 31\r\n\r\nApply these changes? [y/N]: y\r\n2017-07-28 23:27:53,965 - ERROR - Unhandled exception in connection loop\r\nTraceback (most recent call last):\r\n  File \"/usr/lib/python3.4/site-packages/kazoo/protocol/connection.py\", line 541, in _connect_attempt\r\n    self._send_request(read_timeout, connect_timeout)\r\n  File \"/usr/lib/python3.4/site-packages/kazoo/protocol/connection.py\", line 445, in _send_request\r\n    self._submit(request, connect_timeout, xid)\r\n  File \"/usr/lib/python3.4/site-packages/kazoo/protocol/connection.py\", line 279, in _submit\r\n    b += request.serialize()\r\n  File \"/usr/lib/python3.4/site-packages/kazoo/protocol/serialization.py\", line 195, in serialize\r\n    b.extend(int_struct.pack(self.version))\r\nstruct.error: 'i' format requires -2147483648 <= number <= 2147483647\r\nException in thread Thread-3:\r\nTraceback (most recent call last):\r\n  File \"/usr/lib64/python3.4/threading.py\", line 911, in _bootstrap_inner\r\n    self.run()\r\n  File \"/usr/lib64/python3.4/threading.py\", line 859, in run\r\n    self._target(*self._args, **self._kwargs)\r\n  File \"/usr/lib/python3.4/site-packages/kazoo/protocol/connection.py\", line 471, in zk_loop\r\n    if retry(self._connect_loop, retry) is STOP_CONNECTING:\r\n  File \"/usr/lib/python3.4/site-packages/kazoo/retry.py\", line 123, in __call__\r\n    return func(*args, **kwargs)\r\n  File \"/usr/lib/python3.4/site-packages/kazoo/protocol/connection.py\", line 488, in _connect_loop\r\n    status = self._connect_attempt(host, port, retry)\r\n  File \"/usr/lib/python3.4/site-packages/kazoo/protocol/connection.py\", line 541, in _connect_attempt\r\n    self._send_request(read_timeout, connect_timeout)\r\n  File \"/usr/lib/python3.4/site-packages/kazoo/protocol/connection.py\", line 445, in _send_request\r\n    self._submit(request, connect_timeout, xid)\r\n  File \"/usr/lib/python3.4/site-packages/kazoo/protocol/connection.py\", line 279, in _submit\r\n    b += request.serialize()\r\n  File \"/usr/lib/python3.4/site-packages/kazoo/protocol/serialization.py\", line 195, in serialize\r\n    b.extend(int_struct.pack(self.version))\r\nstruct.error: 'i' format requires -2147483648 <= number <= 2147483647\r\n\r\n2017-07-28 23:27:54,328 - ERROR - set_config_value\r\nTraceback (most recent call last):\r\n  File \"/usr/lib/python3.4/site-packages/patroni/dcs/zookeeper.py\", line 230, in set_config_value\r\n    self._client.retry(self._client.set, self.config_path, value.encode('utf-8'), version=index or -1)\r\n  File \"/usr/lib/python3.4/site-packages/kazoo/client.py\", line 273, in _retry\r\n    return self._retry.copy()(*args, **kwargs)\r\n  File \"/usr/lib/python3.4/site-packages/kazoo/retry.py\", line 123, in __call__\r\n    return func(*args, **kwargs)\r\n  File \"/usr/lib/python3.4/site-packages/kazoo/client.py\", line 1219, in set\r\n    return self.set_async(path, value, version).get()\r\n  File \"/usr/lib/python3.4/site-packages/kazoo/handlers/utils.py\", line 72, in get\r\n    raise self._exception\r\nkazoo.exceptions.ConnectionClosedError: Connection has been closed\r\nError: Config modification aborted due to concurrent changes\r\n```\r\n\r\nThe complete configuration is:\r\n\r\n```\r\n[root@postgres-5-2 ~]# patronictl -c /etc/patroni.yaml show-config postgres-5    \r\nloop_wait: 10\r\nmaximum_lag_on_failover: 1048576\r\npostgresql:\r\n  parameters:\r\n    hot_standby: 'on'\r\n    max_replication_slots: 5\r\n    max_wal_senders: 5\r\n    wal_keep_segments: 8\r\n    wal_level: hot_standby\r\n    wal_log_hints: 'on'\r\n  use_pg_rewind: true\r\n  use_slots: true\r\nretry_timeout: 10\r\nttl: 30\r\n```", "reactions": {"url": "https://api.github.com/repos/zalando/patroni/issues/491/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/zalando/patroni/issues/491/timeline", "performed_via_github_app": null, "state_reason": "completed"}, {"url": "https://api.github.com/repos/zalando/patroni/issues/488", "repository_url": "https://api.github.com/repos/zalando/patroni", "labels_url": "https://api.github.com/repos/zalando/patroni/issues/488/labels{/name}", "comments_url": "https://api.github.com/repos/zalando/patroni/issues/488/comments", "events_url": "https://api.github.com/repos/zalando/patroni/issues/488/events", "html_url": "https://github.com/zalando/patroni/issues/488", "id": 246335454, "node_id": "MDU6SXNzdWUyNDYzMzU0NTQ=", "number": 488, "title": "POST failover doesn't work", "user": {"login": "unixwitch", "id": 185952, "node_id": "MDQ6VXNlcjE4NTk1Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/185952?v=4", "gravatar_id": "", "url": "https://api.github.com/users/unixwitch", "html_url": "https://github.com/unixwitch", "followers_url": "https://api.github.com/users/unixwitch/followers", "following_url": "https://api.github.com/users/unixwitch/following{/other_user}", "gists_url": "https://api.github.com/users/unixwitch/gists{/gist_id}", "starred_url": "https://api.github.com/users/unixwitch/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/unixwitch/subscriptions", "organizations_url": "https://api.github.com/users/unixwitch/orgs", "repos_url": "https://api.github.com/users/unixwitch/repos", "events_url": "https://api.github.com/users/unixwitch/events{/privacy}", "received_events_url": "https://api.github.com/users/unixwitch/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 233785759, "node_id": "MDU6TGFiZWwyMzM3ODU3NTk=", "url": "https://api.github.com/repos/zalando/patroni/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}], "state": "closed", "locked": false, "assignee": {"login": "CyberDem0n", "id": 3407345, "node_id": "MDQ6VXNlcjM0MDczNDU=", "avatar_url": "https://avatars.githubusercontent.com/u/3407345?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CyberDem0n", "html_url": "https://github.com/CyberDem0n", "followers_url": "https://api.github.com/users/CyberDem0n/followers", "following_url": "https://api.github.com/users/CyberDem0n/following{/other_user}", "gists_url": "https://api.github.com/users/CyberDem0n/gists{/gist_id}", "starred_url": "https://api.github.com/users/CyberDem0n/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CyberDem0n/subscriptions", "organizations_url": "https://api.github.com/users/CyberDem0n/orgs", "repos_url": "https://api.github.com/users/CyberDem0n/repos", "events_url": "https://api.github.com/users/CyberDem0n/events{/privacy}", "received_events_url": "https://api.github.com/users/CyberDem0n/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "CyberDem0n", "id": 3407345, "node_id": "MDQ6VXNlcjM0MDczNDU=", "avatar_url": "https://avatars.githubusercontent.com/u/3407345?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CyberDem0n", "html_url": "https://github.com/CyberDem0n", "followers_url": "https://api.github.com/users/CyberDem0n/followers", "following_url": "https://api.github.com/users/CyberDem0n/following{/other_user}", "gists_url": "https://api.github.com/users/CyberDem0n/gists{/gist_id}", "starred_url": "https://api.github.com/users/CyberDem0n/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CyberDem0n/subscriptions", "organizations_url": "https://api.github.com/users/CyberDem0n/orgs", "repos_url": "https://api.github.com/users/CyberDem0n/repos", "events_url": "https://api.github.com/users/CyberDem0n/events{/privacy}", "received_events_url": "https://api.github.com/users/CyberDem0n/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 1, "created_at": "2017-07-28T12:38:31Z", "updated_at": "2017-07-28T13:38:56Z", "closed_at": "2017-07-28T13:38:56Z", "author_association": "NONE", "active_lock_reason": null, "body": "Hello,\r\n\r\nI set up a new cluster using Patroni 1.3, ZooKeeper 3.4.10 and PostgreSQL 9.6.3 on CentOS 7.  Everything seems to work fine, except failover via the API.\r\n\r\nI sent a request like this:\r\n\r\n```\r\n[root@postgres-5-2 ~]# curl -d'{\"leader\": \"postgres-5-2\", \"candidate\": \"postgres-5-3\"}' -H'Content-Type: application/json' http://admin:xxx@postgres-5-2:8008/failover\r\ncurl: (52) Empty reply from server\r\n```\r\n\r\nPatroni error logs show an exception:\r\n\r\n```\r\nJul 28 12:35:31 postgres-5-2 patroni[1269]: 2017-07-28 12:35:31,258 INFO: received failover request with leader=postgres-5-2 candidate=postgres-5-3 scheduled_at=None\r\nJul 28 12:35:31 postgres-5-2 patroni[1269]: 2017-07-28 12:35:31,276 INFO: Got response from postgres-5-3 http://postgres-5-3:8008/patroni: b'{\"role\": \"replica\", \"postmaster_start_time\": \"2017-07-28 12:31:09.295 UTC\", \"state\": \"running\", \"xlog\": {\"replayed_timestamp\": \"2017-07-28 12:31:09.208 UTC\", \"paused\": false, \"replayed_location\": 369514424, \"received_location\": 369514424}, \"server_version\": 90603, \"patroni\": {\"version\": \"1.3\", \"scope\": \"postgres-5\"}, \"database_system_identifier\": \"6447546693452231673\"}'\r\nJul 28 12:35:31 postgres-5-2 patroni[1269]: 2017-07-28 12:35:31,367 INFO: Got response from postgres-5-3 http://postgres-5-3:8008/patroni: b'{\"role\": \"replica\", \"postmaster_start_time\": \"2017-07-28 12:31:09.295 UTC\", \"state\": \"running\", \"xlog\": {\"replayed_timestamp\": \"2017-07-28 12:31:09.208 UTC\", \"paused\": false, \"replayed_location\": 369514424, \"received_location\": 369514424}, \"server_version\": 90603, \"patroni\": {\"version\": \"1.3\", \"scope\": \"postgres-5\"}, \"database_system_identifier\": \"6447546693452231673\"}'\r\nJul 28 12:35:34 postgres-5-2 patroni[1269]: Traceback (most recent call last):\r\nJul 28 12:35:34 postgres-5-2 patroni[1269]: File \"/usr/lib64/python3.4/socketserver.py\", line 617, in process_request_thread\r\nJul 28 12:35:34 postgres-5-2 patroni[1269]: self.finish_request(request, client_address)\r\nJul 28 12:35:34 postgres-5-2 patroni[1269]: File \"/usr/lib64/python3.4/socketserver.py\", line 344, in finish_request\r\nJul 28 12:35:34 postgres-5-2 patroni[1269]: self.RequestHandlerClass(request, client_address, self)\r\nJul 28 12:35:34 postgres-5-2 patroni[1269]: File \"/usr/lib64/python3.4/socketserver.py\", line 673, in __init__\r\nJul 28 12:35:34 postgres-5-2 patroni[1269]: self.handle()\r\nJul 28 12:35:34 postgres-5-2 patroni[1269]: File \"/usr/lib64/python3.4/http/server.py\", line 401, in handle\r\nJul 28 12:35:34 postgres-5-2 patroni[1269]: self.handle_one_request()\r\nJul 28 12:35:34 postgres-5-2 patroni[1269]: File \"/usr/lib64/python3.4/http/server.py\", line 389, in handle_one_request\r\nJul 28 12:35:34 postgres-5-2 patroni[1269]: method()\r\nJul 28 12:35:34 postgres-5-2 patroni[1269]: File \"/usr/lib/python3.4/site-packages/patroni/api.py\", line 29, in wrapper\r\nJul 28 12:35:34 postgres-5-2 patroni[1269]: return func(handler)\r\nJul 28 12:35:34 postgres-5-2 patroni[1269]: File \"/usr/lib/python3.4/site-packages/patroni/api.py\", line 341, in do_POST_failover\r\nJul 28 12:35:34 postgres-5-2 patroni[1269]: data = self.is_failover_possible(cluster, leader, candidate)\r\nJul 28 12:35:34 postgres-5-2 patroni[1269]: File \"/usr/lib/python3.4/site-packages/patroni/api.py\", line 304, in is_failover_possible\r\nJul 28 12:35:34 postgres-5-2 patroni[1269]: for _, reachable, _, _, tags in self.server.patroni.ha.fetch_nodes_statuses(members):\r\nJul 28 12:35:34 postgres-5-2 patroni[1269]: ValueError: too many values to unpack (expected 5)\r\n```\r\n\r\nFailover using `patronictl failover` still works as it falls back to DCS.", "reactions": {"url": "https://api.github.com/repos/zalando/patroni/issues/488/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/zalando/patroni/issues/488/timeline", "performed_via_github_app": null, "state_reason": "completed"}, {"url": "https://api.github.com/repos/zalando/patroni/issues/427", "repository_url": "https://api.github.com/repos/zalando/patroni", "labels_url": "https://api.github.com/repos/zalando/patroni/issues/427/labels{/name}", "comments_url": "https://api.github.com/repos/zalando/patroni/issues/427/comments", "events_url": "https://api.github.com/repos/zalando/patroni/issues/427/events", "html_url": "https://github.com/zalando/patroni/pull/427", "id": 221253350, "node_id": "MDExOlB1bGxSZXF1ZXN0MTE1NTM1ODAw", "number": 427, "title": "BUGFIX: pg_drop_replication_slot may not be called if slot is active", "user": {"login": "CyberDem0n", "id": 3407345, "node_id": "MDQ6VXNlcjM0MDczNDU=", "avatar_url": "https://avatars.githubusercontent.com/u/3407345?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CyberDem0n", "html_url": "https://github.com/CyberDem0n", "followers_url": "https://api.github.com/users/CyberDem0n/followers", "following_url": "https://api.github.com/users/CyberDem0n/following{/other_user}", "gists_url": "https://api.github.com/users/CyberDem0n/gists{/gist_id}", "starred_url": "https://api.github.com/users/CyberDem0n/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CyberDem0n/subscriptions", "organizations_url": "https://api.github.com/users/CyberDem0n/orgs", "repos_url": "https://api.github.com/users/CyberDem0n/repos", "events_url": "https://api.github.com/users/CyberDem0n/events{/privacy}", "received_events_url": "https://api.github.com/users/CyberDem0n/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 233785759, "node_id": "MDU6TGFiZWwyMzM3ODU3NTk=", "url": "https://api.github.com/repos/zalando/patroni/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2017-04-12T12:57:06Z", "updated_at": "2017-04-18T10:45:29Z", "closed_at": "2017-04-18T10:45:25Z", "author_association": "COLLABORATOR", "active_lock_reason": null, "draft": false, "pull_request": {"url": "https://api.github.com/repos/zalando/patroni/pulls/427", "html_url": "https://github.com/zalando/patroni/pull/427", "diff_url": "https://github.com/zalando/patroni/pull/427.diff", "patch_url": "https://github.com/zalando/patroni/pull/427.patch", "merged_at": "2017-04-18T10:45:25Z"}, "body": "Default value of wal_sender_timeout is 60 seconds while we are trying to remove replication slot after 30 seconds (ttl=30). That means postgres might think that slot is still active and does nothing. Patroni at the\r\nsame time was thinking that it was removed successfully.\r\n\r\nIf the drop replication slot query didn't return any single row we must fetch list of existing physical replication slots from postgres on the next iteration of HA loop.\r\n\r\nFixes: issue #425", "reactions": {"url": "https://api.github.com/repos/zalando/patroni/issues/427/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/zalando/patroni/issues/427/timeline", "performed_via_github_app": null, "state_reason": null}, {"url": "https://api.github.com/repos/zalando/patroni/issues/420", "repository_url": "https://api.github.com/repos/zalando/patroni", "labels_url": "https://api.github.com/repos/zalando/patroni/issues/420/labels{/name}", "comments_url": "https://api.github.com/repos/zalando/patroni/issues/420/comments", "events_url": "https://api.github.com/repos/zalando/patroni/issues/420/events", "html_url": "https://github.com/zalando/patroni/pull/420", "id": 217514438, "node_id": "MDExOlB1bGxSZXF1ZXN0MTEyOTM2NjQx", "number": 420, "title": "Release the leader key when the leader restarts with an empty data dir", "user": {"login": "abkfenris", "id": 1296209, "node_id": "MDQ6VXNlcjEyOTYyMDk=", "avatar_url": "https://avatars.githubusercontent.com/u/1296209?v=4", "gravatar_id": "", "url": "https://api.github.com/users/abkfenris", "html_url": "https://github.com/abkfenris", "followers_url": "https://api.github.com/users/abkfenris/followers", "following_url": "https://api.github.com/users/abkfenris/following{/other_user}", "gists_url": "https://api.github.com/users/abkfenris/gists{/gist_id}", "starred_url": "https://api.github.com/users/abkfenris/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/abkfenris/subscriptions", "organizations_url": "https://api.github.com/users/abkfenris/orgs", "repos_url": "https://api.github.com/users/abkfenris/repos", "events_url": "https://api.github.com/users/abkfenris/events{/privacy}", "received_events_url": "https://api.github.com/users/abkfenris/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 233785759, "node_id": "MDU6TGFiZWwyMzM3ODU3NTk=", "url": "https://api.github.com/repos/zalando/patroni/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2017-03-28T10:26:48Z", "updated_at": "2017-04-18T10:46:13Z", "closed_at": "2017-04-18T10:45:49Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "draft": false, "pull_request": {"url": "https://api.github.com/repos/zalando/patroni/pulls/420", "html_url": "https://github.com/zalando/patroni/pull/420", "diff_url": "https://github.com/zalando/patroni/pull/420.diff", "patch_url": "https://github.com/zalando/patroni/pull/420.patch", "merged_at": "2017-04-18T10:45:49Z"}, "body": "On Kubernetes (and maybe other platforms) if the leader instance is killed, it may restart fast enough that the ttl never expires, and an election isn't triggered. \r\n\r\nIf the instances are using ephemeral storage, that means the instance comes back, sees that it is the leader, but it has an empty data directory, so it tries to bootstrap off itself. The cluster then gets stuck in a read only state as replicas are available, but the leader isn't able to accept writes as it is still trying to bootstrap.\r\n\r\nI've added a check to see if the data directory is empty and if the instance is the leader before it bootstraps. If those a are both true, then it releases the leader key voluntarily so that an election can occur between the healthy replicas.\r\n\r\nCloses #419 ", "reactions": {"url": "https://api.github.com/repos/zalando/patroni/issues/420/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/zalando/patroni/issues/420/timeline", "performed_via_github_app": null, "state_reason": null}, {"url": "https://api.github.com/repos/zalando/patroni/issues/384", "repository_url": "https://api.github.com/repos/zalando/patroni", "labels_url": "https://api.github.com/repos/zalando/patroni/issues/384/labels{/name}", "comments_url": "https://api.github.com/repos/zalando/patroni/issues/384/comments", "events_url": "https://api.github.com/repos/zalando/patroni/issues/384/events", "html_url": "https://github.com/zalando/patroni/issues/384", "id": 200812901, "node_id": "MDU6SXNzdWUyMDA4MTI5MDE=", "number": 384, "title": "[v1.2] How to configure etcd for https endpoint?", "user": {"login": "drnic", "id": 108, "node_id": "MDQ6VXNlcjEwOA==", "avatar_url": "https://avatars.githubusercontent.com/u/108?v=4", "gravatar_id": "", "url": "https://api.github.com/users/drnic", "html_url": "https://github.com/drnic", "followers_url": "https://api.github.com/users/drnic/followers", "following_url": "https://api.github.com/users/drnic/following{/other_user}", "gists_url": "https://api.github.com/users/drnic/gists{/gist_id}", "starred_url": "https://api.github.com/users/drnic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/drnic/subscriptions", "organizations_url": "https://api.github.com/users/drnic/orgs", "repos_url": "https://api.github.com/users/drnic/repos", "events_url": "https://api.github.com/users/drnic/events{/privacy}", "received_events_url": "https://api.github.com/users/drnic/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 233785759, "node_id": "MDU6TGFiZWwyMzM3ODU3NTk=", "url": "https://api.github.com/repos/zalando/patroni/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}, {"id": 233785764, "node_id": "MDU6TGFiZWwyMzM3ODU3NjQ=", "url": "https://api.github.com/repos/zalando/patroni/labels/question", "name": "question", "color": "cc317c", "default": true, "description": null}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 7, "created_at": "2017-01-14T16:13:00Z", "updated_at": "2017-02-01T03:17:48Z", "closed_at": "2017-01-18T12:46:03Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "I'm enthusiastically trying out new support for etcd https endpoints (plus auth support).\r\n\r\nBut my output is filled with warnings from urllib3:\r\n\r\n```\r\n/usr/lib/python3.5/site-packages/urllib3/connectionpool.py:843: InsecureRequestWarning: Unverified HTTPS request is being made. Adding certificate verification is strongly advised. See: https://urllib3.readthedocs.io/en/latest/advanced-usage.html#ssl-warnings\r\nInsecureRequestWarning)\r\n```\r\n\r\nI've tried installing `pip3 install certifi` but no change. \r\n\r\nI also tried specifying:\r\n\r\n```yaml\r\netcd:\r\n  cacert: /etc/ssl/certs/ca-certificates.crt\r\n```\r\n\r\nbut this creates an error:\r\n\r\n```\r\n2017-01-14 16:07:43,702 INFO: Selected new etcd server https://54.174.22.61:15978\r\n2017-01-14 16:07:43,886 ERROR: Failed to get list of machines from https://54.174.22.61:15978/v2: SSLError(SSLError(1, '[SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed (_ssl.c:645)'),)\r\n2017-01-14 16:07:43,886 ERROR: Machines cache is empty, no machines to try.\r\n2017-01-14 16:07:43,886 INFO: waiting on etcd\r\n```\r\n\r\nTo reproduce the error, try using https://www.compose.com/etcd which provides 30-days free trial of an https etcd cluster with root/password. The configuration I'm using looks like:\r\n\r\n```yaml\r\netcd:\r\n  host: portal-nnn.stark-wayne.composedb.com:15000\r\n  protocol: https\r\n  username: root\r\n  password: password\r\n```\r\n", "reactions": {"url": "https://api.github.com/repos/zalando/patroni/issues/384/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/zalando/patroni/issues/384/timeline", "performed_via_github_app": null, "state_reason": "completed"}, {"url": "https://api.github.com/repos/zalando/patroni/issues/353", "repository_url": "https://api.github.com/repos/zalando/patroni", "labels_url": "https://api.github.com/repos/zalando/patroni/issues/353/labels{/name}", "comments_url": "https://api.github.com/repos/zalando/patroni/issues/353/comments", "events_url": "https://api.github.com/repos/zalando/patroni/issues/353/events", "html_url": "https://github.com/zalando/patroni/issues/353", "id": 187981009, "node_id": "MDU6SXNzdWUxODc5ODEwMDk=", "number": 353, "title": "Replication password is not reloaded", "user": {"login": "ants", "id": 64938, "node_id": "MDQ6VXNlcjY0OTM4", "avatar_url": "https://avatars.githubusercontent.com/u/64938?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ants", "html_url": "https://github.com/ants", "followers_url": "https://api.github.com/users/ants/followers", "following_url": "https://api.github.com/users/ants/following{/other_user}", "gists_url": "https://api.github.com/users/ants/gists{/gist_id}", "starred_url": "https://api.github.com/users/ants/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ants/subscriptions", "organizations_url": "https://api.github.com/users/ants/orgs", "repos_url": "https://api.github.com/users/ants/repos", "events_url": "https://api.github.com/users/ants/events{/privacy}", "received_events_url": "https://api.github.com/users/ants/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 233785759, "node_id": "MDU6TGFiZWwyMzM3ODU3NTk=", "url": "https://api.github.com/repos/zalando/patroni/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}, {"id": 233785762, "node_id": "MDU6TGFiZWwyMzM3ODU3NjI=", "url": "https://api.github.com/repos/zalando/patroni/labels/help%20wanted", "name": "help wanted", "color": "159818", "default": true, "description": null}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2016-11-08T12:35:46Z", "updated_at": "2017-05-19T14:32:35Z", "closed_at": "2017-05-19T14:32:35Z", "author_association": "COLLABORATOR", "active_lock_reason": null, "body": "When replication password is changed in Patroni config, a `Patroni.reload_config()`->`Postgresql.reload_config()` does not propagate the change to `Postgresql._replication`.\r\n\r\nI'll check for other similar issues and put together a pull request.", "reactions": {"url": "https://api.github.com/repos/zalando/patroni/issues/353/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/zalando/patroni/issues/353/timeline", "performed_via_github_app": null, "state_reason": "completed"}, {"url": "https://api.github.com/repos/zalando/patroni/issues/347", "repository_url": "https://api.github.com/repos/zalando/patroni", "labels_url": "https://api.github.com/repos/zalando/patroni/issues/347/labels{/name}", "comments_url": "https://api.github.com/repos/zalando/patroni/issues/347/comments", "events_url": "https://api.github.com/repos/zalando/patroni/issues/347/events", "html_url": "https://github.com/zalando/patroni/issues/347", "id": 185612350, "node_id": "MDU6SXNzdWUxODU2MTIzNTA=", "number": 347, "title": "Losing in leader election clears need_rewind flag", "user": {"login": "ants", "id": 64938, "node_id": "MDQ6VXNlcjY0OTM4", "avatar_url": "https://avatars.githubusercontent.com/u/64938?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ants", "html_url": "https://github.com/ants", "followers_url": "https://api.github.com/users/ants/followers", "following_url": "https://api.github.com/users/ants/following{/other_user}", "gists_url": "https://api.github.com/users/ants/gists{/gist_id}", "starred_url": "https://api.github.com/users/ants/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ants/subscriptions", "organizations_url": "https://api.github.com/users/ants/orgs", "repos_url": "https://api.github.com/users/ants/repos", "events_url": "https://api.github.com/users/ants/events{/privacy}", "received_events_url": "https://api.github.com/users/ants/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 233785759, "node_id": "MDU6TGFiZWwyMzM3ODU3NTk=", "url": "https://api.github.com/repos/zalando/patroni/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}, {"id": 233785762, "node_id": "MDU6TGFiZWwyMzM3ODU3NjI=", "url": "https://api.github.com/repos/zalando/patroni/labels/help%20wanted", "name": "help wanted", "color": "159818", "default": true, "description": null}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 5, "created_at": "2016-10-27T09:06:36Z", "updated_at": "2017-06-27T10:10:38Z", "closed_at": "2017-06-27T10:10:37Z", "author_association": "COLLABORATOR", "active_lock_reason": null, "body": "``process_unhealthy_cluster()` does:\n\n``` python\n    need_rewind = bool(self.cluster.failover) or self.patroni.nofailover\n```\n\nand then `Postgresql.follow()` does:\n\n``` python\nif need_rewind is not None:\n    self._need_rewind = need_rewind\n```\n\nThis looks incorrect to me. I assume tacking on an `or None` default onto there is what was intended. I'll continue my refactoring based on this assumption, but wanted to double check as the need_rewind logic is hard to follow.\n", "reactions": {"url": "https://api.github.com/repos/zalando/patroni/issues/347/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/zalando/patroni/issues/347/timeline", "performed_via_github_app": null, "state_reason": "completed"}, {"url": "https://api.github.com/repos/zalando/patroni/issues/342", "repository_url": "https://api.github.com/repos/zalando/patroni", "labels_url": "https://api.github.com/repos/zalando/patroni/issues/342/labels{/name}", "comments_url": "https://api.github.com/repos/zalando/patroni/issues/342/comments", "events_url": "https://api.github.com/repos/zalando/patroni/issues/342/events", "html_url": "https://github.com/zalando/patroni/issues/342", "id": 183901432, "node_id": "MDU6SXNzdWUxODM5MDE0MzI=", "number": 342, "title": "Patronictl reports incorrect lag during failover", "user": {"login": "alexeyklyukin", "id": 339913, "node_id": "MDQ6VXNlcjMzOTkxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/339913?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexeyklyukin", "html_url": "https://github.com/alexeyklyukin", "followers_url": "https://api.github.com/users/alexeyklyukin/followers", "following_url": "https://api.github.com/users/alexeyklyukin/following{/other_user}", "gists_url": "https://api.github.com/users/alexeyklyukin/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexeyklyukin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexeyklyukin/subscriptions", "organizations_url": "https://api.github.com/users/alexeyklyukin/orgs", "repos_url": "https://api.github.com/users/alexeyklyukin/repos", "events_url": "https://api.github.com/users/alexeyklyukin/events{/privacy}", "received_events_url": "https://api.github.com/users/alexeyklyukin/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 233785759, "node_id": "MDU6TGFiZWwyMzM3ODU3NTk=", "url": "https://api.github.com/repos/zalando/patroni/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}, {"id": 233785762, "node_id": "MDU6TGFiZWwyMzM3ODU3NjI=", "url": "https://api.github.com/repos/zalando/patroni/labels/help%20wanted", "name": "help wanted", "color": "159818", "default": true, "description": null}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2016-10-19T08:48:01Z", "updated_at": "2018-08-17T07:10:42Z", "closed_at": "2018-08-17T07:10:41Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "> +-----------------------+------------+----------------+--------+----------+-----------+\n> | Cluster               | Member     | Host           | Leader |  State   | Lag in MB |\n> +-----------------------+------------+----------------+--------+----------+-----------+\n> | test | i_3365f78e | 172.31.136.227 |        | starting |    779488 |\n> | test | i_8cceeb30 | 172.31.145.161 |   \\*    | running  |         0 |\n> | test | i_c70e9d7a | 172.31.137.53  |        | stopped  |    779488 |\n> +-----------------------+------------+----------------+--------+----------+-----------+\n\nA note to myself to investigate\n", "reactions": {"url": "https://api.github.com/repos/zalando/patroni/issues/342/reactions", "total_count": 1, "+1": 1, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/zalando/patroni/issues/342/timeline", "performed_via_github_app": null, "state_reason": "completed"}, {"url": "https://api.github.com/repos/zalando/patroni/issues/327", "repository_url": "https://api.github.com/repos/zalando/patroni", "labels_url": "https://api.github.com/repos/zalando/patroni/issues/327/labels{/name}", "comments_url": "https://api.github.com/repos/zalando/patroni/issues/327/comments", "events_url": "https://api.github.com/repos/zalando/patroni/issues/327/events", "html_url": "https://github.com/zalando/patroni/issues/327", "id": 181108166, "node_id": "MDU6SXNzdWUxODExMDgxNjY=", "number": 327, "title": "Slave reports errors after being reinitialized", "user": {"login": "irminsul", "id": 16736730, "node_id": "MDQ6VXNlcjE2NzM2NzMw", "avatar_url": "https://avatars.githubusercontent.com/u/16736730?v=4", "gravatar_id": "", "url": "https://api.github.com/users/irminsul", "html_url": "https://github.com/irminsul", "followers_url": "https://api.github.com/users/irminsul/followers", "following_url": "https://api.github.com/users/irminsul/following{/other_user}", "gists_url": "https://api.github.com/users/irminsul/gists{/gist_id}", "starred_url": "https://api.github.com/users/irminsul/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/irminsul/subscriptions", "organizations_url": "https://api.github.com/users/irminsul/orgs", "repos_url": "https://api.github.com/users/irminsul/repos", "events_url": "https://api.github.com/users/irminsul/events{/privacy}", "received_events_url": "https://api.github.com/users/irminsul/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 233785759, "node_id": "MDU6TGFiZWwyMzM3ODU3NTk=", "url": "https://api.github.com/repos/zalando/patroni/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}, {"id": 233785762, "node_id": "MDU6TGFiZWwyMzM3ODU3NjI=", "url": "https://api.github.com/repos/zalando/patroni/labels/help%20wanted", "name": "help wanted", "color": "159818", "default": true, "description": null}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 5, "created_at": "2016-10-05T09:43:44Z", "updated_at": "2020-10-08T08:48:22Z", "closed_at": "2020-10-08T08:48:22Z", "author_association": "NONE", "active_lock_reason": null, "body": "Hi,\n\nI used `patronictl reinit -c /config/patroni.yml hephaistos postgres2` on my cluster to reinitialize the node `postgres2`.\n\n`pg_stat_replication` and `patronictl list` tell me that everything is fine:\n\n```\n# patronictl list -c /config/postgres.yml hephaistos\n+------------+-----------+------------+--------+---------+-----------+\n| Cluster    | Member    | Host       | Leader |  State  | Lag in MB |\n+------------+-----------+------------+--------+---------+-----------+\n| hephaistos | postgres0 | 10.20.6.15 |   *    | running |         0 |\n| hephaistos | postgres1 | 10.20.1.5  |        | running |         0 |\n| hephaistos | postgres2 | 10.20.2.14 |        | running |         0 |\n+------------+-----------+------------+--------+---------+-----------+\n```\n\nHowever, the following error message started to appear in the logs of `postgres2`:\n\n```\nERROR:  requested starting point 0/69000000 on timeline 7 is not in this server's history\nDETAIL:  This server's history forked from timeline 7 at 0/68B480C8.\n```\n\nShould I be worried or is this behavior expected?\n### System information\n- Kubernetes 1.4.0 (GKE)\n- Postgres 9.5.4\n- Patroni 1.1\n- Full log of `postgres2` after running `patronictl reinit`:\n  \n  ```\n  2016-10-05 09:05:54,107 INFO: Removing data directory: /data/postgresql/data\n  2016-10-05 09:05:54,284 INFO: Starting new HTTPS connection (1): kubernetes.default.svc.cluster.local\n  \n  WARNING:  skipping special file \"./.s.PGSQL.5432\"\n  2016-10-05 09:06:02,481 INFO: replica has been created using basebackup\n  2016-10-05 09:06:02,482 INFO: bootstrapped from leader 'postgres0'\n  2016-10-05 09:06:02,485 INFO: closed patroni connection to the postgresql cluster\n  waiting for server to start....LOG:  database system was interrupted; last known up at 2016-10-05 09:06:00 UTC\n  2016-10-05 09:06:02,542 INFO: Lock owner: postgres0; I am postgres2\n  2016-10-05 09:06:02,543 INFO: reinitialize in progress\n  FATAL:  the database system is starting up\n  .FATAL:  the database system is starting up\n  .LOG:  entering standby mode\n  LOG:  recovered replication state of node 1 to 0/A0D2540\n  LOG:  redo starts at 0/88000028\n  LOG:  consistent recovery state reached at 0/88000130\n  LOG:  database system is ready to accept read only connections\n  LOG:  started streaming WAL from primary at 0/89000000 on timeline 9\n  done\n  server started\n  2016-10-05 09:06:05,720 INFO: Starting new HTTPS connection (1): kubernetes.default.svc.cluster.local\n  2016-10-05 09:06:12,535 INFO: establishing a new patroni connection to the postgres cluster\n  2016-10-05 09:06:12,545 INFO: Lock owner: postgres0; I am postgres2\n  2016-10-05 09:06:12,546 INFO: does not have lock\n  2016-10-05 09:06:12,548 INFO: no action.  i am a secondary and i am following a leader\n  ERROR:  requested starting point 0/69000000 on timeline 7 is not in this server's history\n  DETAIL:  This server's history forked from timeline 7 at 0/68B480C8.\n  2016-10-05 09:06:22,545 INFO: Lock owner: postgres0; I am postgres2\n  2016-10-05 09:06:22,545 INFO: does not have lock\n  2016-10-05 09:06:22,546 INFO: no action.  i am a secondary and i am following a leader\n  ERROR:  requested starting point 0/69000000 on timeline 7 is not in this server's history\n  DETAIL:  This server's history forked from timeline 7 at 0/68B480C8.\n  [...]\n  ```\n", "reactions": {"url": "https://api.github.com/repos/zalando/patroni/issues/327/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/zalando/patroni/issues/327/timeline", "performed_via_github_app": null, "state_reason": "completed"}, {"url": "https://api.github.com/repos/zalando/patroni/issues/309", "repository_url": "https://api.github.com/repos/zalando/patroni", "labels_url": "https://api.github.com/repos/zalando/patroni/issues/309/labels{/name}", "comments_url": "https://api.github.com/repos/zalando/patroni/issues/309/comments", "events_url": "https://api.github.com/repos/zalando/patroni/issues/309/events", "html_url": "https://github.com/zalando/patroni/issues/309", "id": 177925226, "node_id": "MDU6SXNzdWUxNzc5MjUyMjY=", "number": 309, "title": "Target non-master server for restore operations", "user": {"login": "jamessewell", "id": 1216931, "node_id": "MDQ6VXNlcjEyMTY5MzE=", "avatar_url": "https://avatars.githubusercontent.com/u/1216931?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jamessewell", "html_url": "https://github.com/jamessewell", "followers_url": "https://api.github.com/users/jamessewell/followers", "following_url": "https://api.github.com/users/jamessewell/following{/other_user}", "gists_url": "https://api.github.com/users/jamessewell/gists{/gist_id}", "starred_url": "https://api.github.com/users/jamessewell/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jamessewell/subscriptions", "organizations_url": "https://api.github.com/users/jamessewell/orgs", "repos_url": "https://api.github.com/users/jamessewell/repos", "events_url": "https://api.github.com/users/jamessewell/events{/privacy}", "received_events_url": "https://api.github.com/users/jamessewell/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 233785759, "node_id": "MDU6TGFiZWwyMzM3ODU3NTk=", "url": "https://api.github.com/repos/zalando/patroni/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}], "state": "closed", "locked": false, "assignee": {"login": "CyberDem0n", "id": 3407345, "node_id": "MDQ6VXNlcjM0MDczNDU=", "avatar_url": "https://avatars.githubusercontent.com/u/3407345?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CyberDem0n", "html_url": "https://github.com/CyberDem0n", "followers_url": "https://api.github.com/users/CyberDem0n/followers", "following_url": "https://api.github.com/users/CyberDem0n/following{/other_user}", "gists_url": "https://api.github.com/users/CyberDem0n/gists{/gist_id}", "starred_url": "https://api.github.com/users/CyberDem0n/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CyberDem0n/subscriptions", "organizations_url": "https://api.github.com/users/CyberDem0n/orgs", "repos_url": "https://api.github.com/users/CyberDem0n/repos", "events_url": "https://api.github.com/users/CyberDem0n/events{/privacy}", "received_events_url": "https://api.github.com/users/CyberDem0n/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "CyberDem0n", "id": 3407345, "node_id": "MDQ6VXNlcjM0MDczNDU=", "avatar_url": "https://avatars.githubusercontent.com/u/3407345?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CyberDem0n", "html_url": "https://github.com/CyberDem0n", "followers_url": "https://api.github.com/users/CyberDem0n/followers", "following_url": "https://api.github.com/users/CyberDem0n/following{/other_user}", "gists_url": "https://api.github.com/users/CyberDem0n/gists{/gist_id}", "starred_url": "https://api.github.com/users/CyberDem0n/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CyberDem0n/subscriptions", "organizations_url": "https://api.github.com/users/CyberDem0n/orgs", "repos_url": "https://api.github.com/users/CyberDem0n/repos", "events_url": "https://api.github.com/users/CyberDem0n/events{/privacy}", "received_events_url": "https://api.github.com/users/CyberDem0n/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 7, "created_at": "2016-09-19T23:32:06Z", "updated_at": "2016-09-21T07:42:52Z", "closed_at": "2016-09-21T07:42:48Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "Hello,\n\nIs it possible to target an up to date standby server for pg_basebackup or pg_rewind operations?\n\nThis would become useful in a situation where something like WAL-E wasn't available to retrieve a base-backup and you were in production and didn't want to impact the master unless absolutely needed.\n\nCheers,\nJames\n", "reactions": {"url": "https://api.github.com/repos/zalando/patroni/issues/309/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/zalando/patroni/issues/309/timeline", "performed_via_github_app": null, "state_reason": "completed"}, {"url": "https://api.github.com/repos/zalando/patroni/issues/308", "repository_url": "https://api.github.com/repos/zalando/patroni", "labels_url": "https://api.github.com/repos/zalando/patroni/issues/308/labels{/name}", "comments_url": "https://api.github.com/repos/zalando/patroni/issues/308/comments", "events_url": "https://api.github.com/repos/zalando/patroni/issues/308/events", "html_url": "https://github.com/zalando/patroni/issues/308", "id": 177924462, "node_id": "MDU6SXNzdWUxNzc5MjQ0NjI=", "number": 308, "title": "Isolated cluster doesn't demote master", "user": {"login": "jamessewell", "id": 1216931, "node_id": "MDQ6VXNlcjEyMTY5MzE=", "avatar_url": "https://avatars.githubusercontent.com/u/1216931?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jamessewell", "html_url": "https://github.com/jamessewell", "followers_url": "https://api.github.com/users/jamessewell/followers", "following_url": "https://api.github.com/users/jamessewell/following{/other_user}", "gists_url": "https://api.github.com/users/jamessewell/gists{/gist_id}", "starred_url": "https://api.github.com/users/jamessewell/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jamessewell/subscriptions", "organizations_url": "https://api.github.com/users/jamessewell/orgs", "repos_url": "https://api.github.com/users/jamessewell/repos", "events_url": "https://api.github.com/users/jamessewell/events{/privacy}", "received_events_url": "https://api.github.com/users/jamessewell/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 233785759, "node_id": "MDU6TGFiZWwyMzM3ODU3NTk=", "url": "https://api.github.com/repos/zalando/patroni/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 5, "created_at": "2016-09-19T23:26:47Z", "updated_at": "2016-09-20T13:45:21Z", "closed_at": "2016-09-20T13:45:21Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "Hello,\n\nI have a three node Patroni cluster which works fine. I've installed Patroni from pip, and I'm using PostgreSQL 9.5 from PGDG. I'm on Centos 7.2.\n\nI'm simulating a total network outage with iptables, with DROP all INPUT and OUTPUT (keeping connections from my management machine, on lo0, and from each machine to itself). I can still run psql and connect locally to the local network IP.\n\nPatroni seems to get the right idea, and I can see each node gets upset and keeps cycling through the other servers looking for an etcd connection. \n\nOn the master I can see this (it loops):\n\n```\n2016-09-20 09:06:58,447 INFO: Reconnection allowed, looking for another server.\n2016-09-20 09:06:58,447 INFO: Selected new etcd server http://192.168.2.246:2379\n2016-09-20 09:07:00,117 WARNING: Retrying (Retry(total=0, connect=None, read=None, redirect=0)) after connection broken by 'ConnectTimeoutError(<urllib3.connection.HTTPConnection object at 0x1a20fd0>, u'Connection to 192.168.2.246 timed out. (connect timeout=1.66666666667)')': /v2/keys/service/postgresql/leader\n2016-09-20 09:07:01,787 ERROR: Request to server http://192.168.2.246:2379 failed: MaxRetryError(u\"HTTPConnectionPool(host=u'192.168.2.246', port=2379): Max retries exceeded with url: /v2/keys/service/postgresql/leader (Caused by ConnectTimeoutError(<urllib3.connection.HTTPConnection object at 0x1a20810>, u'Connection to 192.168.2.246 timed out. (connect timeout=1.66666666667)'))\",)\n2016-09-20 09:07:01,787 INFO: Reconnection allowed, looking for another server.\n2016-09-20 09:07:01,787 ERROR: Machines cache is empty, no machines to try.\n2016-09-20 09:07:01,787 ERROR: failed to update leader lock\n2016-09-20 09:07:01,793 INFO: demoting self because i do not have the lock and i was a leader\n2016-09-20 09:07:01,795 WARNING: Loop time exceeded, rescheduling immediately.\n```\n\nBut PostgreSQL is never dropped from being a master (maybe this message is talking about the cluster state not the intention to demote PostgreSQL?)\n\n```\n-bash-4.2$ pg_controldata  | grep state\nDatabase cluster state:               in production\n\n```\n\n```\n[root@localhost ansible]# curl http://192.168.2.245:8008/\n{\"database_system_identifier\": \"6332181145039238210\", \"postmaster_start_time\": \"2016-09-20 08:56:54.475 AEST\", \"xlog\": {\"location\": 67109408}, \"patroni\": {\"scope\": \"postgresql\", \"version\": \"1.1\"}, \"state\": \"running\", \"role\": \"master\", \"server_version\": 90504}\n```\n\nI would hope that this would happen to reduce the impact of writes being sent to the isolated master, then the other two nodes re-joining the network before the master did. \n\nIn this case currently the master could be accepting writes for a long period, then when it re-joins the cluster these would be removed as it rewinds and syncs to the new master.\n\nIs this intended?\n\nCheers,\nJames\n", "reactions": {"url": "https://api.github.com/repos/zalando/patroni/issues/308/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/zalando/patroni/issues/308/timeline", "performed_via_github_app": null, "state_reason": "completed"}, {"url": "https://api.github.com/repos/zalando/patroni/issues/301", "repository_url": "https://api.github.com/repos/zalando/patroni", "labels_url": "https://api.github.com/repos/zalando/patroni/issues/301/labels{/name}", "comments_url": "https://api.github.com/repos/zalando/patroni/issues/301/comments", "events_url": "https://api.github.com/repos/zalando/patroni/issues/301/events", "html_url": "https://github.com/zalando/patroni/issues/301", "id": 176919668, "node_id": "MDU6SXNzdWUxNzY5MTk2Njg=", "number": 301, "title": "Running patronictl list on a leader on a Consul cluster removes the leader's lock", "user": {"login": "zenitraM", "id": 863975, "node_id": "MDQ6VXNlcjg2Mzk3NQ==", "avatar_url": "https://avatars.githubusercontent.com/u/863975?v=4", "gravatar_id": "", "url": "https://api.github.com/users/zenitraM", "html_url": "https://github.com/zenitraM", "followers_url": "https://api.github.com/users/zenitraM/followers", "following_url": "https://api.github.com/users/zenitraM/following{/other_user}", "gists_url": "https://api.github.com/users/zenitraM/gists{/gist_id}", "starred_url": "https://api.github.com/users/zenitraM/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/zenitraM/subscriptions", "organizations_url": "https://api.github.com/users/zenitraM/orgs", "repos_url": "https://api.github.com/users/zenitraM/repos", "events_url": "https://api.github.com/users/zenitraM/events{/privacy}", "received_events_url": "https://api.github.com/users/zenitraM/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 233785759, "node_id": "MDU6TGFiZWwyMzM3ODU3NTk=", "url": "https://api.github.com/repos/zalando/patroni/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}], "state": "closed", "locked": false, "assignee": {"login": "CyberDem0n", "id": 3407345, "node_id": "MDQ6VXNlcjM0MDczNDU=", "avatar_url": "https://avatars.githubusercontent.com/u/3407345?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CyberDem0n", "html_url": "https://github.com/CyberDem0n", "followers_url": "https://api.github.com/users/CyberDem0n/followers", "following_url": "https://api.github.com/users/CyberDem0n/following{/other_user}", "gists_url": "https://api.github.com/users/CyberDem0n/gists{/gist_id}", "starred_url": "https://api.github.com/users/CyberDem0n/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CyberDem0n/subscriptions", "organizations_url": "https://api.github.com/users/CyberDem0n/orgs", "repos_url": "https://api.github.com/users/CyberDem0n/repos", "events_url": "https://api.github.com/users/CyberDem0n/events{/privacy}", "received_events_url": "https://api.github.com/users/CyberDem0n/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "CyberDem0n", "id": 3407345, "node_id": "MDQ6VXNlcjM0MDczNDU=", "avatar_url": "https://avatars.githubusercontent.com/u/3407345?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CyberDem0n", "html_url": "https://github.com/CyberDem0n", "followers_url": "https://api.github.com/users/CyberDem0n/followers", "following_url": "https://api.github.com/users/CyberDem0n/following{/other_user}", "gists_url": "https://api.github.com/users/CyberDem0n/gists{/gist_id}", "starred_url": "https://api.github.com/users/CyberDem0n/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CyberDem0n/subscriptions", "organizations_url": "https://api.github.com/users/CyberDem0n/orgs", "repos_url": "https://api.github.com/users/CyberDem0n/repos", "events_url": "https://api.github.com/users/CyberDem0n/events{/privacy}", "received_events_url": "https://api.github.com/users/CyberDem0n/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 1, "created_at": "2016-09-14T14:17:48Z", "updated_at": "2016-09-19T11:33:28Z", "closed_at": "2016-09-19T11:33:24Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "We are using Consul as DCS and noticed that running `patronictl list -c ...yml clustername` on a cluster leader using its .yml will demote the leader dirtily, giving no warning and causing a failover.\n\nThe cause seems to be this:\nhttps://github.com/zalando/patroni/blob/master/patroni/dcs/consul.py#L157\n\nPatronictl will create a new session with the name specified on the .yml (the leader one), look for existing leader sessions, find one with matching name but different session ID (the one from the actual Patroni daemon) and decide to remove the lock.\n\nIt seems this behavior might make sense if it runs on the daemon itself, but definitely not on patronictl\n", "reactions": {"url": "https://api.github.com/repos/zalando/patroni/issues/301/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/zalando/patroni/issues/301/timeline", "performed_via_github_app": null, "state_reason": "completed"}, {"url": "https://api.github.com/repos/zalando/patroni/issues/178", "repository_url": "https://api.github.com/repos/zalando/patroni", "labels_url": "https://api.github.com/repos/zalando/patroni/issues/178/labels{/name}", "comments_url": "https://api.github.com/repos/zalando/patroni/issues/178/comments", "events_url": "https://api.github.com/repos/zalando/patroni/issues/178/events", "html_url": "https://github.com/zalando/patroni/issues/178", "id": 149721356, "node_id": "MDU6SXNzdWUxNDk3MjEzNTY=", "number": 178, "title": "failover fails if master is down and slave is not 'healthiest'", "user": {"login": "jankeirse", "id": 11499882, "node_id": "MDQ6VXNlcjExNDk5ODgy", "avatar_url": "https://avatars.githubusercontent.com/u/11499882?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jankeirse", "html_url": "https://github.com/jankeirse", "followers_url": "https://api.github.com/users/jankeirse/followers", "following_url": "https://api.github.com/users/jankeirse/following{/other_user}", "gists_url": "https://api.github.com/users/jankeirse/gists{/gist_id}", "starred_url": "https://api.github.com/users/jankeirse/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jankeirse/subscriptions", "organizations_url": "https://api.github.com/users/jankeirse/orgs", "repos_url": "https://api.github.com/users/jankeirse/repos", "events_url": "https://api.github.com/users/jankeirse/events{/privacy}", "received_events_url": "https://api.github.com/users/jankeirse/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 233785759, "node_id": "MDU6TGFiZWwyMzM3ODU3NTk=", "url": "https://api.github.com/repos/zalando/patroni/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}], "state": "closed", "locked": false, "assignee": {"login": "CyberDem0n", "id": 3407345, "node_id": "MDQ6VXNlcjM0MDczNDU=", "avatar_url": "https://avatars.githubusercontent.com/u/3407345?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CyberDem0n", "html_url": "https://github.com/CyberDem0n", "followers_url": "https://api.github.com/users/CyberDem0n/followers", "following_url": "https://api.github.com/users/CyberDem0n/following{/other_user}", "gists_url": "https://api.github.com/users/CyberDem0n/gists{/gist_id}", "starred_url": "https://api.github.com/users/CyberDem0n/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CyberDem0n/subscriptions", "organizations_url": "https://api.github.com/users/CyberDem0n/orgs", "repos_url": "https://api.github.com/users/CyberDem0n/repos", "events_url": "https://api.github.com/users/CyberDem0n/events{/privacy}", "received_events_url": "https://api.github.com/users/CyberDem0n/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "CyberDem0n", "id": 3407345, "node_id": "MDQ6VXNlcjM0MDczNDU=", "avatar_url": "https://avatars.githubusercontent.com/u/3407345?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CyberDem0n", "html_url": "https://github.com/CyberDem0n", "followers_url": "https://api.github.com/users/CyberDem0n/followers", "following_url": "https://api.github.com/users/CyberDem0n/following{/other_user}", "gists_url": "https://api.github.com/users/CyberDem0n/gists{/gist_id}", "starred_url": "https://api.github.com/users/CyberDem0n/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CyberDem0n/subscriptions", "organizations_url": "https://api.github.com/users/CyberDem0n/orgs", "repos_url": "https://api.github.com/users/CyberDem0n/repos", "events_url": "https://api.github.com/users/CyberDem0n/events{/privacy}", "received_events_url": "https://api.github.com/users/CyberDem0n/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 6, "created_at": "2016-04-20T10:00:09Z", "updated_at": "2016-04-22T15:02:46Z", "closed_at": "2016-04-22T15:02:46Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "I've had a sittuation where I deliberately shut down the only slave and then the master. I then 'lost' the master and restarted the slave, but it refused to become master because it was:\n'Following a different leader because i am not the healthiest node'. \nExcept that there was no other node (the former master was lost, no other slave exists.) I am not entirely sure why it considered itself unhealthy, but manually promoting with pg_ctl promote worked and got the cluster back up and running. \nI'm afraid I don't have enough details to reproduce the scenario. If I try to replicate what I did again it just works fine. \n", "reactions": {"url": "https://api.github.com/repos/zalando/patroni/issues/178/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/zalando/patroni/issues/178/timeline", "performed_via_github_app": null, "state_reason": "completed"}, {"url": "https://api.github.com/repos/zalando/patroni/issues/133", "repository_url": "https://api.github.com/repos/zalando/patroni", "labels_url": "https://api.github.com/repos/zalando/patroni/issues/133/labels{/name}", "comments_url": "https://api.github.com/repos/zalando/patroni/issues/133/comments", "events_url": "https://api.github.com/repos/zalando/patroni/issues/133/events", "html_url": "https://github.com/zalando/patroni/issues/133", "id": 132695330, "node_id": "MDU6SXNzdWUxMzI2OTUzMzA=", "number": 133, "title": "Unit test failes when patroni is running locally", "user": {"login": "CyberDem0n", "id": 3407345, "node_id": "MDQ6VXNlcjM0MDczNDU=", "avatar_url": "https://avatars.githubusercontent.com/u/3407345?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CyberDem0n", "html_url": "https://github.com/CyberDem0n", "followers_url": "https://api.github.com/users/CyberDem0n/followers", "following_url": "https://api.github.com/users/CyberDem0n/following{/other_user}", "gists_url": "https://api.github.com/users/CyberDem0n/gists{/gist_id}", "starred_url": "https://api.github.com/users/CyberDem0n/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CyberDem0n/subscriptions", "organizations_url": "https://api.github.com/users/CyberDem0n/orgs", "repos_url": "https://api.github.com/users/CyberDem0n/repos", "events_url": "https://api.github.com/users/CyberDem0n/events{/privacy}", "received_events_url": "https://api.github.com/users/CyberDem0n/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 233785759, "node_id": "MDU6TGFiZWwyMzM3ODU3NTk=", "url": "https://api.github.com/repos/zalando/patroni/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}], "state": "closed", "locked": false, "assignee": {"login": "feikesteenbergen", "id": 8860819, "node_id": "MDQ6VXNlcjg4NjA4MTk=", "avatar_url": "https://avatars.githubusercontent.com/u/8860819?v=4", "gravatar_id": "", "url": "https://api.github.com/users/feikesteenbergen", "html_url": "https://github.com/feikesteenbergen", "followers_url": "https://api.github.com/users/feikesteenbergen/followers", "following_url": "https://api.github.com/users/feikesteenbergen/following{/other_user}", "gists_url": "https://api.github.com/users/feikesteenbergen/gists{/gist_id}", "starred_url": "https://api.github.com/users/feikesteenbergen/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/feikesteenbergen/subscriptions", "organizations_url": "https://api.github.com/users/feikesteenbergen/orgs", "repos_url": "https://api.github.com/users/feikesteenbergen/repos", "events_url": "https://api.github.com/users/feikesteenbergen/events{/privacy}", "received_events_url": "https://api.github.com/users/feikesteenbergen/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "feikesteenbergen", "id": 8860819, "node_id": "MDQ6VXNlcjg4NjA4MTk=", "avatar_url": "https://avatars.githubusercontent.com/u/8860819?v=4", "gravatar_id": "", "url": "https://api.github.com/users/feikesteenbergen", "html_url": "https://github.com/feikesteenbergen", "followers_url": "https://api.github.com/users/feikesteenbergen/followers", "following_url": "https://api.github.com/users/feikesteenbergen/following{/other_user}", "gists_url": "https://api.github.com/users/feikesteenbergen/gists{/gist_id}", "starred_url": "https://api.github.com/users/feikesteenbergen/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/feikesteenbergen/subscriptions", "organizations_url": "https://api.github.com/users/feikesteenbergen/orgs", "repos_url": "https://api.github.com/users/feikesteenbergen/repos", "events_url": "https://api.github.com/users/feikesteenbergen/events{/privacy}", "received_events_url": "https://api.github.com/users/feikesteenbergen/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 0, "created_at": "2016-02-10T13:08:19Z", "updated_at": "2016-02-10T15:41:12Z", "closed_at": "2016-02-10T15:41:12Z", "author_association": "COLLABORATOR", "active_lock_reason": null, "body": "``` python\n__________________________________________________________________________________________________________________________ TestCtl.test_post_patroni __________________________________________________________________________________________________________________________\n\nself = <test_ctl.TestCtl testMethod=test_post_patroni>\n\n    def test_post_patroni(self):\n        member = get_cluster_initialized_with_leader().leader.member\n>       self.assertRaises(requests.exceptions.ConnectionError, post_patroni, member, 'dummy', {})\nE       AssertionError: ConnectionError not raised by post_patroni\n\ntests/test_ctl.py:330: AssertionError\n```\n", "reactions": {"url": "https://api.github.com/repos/zalando/patroni/issues/133/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/zalando/patroni/issues/133/timeline", "performed_via_github_app": null, "state_reason": "completed"}, {"url": "https://api.github.com/repos/zalando/patroni/issues/115", "repository_url": "https://api.github.com/repos/zalando/patroni", "labels_url": "https://api.github.com/repos/zalando/patroni/issues/115/labels{/name}", "comments_url": "https://api.github.com/repos/zalando/patroni/issues/115/comments", "events_url": "https://api.github.com/repos/zalando/patroni/issues/115/events", "html_url": "https://github.com/zalando/patroni/issues/115", "id": 125522578, "node_id": "MDU6SXNzdWUxMjU1MjI1Nzg=", "number": 115, "title": "Automatically prefix localhost connections", "user": {"login": "jberkus", "id": 115146, "node_id": "MDQ6VXNlcjExNTE0Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/115146?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jberkus", "html_url": "https://github.com/jberkus", "followers_url": "https://api.github.com/users/jberkus/followers", "following_url": "https://api.github.com/users/jberkus/following{/other_user}", "gists_url": "https://api.github.com/users/jberkus/gists{/gist_id}", "starred_url": "https://api.github.com/users/jberkus/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jberkus/subscriptions", "organizations_url": "https://api.github.com/users/jberkus/orgs", "repos_url": "https://api.github.com/users/jberkus/repos", "events_url": "https://api.github.com/users/jberkus/events{/privacy}", "received_events_url": "https://api.github.com/users/jberkus/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 233785759, "node_id": "MDU6TGFiZWwyMzM3ODU3NTk=", "url": "https://api.github.com/repos/zalando/patroni/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}, {"id": 233785762, "node_id": "MDU6TGFiZWwyMzM3ODU3NjI=", "url": "https://api.github.com/repos/zalando/patroni/labels/help%20wanted", "name": "help wanted", "color": "159818", "default": true, "description": null}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 15, "created_at": "2016-01-08T01:27:32Z", "updated_at": "2019-05-28T22:32:15Z", "closed_at": "2019-05-28T22:32:15Z", "author_association": "COLLABORATOR", "active_lock_reason": null, "body": "So, not making much progress.  When trying to start a master node I get this:\n\nWARNING: enabling \"trust\" authentication for local connections\nYou can change this by editing pg_hba.conf or using the option -A, or\n--auth-local and --auth-host, the next time you run initdb.\n\nSuccess. You can now start the database server using:\n\n```\n/usr/lib/postgresql/9.4/bin/postgres -D /pgdata/datacd p\n```\n\nor\n    /usr/lib/postgresql/9.4/bin/pg_ctl -D /pgdata/datacd p -l logfile start\n\nwaiting for server to start....LOG:  database system was shut down at 2016-01-08 01:15:51 UTC\nLOG:  MultiXact member wraparound protections are now enabled\nLOG:  database system is ready to accept connections\nLOG:  autovacuum launcher started\n done\nserver started\n2016-01-08 01:15:52,558 INFO: established a new patroni connection to the postgres cluster\n2016-01-08 01:15:53,411 INFO: established a new patroni connection to the postgres cluster\n2016-01-08 01:15:54,164 INFO: established a new patroni connection to the postgres cluster\n2016-01-08 01:15:55,267 INFO: established a new patroni connection to the postgres cluster\n2016-01-08 01:15:56,309 INFO: established a new patroni connection to the postgres cluster\n2016-01-08 01:15:56,311 INFO: removing initialize key after failed attempt to initialize the cluster\n2016-01-08 01:15:56,320 INFO: renaming data directory to /pgdata/datacd p_2016-01-08-01-15-56\n2016-01-08 01:15:56,321 ERROR: Error communicating with Postgresql. Will try again later\nTraceback (most recent call last):\n\n... and things fail from there.  The thing is, PostgreSQL is running, as subsequent attempts to start it fail due to port 5432 already being bound.  \n", "reactions": {"url": "https://api.github.com/repos/zalando/patroni/issues/115/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/zalando/patroni/issues/115/timeline", "performed_via_github_app": null, "state_reason": "completed"}, {"url": "https://api.github.com/repos/zalando/patroni/issues/101", "repository_url": "https://api.github.com/repos/zalando/patroni", "labels_url": "https://api.github.com/repos/zalando/patroni/issues/101/labels{/name}", "comments_url": "https://api.github.com/repos/zalando/patroni/issues/101/comments", "events_url": "https://api.github.com/repos/zalando/patroni/issues/101/events", "html_url": "https://github.com/zalando/patroni/issues/101", "id": 117758903, "node_id": "MDU6SXNzdWUxMTc3NTg5MDM=", "number": 101, "title": "Shutting down PostgreSQL may wait indefinitely", "user": {"login": "feikesteenbergen", "id": 8860819, "node_id": "MDQ6VXNlcjg4NjA4MTk=", "avatar_url": "https://avatars.githubusercontent.com/u/8860819?v=4", "gravatar_id": "", "url": "https://api.github.com/users/feikesteenbergen", "html_url": "https://github.com/feikesteenbergen", "followers_url": "https://api.github.com/users/feikesteenbergen/followers", "following_url": "https://api.github.com/users/feikesteenbergen/following{/other_user}", "gists_url": "https://api.github.com/users/feikesteenbergen/gists{/gist_id}", "starred_url": "https://api.github.com/users/feikesteenbergen/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/feikesteenbergen/subscriptions", "organizations_url": "https://api.github.com/users/feikesteenbergen/orgs", "repos_url": "https://api.github.com/users/feikesteenbergen/repos", "events_url": "https://api.github.com/users/feikesteenbergen/events{/privacy}", "received_events_url": "https://api.github.com/users/feikesteenbergen/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 233785759, "node_id": "MDU6TGFiZWwyMzM3ODU3NTk=", "url": "https://api.github.com/repos/zalando/patroni/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}, {"id": 233785762, "node_id": "MDU6TGFiZWwyMzM3ODU3NjI=", "url": "https://api.github.com/repos/zalando/patroni/labels/help%20wanted", "name": "help wanted", "color": "159818", "default": true, "description": null}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 6, "created_at": "2015-11-19T07:38:59Z", "updated_at": "2017-12-22T13:44:05Z", "closed_at": "2017-12-22T13:44:04Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "It has happened that PostgreSQL does not shut down when signaled. Patroni then waits indefinitely for postgres to shut down.\n\nIt may be a ok idea to do a `shutdown -m immediate` after n minutes if postgres doesn't shutdown.\n", "reactions": {"url": "https://api.github.com/repos/zalando/patroni/issues/101/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/zalando/patroni/issues/101/timeline", "performed_via_github_app": null, "state_reason": "completed"}, {"url": "https://api.github.com/repos/zalando/patroni/issues/62", "repository_url": "https://api.github.com/repos/zalando/patroni", "labels_url": "https://api.github.com/repos/zalando/patroni/issues/62/labels{/name}", "comments_url": "https://api.github.com/repos/zalando/patroni/issues/62/comments", "events_url": "https://api.github.com/repos/zalando/patroni/issues/62/events", "html_url": "https://github.com/zalando/patroni/issues/62", "id": 111142876, "node_id": "MDU6SXNzdWUxMTExNDI4NzY=", "number": 62, "title": "Patroni keeps the leader in read-only mode after the PostgreSQL crash", "user": {"login": "alexeyklyukin", "id": 339913, "node_id": "MDQ6VXNlcjMzOTkxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/339913?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexeyklyukin", "html_url": "https://github.com/alexeyklyukin", "followers_url": "https://api.github.com/users/alexeyklyukin/followers", "following_url": "https://api.github.com/users/alexeyklyukin/following{/other_user}", "gists_url": "https://api.github.com/users/alexeyklyukin/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexeyklyukin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexeyklyukin/subscriptions", "organizations_url": "https://api.github.com/users/alexeyklyukin/orgs", "repos_url": "https://api.github.com/users/alexeyklyukin/repos", "events_url": "https://api.github.com/users/alexeyklyukin/events{/privacy}", "received_events_url": "https://api.github.com/users/alexeyklyukin/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 233785759, "node_id": "MDU6TGFiZWwyMzM3ODU3NTk=", "url": "https://api.github.com/repos/zalando/patroni/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}], "state": "closed", "locked": false, "assignee": {"login": "alexeyklyukin", "id": 339913, "node_id": "MDQ6VXNlcjMzOTkxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/339913?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexeyklyukin", "html_url": "https://github.com/alexeyklyukin", "followers_url": "https://api.github.com/users/alexeyklyukin/followers", "following_url": "https://api.github.com/users/alexeyklyukin/following{/other_user}", "gists_url": "https://api.github.com/users/alexeyklyukin/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexeyklyukin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexeyklyukin/subscriptions", "organizations_url": "https://api.github.com/users/alexeyklyukin/orgs", "repos_url": "https://api.github.com/users/alexeyklyukin/repos", "events_url": "https://api.github.com/users/alexeyklyukin/events{/privacy}", "received_events_url": "https://api.github.com/users/alexeyklyukin/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "alexeyklyukin", "id": 339913, "node_id": "MDQ6VXNlcjMzOTkxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/339913?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexeyklyukin", "html_url": "https://github.com/alexeyklyukin", "followers_url": "https://api.github.com/users/alexeyklyukin/followers", "following_url": "https://api.github.com/users/alexeyklyukin/following{/other_user}", "gists_url": "https://api.github.com/users/alexeyklyukin/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexeyklyukin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexeyklyukin/subscriptions", "organizations_url": "https://api.github.com/users/alexeyklyukin/orgs", "repos_url": "https://api.github.com/users/alexeyklyukin/repos", "events_url": "https://api.github.com/users/alexeyklyukin/events{/privacy}", "received_events_url": "https://api.github.com/users/alexeyklyukin/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 2, "created_at": "2015-10-13T09:32:24Z", "updated_at": "2015-10-19T14:26:54Z", "closed_at": "2015-10-19T14:26:54Z", "author_association": "CONTRIBUTOR", "active_lock_reason": null, "body": "Steps to reproduce\n- run patroni cluster with a master and a replica\n- kill the master with -9\n- wait until the master will recover:\n\nwaiting for server to start....LOG:  database system was interrupted; last known up at 2015-10-13 11:27:23 CEST\nWARNING:  recovery command file \"recovery.conf\" specified neither primary_conninfo nor restore_command\nHINT:  The database server will regularly poll the pg_xlog subdirectory to check for files placed there.\nLOG:  entering standby mode\nLOG:  database system was not properly shut down; automatic recovery in progress\nLOG:  redo starts at 0/40001D8\nLOG:  invalid record length at 0/40002B8\nLOG:  consistent recovery state reached at 0/40002B8\nLOG:  database system is ready to accept read only connections\n done\nserver started\n2015-10-13 11:28:24,422 INFO: started as readonly because i had the session lock\n2015-10-13 11:28:24,423 INFO: Lock owner: postgresql0; I am postgresql0\n2015-10-13 11:28:24,428 INFO: no action.  i am the leader with the lock\n- try connecting to the master and running pg_is_in_recovery(), the master will stay in the read-only mode indefinitely.\n\nI think we are not clearing the role flag after the crash, will look into today....\n", "reactions": {"url": "https://api.github.com/repos/zalando/patroni/issues/62/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/zalando/patroni/issues/62/timeline", "performed_via_github_app": null, "state_reason": "completed"}, {"url": "https://api.github.com/repos/zalando/patroni/issues/17", "repository_url": "https://api.github.com/repos/zalando/patroni", "labels_url": "https://api.github.com/repos/zalando/patroni/issues/17/labels{/name}", "comments_url": "https://api.github.com/repos/zalando/patroni/issues/17/comments", "events_url": "https://api.github.com/repos/zalando/patroni/issues/17/events", "html_url": "https://github.com/zalando/patroni/issues/17", "id": 104384272, "node_id": "MDU6SXNzdWUxMDQzODQyNzI=", "number": 17, "title": "Initialization key should have a TTL", "user": {"login": "jberkus", "id": 115146, "node_id": "MDQ6VXNlcjExNTE0Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/115146?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jberkus", "html_url": "https://github.com/jberkus", "followers_url": "https://api.github.com/users/jberkus/followers", "following_url": "https://api.github.com/users/jberkus/following{/other_user}", "gists_url": "https://api.github.com/users/jberkus/gists{/gist_id}", "starred_url": "https://api.github.com/users/jberkus/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jberkus/subscriptions", "organizations_url": "https://api.github.com/users/jberkus/orgs", "repos_url": "https://api.github.com/users/jberkus/repos", "events_url": "https://api.github.com/users/jberkus/events{/privacy}", "received_events_url": "https://api.github.com/users/jberkus/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 233785759, "node_id": "MDU6TGFiZWwyMzM3ODU3NTk=", "url": "https://api.github.com/repos/zalando/patroni/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 6, "created_at": "2015-09-02T01:08:36Z", "updated_at": "2015-10-28T00:42:54Z", "closed_at": "2015-10-28T00:42:54Z", "author_association": "COLLABORATOR", "active_lock_reason": null, "body": "1. create a patroni node\n2. have the wrong permissions for the /pgdata dir.\n3. patroni will create a key, start initialization, and error out\n4. the initialization key will remain\n5. try to restart the node with the permissions fixed, or start a new node with the same name\n6. get: 2015-09-02 01:07:40,863 ERROR: Unexpected response: 412 {\"errorCode\":105,\"message\":\"Key already exists\",\"cause\":\"/service/pgcluster1/initialize\",\"index\":11}\n7. Node does not initialize\n", "reactions": {"url": "https://api.github.com/repos/zalando/patroni/issues/17/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/zalando/patroni/issues/17/timeline", "performed_via_github_app": null, "state_reason": "completed"}]